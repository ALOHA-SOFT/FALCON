<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/layout"
      layout:decorate="~{UI/layouts/user/main_layout}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order/Payment</title>
</head>
<body layout:fragment="content">
  <div class="container my-5">
    <h2 class="mb-4">Order/Payment</h2>

    <div class="row">
      <div class="col-12 col-md-6">
        <!-- 주문자 정보 -->
        <div class="card mb-4">
          <div class="card-header">Customer Details</div>
          <div class="card-body row g-3">
            <div class="col-12">
              <label for="buyerEmail" class="form-label">Email</label>
              <input type="email" class="form-control" id="buyerEmail" name="buyerEmail" th:value="${user.email}" required>
            </div>
            <div class="col-6">
              <label for="buyerFirstName" class="form-label">First Name</label>
              <input type="text" class="form-control" id="buyerFirstName" name="buyerFirstName" th:value="${user.firstName}" required>
            </div>
            <div class="col-6">
              <label for="buyerLastName" class="form-label">Last Name</label>
              <input type="text" class="form-control" id="buyerLastName" name="buyerLastName" th:value="${user.lastName}" required>
            </div>
            <div class="col-12">
              <label for="buyerPhone" class="form-label">Phone</label>
              <input type="tel" class="form-control" id="buyerPhone" name="buyerPhone" th:value="${user.tel}" required>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-12 col-md-6">
        <!-- 배송지 정보 -->
        <div class="card mb-4">
          <div class="card-header">
            <div class="col-12 d-flex justify-content-between align-items-center">
              <span>Delivery Details</span>
              <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addAddressModal">+ Add New Address</button>
            </div>
          </div>
          <div class="card-body" style="height: 338px; overflow-y: auto;">
            <div class="mb-3">
              <div class="row g-2" th:if="${addressList != null}">
                <div class="col-12" th:each="addr : ${addressList}">
                  <div class="card mb-2" th:classappend="${addr.isMain} ? 'border-primary' : ''">
                    <div class="card-body d-flex align-items-center ">
                      <input class="form-check-input me-3" type="radio" name="addressNo" th:id="'address_' + ${addr.no}" th:value="${addr.no}" th:checked="${addr.isMain}">
                      <label th:for="'address_' + ${addr.no}" class="w-100 mb-0 cursor-pointer address-label">
                        <div class="d-flex justify-content-between align-items-center">
                          <div>
                            <strong th:text="${addr.recipient}">Recipient</strong>
                            <span class="ms-2" th:text="${addr.tel}">Phone</span>
                          </div>
                          <div>
                            <span class="ms-2 badge bg-primary" th:if="${addr.isMain}">Default Address</span>
                          </div>
                        </div>
                        <!-- <div th:text="${addr.postcode} + ' ' + ${addr.address} + ' ' + ${addr.addressDong} + ' ' + ${addr.addressDetail}">주소</div> -->
                        <div class="fs-6">
                          <span class="badge bg-secondary" th:text="${addr.postcode}">Postal Code</span>
                          <span th:text="${addr.address} + ' ' + ${addr.addressDetail}" class="span-address" th:classappend="${addr.isMain} ? 'main' : ''">Address</span> <br>
                          <span th:text="${addr.addressDong} + ' ' + ${addr.addressDetail}">Address</span>
                          <div class="text-muted small" th:if="${addr.deliveryRequest}" th:text="'Delivery Note: ' + ${addr.deliveryRequest}">Delivery Note</div>
                        </div>
                      </label>
                    </div>
                  </div>
                </div>
              </div>
                <div th:if="${addressList == null or #lists.isEmpty(addressList)}" class="text-muted text-center py-4">
                  <i class="material-icons" style="font-size: 36px; color: #ccc;">local_shipping</i>
                  <p class="mt-2 mb-2">No delivery address registered.</p>
                  <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addAddressModal">+ Add New Address</button>
                </div>
                <!-- 배송지 추가/수정 모달 -->
                <div class="modal fade" id="addAddressModal" tabindex="-1" aria-labelledby="addAddressModalLabel" aria-hidden="true">
                  <div class="modal-dialog">
                    <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="addAddressModalLabel">Add Address</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <form id="order-address-form">
                      <input type="hidden" name="userNo" th:value="${user.no}">
                      <div class="mb-2">
                        <label class="form-label">Recipient</label>
                        <input type="text" class="form-control" name="recipient" id="orderRecipient" required>
                      </div>
                      <div class="mb-2">
                        <label class="form-label">Phone</label>
                        <input type="tel" class="form-control" name="tel" id="orderTel" required>
                      </div>
                      <div class="mb-2">
                        <label class="form-label">Country/Region</label>
                        <select class="form-select" name="country" id="orderCountry">
                          <option value="">Please select country/region</option>
                          <option value="KR">South Korea</option>
                          <option value="US">United States</option>
                          <option value="JP">Japan</option>
                          <option value="CN">China</option>
                          <option value="GB">United Kingdom</option>
                          <option value="DE">Germany</option>
                          <option value="FR">France</option>
                          <option value="CA">Canada</option>
                          <option value="AU">Australia</option>
                        </select>
                      </div>
                      <div class="mb-2">
                        <label class="form-label">Address</label>
                        <div class="input-group">
                        <input type="text" id="orderPostcode" class="form-control" name="postcode" placeholder="Postal Code" readonly>
                        <button type="button" class="btn btn-outline-secondary" onclick="execOrderDaumPostcode()">Find Address</button>
                        </div>
                        <input type="text" class="form-control mt-2" name="address" id="orderAddress" placeholder="Street Address" readonly required>
                        <input type="text" class="form-control mt-2" name="addressDong" id="orderAddressDong" placeholder="District Address" readonly>
                      </div>
                      <div class="mb-2">
                        <label class="form-label">City</label>
                        <input type="text" class="form-control" name="city" id="orderCity" placeholder="City Name">
                      </div>
                      <div class="mb-2">
                        <label class="form-label">Zip/Postal code</label>
                        <input type="text" class="form-control" name="postcode" id="orderPostcodeField" placeholder="Postal Code">
                      </div>
                      <div class="mb-2">
                        <label class="form-label">Detailed Address</label>
                        <input type="text" class="form-control" name="addressDetail" id="orderAddressDetail" placeholder="Detailed Address (Apartment, Unit No., etc.)" required>
                      </div>
                      <div class="mb-2">
                        <label class="form-label">Delivery Note</label>
                        <select id="orderDeliveryRequestSelect" class="form-select mt-2">
                        <option value="">Please select delivery instructions</option>
                        <option value="Please leave at the door if not available">Please leave at the door if not available</option>
                        <option value="Please leave with security office">Please leave with security office</option>
                        <option value="Please put in the mailbox">Please put in the mailbox</option>
                        <option value="Please do not ring the bell">Please do not ring the bell</option>
                        <option value="Please contact before delivery">Please contact before delivery</option>
                        <option value="custom">Custom Input</option>
                        </select>
                        <input type="text" class="form-control d-none" name="deliveryRequest" id="orderDeliveryRequest" placeholder="Delivery Instructions (Optional)" readonly>
                      </div>
                      <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="orderIsMain" name="isMain">
                        <label class="form-check-label" for="orderIsMain">Set as default address</label>
                      </div>
                      <button type="submit" class="btn btn-primary w-100">Save</button>
                      </form>
                    </div>
                    </div>
                  </div>
                </div>
                <!-- Daum Postcode CDN -->
                <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
                <script>
                  function execOrderDaumPostcode() {
                    new daum.Postcode({
                    oncomplete: function(data) {
                      document.getElementById('orderPostcode').value = data.zonecode;
                      document.getElementById('orderAddress').value = data.roadAddress;
                      document.getElementById('orderAddressDong').value = data.jibunAddress;
                    }
                    }).open();
                  }
                  document.getElementById('orderDeliveryRequestSelect').addEventListener('change', function() {
                    const selectedValue = this.value;
                    const deliveryRequestInput = document.getElementById('orderDeliveryRequest');
                    if (selectedValue === 'custom') {
                    deliveryRequestInput.removeAttribute('readonly');
                    deliveryRequestInput.classList.remove('d-none');
                    deliveryRequestInput.value = '';
                    deliveryRequestInput.focus();
                    } else if (selectedValue === '') {
                    deliveryRequestInput.value = '';
                    deliveryRequestInput.classList.add('d-none');
                    } else {
                    deliveryRequestInput.value = selectedValue;
                    deliveryRequestInput.classList.add('d-none');
                    }
                  });
                  document.getElementById('order-address-form').addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const formData = new FormData(this);
                    const addressData = {
                    userNo: formData.get('userNo') || '',
                    recipient: formData.get('recipient') || '',
                    tel: formData.get('tel') || '',
                    country: formData.get('country') || '',
                    postcode: formData.get('postcode') || '',
                    address: formData.get('address') || '',
                    addressDong: formData.get('addressDong') || '',
                    addressDetail: formData.get('addressDetail') || '',
                    city: formData.get('city') || '',
                    deliveryRequest: formData.get('deliveryRequest') || '',
                    isMain: formData.get('isMain') === 'on',
                    };
                    try {
                    await $ajax({
                      url: '/api/users/address',
                      type: 'POST',
                      data: addressData
                    });
                    await $toast({
                      title: 'Address has been registered.',
                      icon: 'success'
                    });
                    // 모달 닫기
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addAddressModal'));
                    modal.hide();
                    location.reload();
                    } catch (error) {
                    $alert('Error', 'Failed to register address.', 'error');
                    }
                  });

                  document.querySelectorAll('.address-label').forEach(function(label) {
                    label.addEventListener('click', function() {
                      const spanAddr = label.querySelector('.span-address');
                      if (spanAddr) {
                        document.getElementById('buyerAddress').value = spanAddr.innerText;
                      }
                    });
                  });

                  const mainAddr = document.querySelector('.span-address.main');
                  if (mainAddr) {
                    document.getElementById('buyerAddress').value = mainAddr.innerText;
                  }
                </script>
              </div>
            </div>
          </div>
        </div>
      </div>
    <!-- 주문 상품/옵션 상세 -->
    <div class="card mb-4">
      <div class="card-header">Order Product Details</div>
      <div class="card-body">
        <div class="row g-3" th:each="item : ${order.orderItems}">
          <div class="col-12">
            <div class="card mb-3">
              <div class="card-body">
                <div class="row mb-2 align-items-center">
                  <div class="col-md-6">
                    <div class="row mb-2">
                      <div class="col-6">
                        <img th:src="${item.product.thumbImg != null and item.product.thumbImg.content != null ? item.product.thumbImg.content : 'https://placehold.co/120x120?text=Image'}" alt="Product Image" class="img-fluid rounded" style="max-height:120px;">
                      </div>
                      <div class="col-6 d-flex flex-column justify-content-between">
                        <div>
                          <strong>Product Name:</strong> <span th:text="${item.product.name}">Product Name</span>
                        </div>
                        <div>
                          <strong>Product No:</strong> <span th:text="${item.productNo}">Product No</span>
                        </div>
                        <div>
                          <strong>Quantity:</strong> <span th:text="${item.quantity}">1</span>
                        </div>
                        <div>
                          <strong>Price:</strong> <span th:text="${'£' + #numbers.formatInteger(item.price, 0, 'COMMA')}" class="item-price" data-item-id="${item.productNo}">£0</span>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div th:if="${item.orderItemOptions != null}">
                      <div class="row g-2" th:each="opt : ${item.orderItemOptions}">
                        <div class="col-12">
                          <div class="border rounded p-2 d-flex align-items-center justify-content-between flex-column flex-md-row gap-2">
                            <div>
                              <span class="me-2"><span th:text="${opt.option.name}" class="fw-bold p-2 fs-5">Option Name</span></span>
                              <span class="me-2">Price: <span th:text="${'£' + #numbers.formatInteger(opt.price, 0, 'COMMA')}">£0</span></span>
                              <span class="me-2">Quantity: <span class="opt-qty-view" th:text="${opt.quantity}" th:data-id="${opt.id}">1</span></span>
                              <span class="fw-bold text-primary">
                                <span class="opt-total-view" th:text="${'£' + #numbers.formatInteger(opt.price * opt.quantity, 0, 'COMMA')}" th:data-id="${opt.id}">£0</span>
                              </span>
                            </div>
                            <div class="d-flex align-items-center">
                              <button type="button" class="btn btn-outline-secondary btn-sm me-1 opt-qty-btn" data-action="decrease" th:data-id="${opt.id}">-</button>
                              <input type="text" class="form-control form-control-sm text-center opt-qty-input" style="width:50px;" th:value="${opt.quantity}" th:data-id="${opt.id}" />
                              <button type="button" class="btn btn-outline-secondary btn-sm ms-1 opt-qty-btn" data-action="increase" th:data-id="${opt.id}">+</button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    
    <!-- 주문 정보 요약 -->
    <div class="card mb-4">
      <div class="card-header">Order Information</div>
      <div class="card-body fs-4">
        <div class="row mb-2">
          <div class="col-md-4"><strong>Order Number</strong></div>
          <div class="col-md-8 text-end" th:text="${order.code}">ORDER_CODE</div>
        </div>
        <div class="row mb-2">
          <div class="col-md-4"><strong>Customer</strong></div>
          <div class="col-md-8 text-end" th:text="${order.userNo}">Customer Number</div>
        </div>
        <div class="row mb-2">
          <div class="col-md-4"><strong>Shipping Fee</strong></div>
          <div id="shipping-price" class="col-md-8 text-end" th:text="${'£' + #numbers.formatInteger(order.shipPrice, 0, 'COMMA')}">£0</div>
        </div>
        <div class="row mb-2">
          <div class="col-md-4"><strong>Status</strong></div>
          <div class="col-md-8 text-end" th:text="${order.status}">Pending Payment</div>
        </div>
        <div class="row mb-2 text-danger">
          <div class="col-md-4"><strong>Total Amount</strong></div>
          <div id="total-price" th:data="${order.totalPrice}" class="col-md-8 text-end" th:text="${'£' + #numbers.formatInteger(order.totalPrice + order.shipPrice, 0, 'COMMA')}">£0</div>
        </div>
      </div>
    </div>
    <!-- 결제 영역 -->
    <div class="card mb-4">
      <div class="card-header">Payment Method Selection</div>
      <div class="card-body">
        <!-- 결제 방식 선택 카드 버튼 -->
        <div class="row g-3 mb-4">
          <div class="col-md-6">
            <div class="payment-card" id="cash-card" data-payment="cash">
              <div class="payment-card-body">
                <div class="payment-icon">
                  <i class="material-icons">credit_card</i>
                </div>
                <div class="payment-info">
                  <h5 class="payment-title">Cash Payment</h5>
                  <p class="payment-desc">Payment information sent via email</p>
                </div>
                <div class="payment-check">
                  <i class="material-icons">check_circle</i>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="payment-card" id="coin-card" data-payment="coin">
              <div class="payment-card-body">
                <div class="payment-icon">
                  <i class="material-icons">account_balance_wallet</i>
                </div>
                <div class="payment-info">
                  <h5 class="payment-title">Coin Payment</h5>
                  <p class="payment-desc">Instant payment with your coins</p>
                </div>
                <div class="payment-check">
                  <i class="material-icons">check_circle</i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 결제 방식별 상세 정보 -->
        <div id="payment-details">
          <!-- 현금 결제 정보 -->
          <div id="cash-details" class="payment-details active">
            <div class="alert alert-info d-flex align-items-center">
              <i class="material-icons me-2">email</i>
              <div>
                <strong>Cash Payment Guide</strong><br>
                <small>Payment information and instructions will be sent to your email after order completion.</small>
              </div>
            </div>
          </div>
          
          <!-- 코인 결제 정보 -->
          <div id="coin-details" class="payment-details">
            <div class="alert alert-warning d-flex align-items-center">
              <i class="material-icons me-2">account_balance_wallet</i>
              <div>
                <strong>Cryptocurrency Payment Guide</strong><br>
                <small>You can pay with various cryptocurrencies through NowPayments.</small>
              </div>
            </div>
            
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Select Payment Currency</label>
                <select class="form-select" id="cryptoCurrency">
                  <option value="">Please select a currency</option>
                  <option value="btc">Bitcoin (BTC)</option>
                  <option value="eth">Ethereum (ETH)</option>
                  <option value="usdt">Tether (USDT)</option>
                  <option value="usdc">USD Coin (USDC)</option>
                  <option value="ltc">Litecoin (LTC)</option>
                  <option value="bch">Bitcoin Cash (BCH)</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Payment Amount</label>
                <div class="input-group">
                  <span class="input-group-text">£</span>
                  <input type="text" class="form-control" id="paymentAmount" readonly>
                </div>
              </div>
            </div>
            
            <div class="mt-3" id="cryptoAmountDisplay" style="display: none;">
              <div class="alert alert-info">
                <div class="d-flex justify-content-between align-items-center">
                  <span>Cryptocurrency amount to pay:</span>
                  <strong id="cryptoAmount">-</strong>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-2">
                  <span>Current exchange rate:</span>
                  <small id="exchangeRate">-</small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <style>
          .payment-card {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #ffffff;
            height: 100%;
          }
          
          .payment-card:hover {
            border-color: #007bff;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.15);
            transform: translateY(-2px);
          }
          
          .payment-card.selected {
            border-color: #007bff;
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.3);
          }
          
          .payment-card-body {
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            position: relative;
          }
          
          .payment-icon {
            font-size: 2.5rem;
            color: #007bff;
            flex-shrink: 0;
          }
          
          .payment-card.selected .payment-icon {
            color: white;
          }
          
          .payment-info {
            flex: 1;
          }
          
          .payment-title {
            margin: 0 0 0.5rem 0;
            font-size: 1.25rem;
            font-weight: 600;
          }
          
          .payment-desc {
            margin: 0;
            font-size: 0.9rem;
            color: #6c757d;
          }
          
          .payment-card.selected .payment-desc {
            color: rgba(255, 255, 255, 0.8);
          }
          
          .payment-check {
            font-size: 1.5rem;
            color: transparent;
            transition: all 0.3s ease;
          }
          
          .payment-card.selected .payment-check {
            color: white;
          }
          
          .payment-details {
            display: none;
            animation: fadeIn 0.3s ease;
          }
          
          .payment-details.active {
            display: block;
          }
          
          @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
          }
        </style>
      </div>
    </div>
    <div class="d-grid gap-2">
      <button type="button" class="btn btn-primary btn-lg" id="payBtn">Complete Payment</button>
    </div>
  </div>

  <script>
    
    // 서버에서 전달받은 주문 정보
    const orderId = "[[${order.id}]]";
    const orderTitle = "[[${order.title}]]";
    
    // 총 결제금액 계산 및 업데이트 함수
    function updateTotalPrice() {
      // 상품 가격 합계
      let itemTotal = 0;
      document.querySelectorAll('.item-price').forEach(function(el){
        itemTotal += parseInt(el.innerText.replace(/[^\d]/g, ''));
      });
      
      // 옵션 가격 합계
      let optionTotal = 0;
      document.querySelectorAll('.opt-total-view').forEach(function(el){
        optionTotal += parseInt(el.innerText.replace(/[^\d]/g, ''));
      });
      
      // 배송비
      const shipPrice = parseInt(document.getElementById('shipping-price').innerText.replace(/[^\d]/g, '')) || 0;
      
      // 총 결제금액
      const total = itemTotal + optionTotal + shipPrice;
      
      // 화면에 표시
      const totalPriceText = document.getElementById('total-price');
      if(totalPriceText) {
        totalPriceText.innerText = '£' + total.toLocaleString();
        totalPriceText.setAttribute('data', total);
      }
      
      return total;
    }
    
    // 페이지 로드 시 총 결제금액 계산 및 결제 카드 초기화
    document.addEventListener('DOMContentLoaded', function() {
      const total = updateTotalPrice();
      
      // 서버에 총 결제금액 동기화
      const orderId = "[[${order.id}]]" || 0;
      $ajax({
        url: '/api/shop/order',
        type: 'PUT',
        data: { id: orderId, totalPrice: total }
      });

      // 결제 카드 클릭 이벤트
      document.querySelectorAll('.payment-card').forEach(function(card) {
        card.addEventListener('click', function() {
          // 모든 카드에서 selected 클래스 제거
          document.querySelectorAll('.payment-card').forEach(function(c) {
            c.classList.remove('selected');
          });
          
          // 클릭한 카드에 selected 클래스 추가
          this.classList.add('selected');
          
          // 모든 결제 상세 정보 숨기기
          document.querySelectorAll('.payment-details').forEach(function(detail) {
            detail.classList.remove('active');
          });
          
          // 선택한 결제 방식의 상세 정보 표시
          const paymentType = this.getAttribute('data-payment');
          document.getElementById(paymentType + '-details').classList.add('selected-payment');
          document.getElementById(paymentType + '-details').classList.add('active');
        });
      });

      // 기본적으로 Cash Payment 선택
      document.getElementById('cash-card').classList.add('selected');

      // 초기 결제 금액 설정
      updatePaymentAmount();

      // 암호화폐 선택 시 환율 조회
      document.getElementById('cryptoCurrency').addEventListener('change', function() {
        const currency = this.value;
        if (currency) {
          getCryptoExchangeRate(currency);
        } else {
          document.getElementById('cryptoAmountDisplay').style.display = 'none';
        }
      });
    });

    // 결제 금액 업데이트 함수
    function updatePaymentAmount() {
      const paymentAmountInput = document.getElementById('paymentAmount');
      if (paymentAmountInput) {
        const totalPriceElement = document.getElementById('total-price');
        if (totalPriceElement) {
          const totalAmount = parseInt(totalPriceElement.getAttribute('data')) || 0;
          paymentAmountInput.value = (totalAmount / 100).toFixed(2); // 파운드 단위로 변환
        }
      }
    }

    // 암호화폐 환율 조회
    function getCryptoExchangeRate(currency) {
      const totalAmount = parseFloat(document.getElementById('paymentAmount').value);
      
      $ajax({
        url: '/api/payment/crypto/estimate',
        type: 'POST',
        data: {
          price_amount: totalAmount,
          price_currency: 'GBP',
          pay_currency: currency.toUpperCase()
        }
      }).then(function(response) {
        if (response && response.pay_amount) {
          document.getElementById('cryptoAmount').textContent = 
            response.pay_amount + ' ' + currency.toUpperCase();
          document.getElementById('exchangeRate').textContent = 
            '1 ' + currency.toUpperCase() + ' = £' + (totalAmount / response.pay_amount).toFixed(6);
          document.getElementById('cryptoAmountDisplay').style.display = 'block';
        }
      }).catch(function(error) {
        console.error('환율 조회 실패:', error);
        $alert('Exchange Rate Error', 'Unable to retrieve cryptocurrency exchange rate.', 'error');
      });
    }
    
    document.getElementById('payBtn').addEventListener('click', function() {

      // 주문자 정보 유효성 검사
      const buyerFirstName = document.getElementById('buyerFirstName').value;
      const buyerLastName = document.getElementById('buyerLastName').value;
      const buyerEmail = document.getElementById('buyerEmail').value;
      let buyerPhone = document.getElementById('buyerPhone').value;
      buyerPhone = buyerPhone.replace(/[^\d]/g, '');
      
      if (!buyerFirstName || !buyerLastName || !buyerEmail || !buyerPhone) {
        $alert('Input Error', 'Please fill in all customer details.', 'warning');
        return;
      }

      // 선택된 결제 방식 확인
      const selectedCard = document.querySelector('.payment-card.selected');
      if (!selectedCard) {
        $alert('Payment Method Selection', 'Please select a payment method.', 'warning');
        return;
      }
      const paymentMethod = selectedCard.getAttribute('data-payment').toUpperCase();

      // 결제 방식별 처리
      if (paymentMethod === 'CASH') {
        // 현금 결제 처리
        processCashPayment();
      } else if (paymentMethod === 'COIN') {
        // 코인 결제 처리
        processCoinPayment();
      }
    });

    // 현금 결제 처리 함수
    function processCashPayment() {
      const buyerFirstName = document.getElementById('buyerFirstName').value;
      const buyerLastName = document.getElementById('buyerLastName').value;
      const buyerEmail = document.getElementById('buyerEmail').value;
      let buyerPhone = document.getElementById('buyerPhone').value;
      const addressNo = document.querySelector('input[name="addressNo"]:checked') ? document.querySelector('input[name="addressNo"]:checked').value : null;

      $confirm(
        'Cash Payment Confirmation', 
        'Do you want to complete the order with cash payment?\nPayment information will be sent to your email after order completion.', 
        'question',
        'Pay',
        'Cancel'
      ).then((result) => {
        if (result.isConfirmed) {
          // 타이머 만들어서 "메일 발송 및 주문 처리 중입니다..." 
          // SweetAlert 무제한으로 로딩 띄우고 있다가
          // AJAX 요청이 끝나면 로딩 종료
          const loadingTimer = setTimeout(() => {
            Swal.fire({
              title: 'Processing order and sending email...',
              text: 'Please wait...',
              allowOutsideClick: false,
              didOpen: () => {
                Swal.showLoading()
              },
              onBeforeOpen: () => {
                Swal.showLoading()
              }
            });
          }, 500);

          $ajax({
            url: '/api/shop/order/cash-payment',
            type: 'POST',
            data: { 
              orderId: orderId,
              paymentMethod: 'CASH',
              buyerFirstName: buyerFirstName,
              buyerLastName: buyerLastName,
              buyerEmail: buyerEmail,
              buyerPhone: buyerPhone,
              addressNo: addressNo
            }
          }).then(function(res) {
            clearTimeout(loadingTimer);
            Swal.close();

            if (res === 'SUCCESS') {
              $alert_('Order Completed', 'Your order has been completed. Payment information has been sent to your email.', 'success').then(() => {
                window.location.href = '/pay/cash/success?orderId=' + orderId;
              });
            } else {
              $alert('Order Failed', 'Order processing failed.', 'error');
            }
          });
        }
      });
    }

    // 코인 결제 처리 함수
    function processCoinPayment() {
      const cryptoCurrency = document.getElementById('cryptoCurrency').value;
      const paymentAmount = document.getElementById('paymentAmount').value;
      const buyerFirstName = document.getElementById('buyerFirstName').value;
      const buyerLastName = document.getElementById('buyerLastName').value;
      const buyerEmail = document.getElementById('buyerEmail').value;
      const buyerPhone = document.getElementById('buyerPhone').value;
      const addressNo = document.querySelector('input[name="addressNo"]:checked') ? 
        document.querySelector('input[name="addressNo"]:checked').value : null;

      // 유효성 검사
      if (!cryptoCurrency) {
        $alert('Payment Currency Selection', 'Please select a cryptocurrency to pay.', 'warning');
        return;
      }

      const cryptoAmount = document.getElementById('cryptoAmount').textContent;
      
      $confirm(
        'Cryptocurrency Payment Confirmation',
        `Would you like to pay with ${cryptoAmount}?\nYou will be redirected to the payment page.`,
        'question',
        'Pay',
        'Cancel'
      ).then((result) => {
        if (result.isConfirmed) {
          // 로딩 표시
          Swal.fire({
            title: 'Preparing payment...',
            text: 'Please wait.',
            allowOutsideClick: false,
            didOpen: () => {
              Swal.showLoading()
            }
          });

          // NowPayments 결제 생성 요청
          $ajax({
            url: '/api/payment/crypto/create',
            type: 'POST',
            data: {
              orderId: orderId,
              price_amount: paymentAmount,
              price_currency: 'GBP',
              pay_currency: cryptoCurrency.toUpperCase(),
              buyerFirstName: buyerFirstName,
              buyerLastName: buyerLastName,
              buyerEmail: buyerEmail,
              buyerPhone: buyerPhone,
              addressNo: addressNo
            }
          }).then(function(response) {
            Swal.close();
            
            if (response && response.payment_url) {
              // NowPayments 결제 페이지로 리다이렉트
              window.location.href = response.payment_url;
            } else if (response && response.pay_address) {
              // QR 코드나 주소 표시 방식
              showCryptoPaymentInfo(response);
            } else {
              $alert('Payment Creation Failed', 'Unable to create cryptocurrency payment.', 'error');
            }
          }).catch(function(error) {
            Swal.close();
            console.error('결제 생성 실패:', error);
            $alert('Payment Failed', 'Failed to create cryptocurrency payment.', 'error');
          });
        }
      });
    }

    // 암호화폐 결제 정보 표시 (주소 방식)
    function showCryptoPaymentInfo(paymentData) {
      const modalHtml = `
        <div class="modal fade" id="cryptoPaymentModal" tabindex="-1">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">암호화폐 결제</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body text-center">
                <div class="alert alert-info">
                  <strong>결제 금액:</strong> ${paymentData.pay_amount} ${paymentData.pay_currency}
                </div>
                <div class="mb-3">
                  <label class="form-label">결제 주소</label>
                  <div class="input-group">
                    <input type="text" class="form-control" value="${paymentData.pay_address}" readonly id="payAddress">
                    <button class="btn btn-outline-secondary" onclick="copyToClipboard('payAddress')">복사</button>
                  </div>
                </div>
                <div class="alert alert-warning">
                  <small>위 주소로 정확한 금액을 송금해주세요. 결제 완료 후 자동으로 처리됩니다.</small>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                <button type="button" class="btn btn-primary" onclick="checkPaymentStatus('${paymentData.payment_id}')">결제 확인</button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      const modal = new bootstrap.Modal(document.getElementById('cryptoPaymentModal'));
      modal.show();
    }

    // 클립보드 복사 함수
    function copyToClipboard(elementId) {
      const element = document.getElementById(elementId);
      element.select();
      document.execCommand('copy');
      $toast({ title: 'Address copied.', icon: 'success' });
    }

    // 결제 상태 확인
    function checkPaymentStatus(paymentId) {
      $ajax({
        url: '/api/payment/crypto/status/' + paymentId,
        type: 'GET'
      }).then(function(response) {
        if (response.payment_status === 'finished') {
          $alert('Payment Completed', 'Cryptocurrency payment has been completed.', 'success');
          window.location.href = '/pay/crypto/success?orderId=' + orderId;
        } else if (response.payment_status === 'failed') {
          $alert('Payment Failed', 'Cryptocurrency payment failed.', 'error');
        } else {
          $alert('Payment Pending', 'Payment is not yet completed. Please check again later.', 'info');
        }
      });
    }
    
    // 옵션 수량 값 직접 변경 - opt-qty-input
    document.querySelectorAll('.opt-qty-input').forEach(function(input) {
      input.addEventListener('keyup', function() {
        const id = this.getAttribute('data-id');
        let qty = parseInt(this.value, 10);
        if (isNaN(qty) || qty < 1) {
          $alert('Quantity Error', 'Quantity must be 1 or more.', 'warning');
          this.value = 1;
          return;
        }
        $ajax({
          url: '/api/shop/order-item-option',
          type: 'PUT',
          data: { id: id, quantity: qty }
        }).then(function(res) {
          if (res !== 'FAIL') {
            // 수량*가격 합계 갱신
            const price = parseInt(input.closest('.border').querySelector('.me-2:nth-child(2) span').innerText.replace(/[^\d]/g, ''));
            input.closest('.border').querySelector('.opt-qty-view').innerText = qty;
            input.closest('.border').querySelector('.opt-total-view').innerText = '£' + (price * qty).toLocaleString();
            
            // 총 결제금액 업데이트
            const total = updateTotalPrice();
            
            // 결제 금액도 업데이트
            updatePaymentAmount();
            
            // 서버에도 totalPrice 동기화
            const orderId = "[[${order.id}]]" || 0;
            $ajax({
              url: '/api/shop/order',
              type: 'PUT',
              data: { id: orderId, totalPrice: total }
            });
          } else {
            $alert('Quantity Update Failed', 'Failed to update quantity.', 'error');
          }
        });
      });
    });


    // 옵션 수량 변경 비동기 처리
    document.querySelectorAll('.opt-qty-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        const id = this.getAttribute('data-id');
        const action = this.getAttribute('data-action');
        const input = document.querySelector('.opt-qty-input[data-id="' + id + '"]');
        let qty = parseInt(input.value, 10);
        if (action === 'decrease' && qty > 1) qty--;
        if (action === 'increase') qty++;
        $ajax({
          url: '/api/shop/order-item-option',
          type: 'PUT',
          data: { id: id, quantity: qty }
        }).then(function(res) {
          if (res !== 'FAIL') {
            input.value = qty;
            // 수량*가격 합계 갱신
            const price = parseInt(input.closest('.border').querySelector('.me-2:nth-child(2) span').innerText.replace(/[^\d]/g, ''));
            input.closest('.border').querySelector('.opt-qty-view').innerText = qty;
            input.closest('.border').querySelector('.opt-total-view').innerText = '£' + (price * qty).toLocaleString();
            
            // 총 결제금액 업데이트
            const total = updateTotalPrice();

            // 결제 금액도 업데이트
            updatePaymentAmount();

            // 서버에도 totalPrice 동기화
            const orderId = "[[${order.id}]]" || 0;
            $ajax({
              url: '/api/shop/order',
              type: 'PUT',
              data: { id: orderId, totalPrice: total }
            });
          } else {
            $alert('Quantity Update Failed', 'Failed to update quantity.', 'error');
          }
        });
      });
    });
  </script>
</body>
</html>
