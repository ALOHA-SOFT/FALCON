<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{UI/layouts/user/main_layout}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì£¼ë¬¸/ê²°ì œ</title>
</head>
<body layout:fragment="content">
  <div class="container my-5">
    <h2 class="mb-4">ì£¼ë¬¸/ê²°ì œ</h2>

    <div class="row">
      <div class="col-12 col-md-6">
        <!-- ì£¼ë¬¸ì ì •ë³´ -->
        <div class="card mb-4">
          <div class="card-header">Customer Details</div>
          <div class="card-body row g-3">
            <div class="col-12">
              <label for="buyerEmail" class="form-label">Email</label>
              <input type="email" class="form-control" id="buyerEmail" name="buyerEmail" th:value="${user.email}" required>
            </div>
            <div class="col-6">
              <label for="buyerFirstName" class="form-label">First Name</label>
              <input type="text" class="form-control" id="buyerFirstName" name="buyerFirstName" th:value="${user.firstName}" required>
            </div>
            <div class="col-6">
              <label for="buyerLastName" class="form-label">Last Name</label>
              <input type="text" class="form-control" id="buyerLastName" name="buyerLastName" th:value="${user.lastName}" required>
            </div>
            <div class="col-12">
              <label for="buyerPhone" class="form-label">ì—°ë½ì²˜</label>
              <input type="tel" class="form-control" id="buyerPhone" name="buyerPhone" th:value="${user.tel}" required>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-12 col-md-6">
        <!-- ë°°ì†¡ì§€ ì •ë³´ -->
        <div class="card mb-4">
          <div class="card-header">
            <div class="col-12 d-flex justify-content-between align-items-center">
              <span>Delivery Details</span>
              <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addAddressModal">+ ìƒˆ ë°°ì†¡ì§€ ì¶”ê°€</button>
            </div>
          </div>
          <div class="card-body" style="height: 338px; overflow-y: auto;">
            <div class="mb-3">
              <div class="row g-2" th:if="${addressList != null}">
                <div class="col-12" th:each="addr : ${addressList}">
                  <div class="card mb-2" th:classappend="${addr.isMain} ? 'border-primary' : ''">
                    <div class="card-body d-flex align-items-center ">
                      <input class="form-check-input me-3" type="radio" name="addressNo" th:id="'address_' + ${addr.no}" th:value="${addr.no}" th:checked="${addr.isMain}">
                      <label th:for="'address_' + ${addr.no}" class="w-100 mb-0 cursor-pointer address-label">
                        <div class="d-flex justify-content-between align-items-center">
                          <div>
                            <strong th:text="${addr.recipient}">ìˆ˜ë ¹ì¸</strong>
                            <span class="ms-2" th:text="${addr.tel}">ì—°ë½ì²˜</span>
                          </div>
                          <div>
                            <span class="ms-2 badge bg-primary" th:if="${addr.isMain}">ê¸°ë³¸ë°°ì†¡ì§€</span>
                          </div>
                        </div>
                        <!-- <div th:text="${addr.postcode} + ' ' + ${addr.address} + ' ' + ${addr.addressDong} + ' ' + ${addr.addressDetail}">ì£¼ì†Œ</div> -->
                        <div class="fs-6">
                          <span class="badge bg-secondary" th:text="${addr.postcode}">ìš°í¸ë²ˆí˜¸</span>
                          <span th:text="${addr.address} + ' ' + ${addr.addressDetail}" class="span-address" th:classappend="${addr.isMain} ? 'main' : ''">ì£¼ì†Œ</span> <br>
                          <span th:text="${addr.addressDong} + ' ' + ${addr.addressDetail}">ì£¼ì†Œ</span>
                          <div class="text-muted small" th:if="${addr.deliveryRequest}" th:text="'ìš”ì²­ì‚¬í•­: ' + ${addr.deliveryRequest}">ìš”ì²­ì‚¬í•­</div>
                        </div>
                      </label>
                    </div>
                  </div>
                </div>
              </div>
                <div th:if="${addressList == null or #lists.isEmpty(addressList)}" class="text-muted text-center py-4">
                  <i class="material-icons" style="font-size: 36px; color: #ccc;">local_shipping</i>
                  <p class="mt-2 mb-2">ë“±ë¡ëœ ë°°ì†¡ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                  <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addAddressModal">+ ìƒˆ ë°°ì†¡ì§€ ì¶”ê°€</button>
                </div>
                <!-- ë°°ì†¡ì§€ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
                <div class="modal fade" id="addAddressModal" tabindex="-1" aria-labelledby="addAddressModalLabel" aria-hidden="true">
                  <div class="modal-dialog">
                    <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="addAddressModalLabel">ë°°ì†¡ì§€ ì¶”ê°€</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <form id="order-address-form">
                      <input type="hidden" name="userNo" th:value="${user.no}">
                      <div class="mb-2">
                        <label class="form-label">ìˆ˜ë ¹ì¸</label>
                        <input type="text" class="form-control" name="recipient" id="orderRecipient" required>
                      </div>
                      <div class="mb-2">
                        <label class="form-label">ì—°ë½ì²˜</label>
                        <input type="tel" class="form-control" name="tel" id="orderTel" required>
                      </div>
                      <div class="mb-2">
                        <label class="form-label">Country/Region</label>
                        <select class="form-select" name="country" id="orderCountry">
                          <option value="">êµ­ê°€/ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
                          <option value="KR">ëŒ€í•œë¯¼êµ­</option>
                          <option value="US">ë¯¸êµ­</option>
                          <option value="JP">ì¼ë³¸</option>
                          <option value="CN">ì¤‘êµ­</option>
                          <option value="GB">ì˜êµ­</option>
                          <option value="DE">ë…ì¼</option>
                          <option value="FR">í”„ë‘ìŠ¤</option>
                          <option value="CA">ìºë‚˜ë‹¤</option>
                          <option value="AU">í˜¸ì£¼</option>
                        </select>
                      </div>
                      <div class="mb-2">
                        <label class="form-label">Address</label>
                        <div class="input-group">
                        <input type="text" id="orderPostcode" class="form-control" name="postcode" placeholder="ìš°í¸ë²ˆí˜¸" readonly>
                        <button type="button" class="btn btn-outline-secondary" onclick="execOrderDaumPostcode()">ì£¼ì†Œ ì°¾ê¸°</button>
                        </div>
                        <input type="text" class="form-control mt-2" name="address" id="orderAddress" placeholder="ë„ë¡œëª…ì£¼ì†Œ" readonly required>
                        <input type="text" class="form-control mt-2" name="addressDong" id="orderAddressDong" placeholder="ì§€ë²ˆì£¼ì†Œ" readonly>
                      </div>
                      <div class="mb-2">
                        <label class="form-label">City</label>
                        <input type="text" class="form-control" name="city" id="orderCity" placeholder="ë„ì‹œëª…">
                      </div>
                      <div class="mb-2">
                        <label class="form-label">Zip/Postal code</label>
                        <input type="text" class="form-control" name="zipCode" id="orderZipCode" placeholder="ìš°í¸ë²ˆí˜¸">
                      </div>
                      <div class="mb-2">
                        <label class="form-label">ìƒì„¸ì£¼ì†Œ</label>
                        <input type="text" class="form-control" name="addressDetail" id="orderAddressDetail" placeholder="ìƒì„¸ì£¼ì†Œ (ì•„íŒŒíŠ¸, ë™í˜¸ìˆ˜ ë“±)" required>
                      </div>
                      <div class="mb-2">
                        <label class="form-label">ìš”ì²­ì‚¬í•­</label>
                        <select id="orderDeliveryRequestSelect" class="form-select mt-2">
                        <option value="">ë°°ì†¡ ìš”ì²­ì‚¬í•­ì„ ì„ íƒí•´ì£¼ì„¸ìš”</option>
                        <option value="ë¶€ì¬ ì‹œ ë¬¸ ì•ì— ë†“ì•„ì£¼ì„¸ìš”">ë¶€ì¬ ì‹œ ë¬¸ ì•ì— ë†“ì•„ì£¼ì„¸ìš”</option>
                        <option value="ê²½ë¹„ì‹¤ì— ë§¡ê²¨ì£¼ì„¸ìš”">ê²½ë¹„ì‹¤ì— ë§¡ê²¨ì£¼ì„¸ìš”</option>
                        <option value="íƒë°°í•¨ì— ë„£ì–´ì£¼ì„¸ìš”">íƒë°°í•¨ì— ë„£ì–´ì£¼ì„¸ìš”</option>
                        <option value="ë²¨ ëˆ„ë¥´ì§€ ë§ˆì„¸ìš”">ë²¨ ëˆ„ë¥´ì§€ ë§ˆì„¸ìš”</option>
                        <option value="ë°°ì†¡ ì „ì— ì—°ë½ì£¼ì„¸ìš”">ë°°ì†¡ ì „ì— ì—°ë½ì£¼ì„¸ìš”</option>
                        <option value="custom">ì§ì ‘ ì…ë ¥</option>
                        </select>
                        <input type="text" class="form-control d-none" name="deliveryRequest" id="orderDeliveryRequest" placeholder="ë°°ì†¡ ìš”ì²­ì‚¬í•­ (ì„ íƒ)" readonly>
                      </div>
                      <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="orderIsMain" name="isMain">
                        <label class="form-check-label" for="orderIsMain">ê¸°ë³¸ ë°°ì†¡ì§€ë¡œ ì„¤ì •</label>
                      </div>
                      <button type="submit" class="btn btn-primary w-100">ì €ì¥</button>
                      </form>
                    </div>
                    </div>
                  </div>
                </div>
                <!-- Daum Postcode CDN -->
                <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
                <script>
                  function execOrderDaumPostcode() {
                    new daum.Postcode({
                    oncomplete: function(data) {
                      document.getElementById('orderPostcode').value = data.zonecode;
                      document.getElementById('orderAddress').value = data.roadAddress;
                      document.getElementById('orderAddressDong').value = data.jibunAddress;
                    }
                    }).open();
                  }
                  document.getElementById('orderDeliveryRequestSelect').addEventListener('change', function() {
                    const selectedValue = this.value;
                    const deliveryRequestInput = document.getElementById('orderDeliveryRequest');
                    if (selectedValue === 'custom') {
                    deliveryRequestInput.removeAttribute('readonly');
                    deliveryRequestInput.classList.remove('d-none');
                    deliveryRequestInput.value = '';
                    deliveryRequestInput.focus();
                    } else if (selectedValue === '') {
                    deliveryRequestInput.value = '';
                    deliveryRequestInput.classList.add('d-none');
                    } else {
                    deliveryRequestInput.value = selectedValue;
                    deliveryRequestInput.classList.add('d-none');
                    }
                  });
                  document.getElementById('order-address-form').addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const formData = new FormData(this);
                    const addressData = {
                    userNo: formData.get('userNo') || '',
                    recipient: formData.get('recipient') || '',
                    tel: formData.get('tel') || '',
                    country: formData.get('country') || '',
                    postcode: formData.get('postcode') || '',
                    address: formData.get('address') || '',
                    addressDong: formData.get('addressDong') || '',
                    addressDetail: formData.get('addressDetail') || '',
                    city: formData.get('city') || '',
                    deliveryRequest: formData.get('deliveryRequest') || '',
                    isMain: formData.get('isMain') === 'on',
                    };
                    try {
                    await $ajax({
                      url: '/api/users/address',
                      type: 'POST',
                      data: addressData
                    });
                    await $toast({
                      title: 'ë°°ì†¡ì§€ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.',
                      icon: 'success'
                    });
                    // ëª¨ë‹¬ ë‹«ê¸°
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addAddressModal'));
                    modal.hide();
                    location.reload();
                    } catch (error) {
                    $alert('ì˜¤ë¥˜', 'ë°°ì†¡ì§€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    }
                  });

                  document.querySelectorAll('.address-label').forEach(function(label) {
                    label.addEventListener('click', function() {
                      const spanAddr = label.querySelector('.span-address');
                      if (spanAddr) {
                        document.getElementById('buyerAddress').value = spanAddr.innerText;
                      }
                    });
                  });

                  const mainAddr = document.querySelector('.span-address.main');
                  if (mainAddr) {
                    document.getElementById('buyerAddress').value = mainAddr.innerText;
                  }
                </script>
              </div>
            </div>
          </div>
        </div>
      </div>
    <!-- ì£¼ë¬¸ ìƒí’ˆ/ì˜µì…˜ ìƒì„¸ -->
    <div class="card mb-4">
      <div class="card-header">ì£¼ë¬¸ ìƒí’ˆ ìƒì„¸</div>
      <div class="card-body">
        <div class="row g-3" th:each="item : ${order.orderItems}">
          <div class="col-12">
            <div class="card mb-3">
              <div class="card-body">
                <div class="row mb-2 align-items-center">
                  <div class="col-md-6">
                    <div class="row mb-2">
                      <div class="col-6">
                        <img th:src="${item.product.thumbImg != null and item.product.thumbImg.content != null ? item.product.thumbImg.content : 'https://placehold.co/120x120?text=Image'}" alt="ìƒí’ˆ ì´ë¯¸ì§€" class="img-fluid rounded" style="max-height:120px;">
                      </div>
                      <div class="col-6 d-flex flex-column justify-content-between">
                        <div>
                          <strong>ìƒí’ˆëª…:</strong> <span th:text="${item.product.name}">ìƒí’ˆëª…</span>
                        </div>
                        <div>
                          <strong>ìƒí’ˆë²ˆí˜¸:</strong> <span th:text="${item.productNo}">ìƒí’ˆë²ˆí˜¸</span>
                        </div>
                        <div>
                          <strong>ìˆ˜ëŸ‰:</strong> <span th:text="${item.quantity}">1</span>
                        </div>
                        <div>
                          <strong>ê°€ê²©:</strong> <span th:text="${'Â£' + #numbers.formatInteger(item.price, 0, 'COMMA')}" class="item-price" data-item-id="${item.productNo}">Â£0</span>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div th:if="${item.orderItemOptions != null}">
                      <div class="row g-2" th:each="opt : ${item.orderItemOptions}">
                        <div class="col-12">
                          <div class="border rounded p-2 d-flex align-items-center justify-content-between flex-column flex-md-row gap-2">
                            <div>
                              <span class="me-2"><span th:text="${opt.option.name}" class="fw-bold p-2 fs-5">ì˜µì…˜ëª…</span></span>
                              <span class="me-2">ê°€ê²©: <span th:text="${'Â£' + #numbers.formatInteger(opt.price, 0, 'COMMA')}">Â£0</span></span>
                              <span class="me-2">ìˆ˜ëŸ‰: <span class="opt-qty-view" th:text="${opt.quantity}" th:data-id="${opt.id}">1</span></span>
                              <span class="fw-bold text-primary">
                                <span class="opt-total-view" th:text="${'Â£' + #numbers.formatInteger(opt.price * opt.quantity, 0, 'COMMA')}" th:data-id="${opt.id}">Â£0</span>
                              </span>
                            </div>
                            <div class="d-flex align-items-center">
                              <button type="button" class="btn btn-outline-secondary btn-sm me-1 opt-qty-btn" data-action="decrease" th:data-id="${opt.id}">-</button>
                              <input type="text" class="form-control form-control-sm text-center opt-qty-input" style="width:50px;" th:value="${opt.quantity}" th:data-id="${opt.id}" />
                              <button type="button" class="btn btn-outline-secondary btn-sm ms-1 opt-qty-btn" data-action="increase" th:data-id="${opt.id}">+</button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    
    <!-- ì£¼ë¬¸ ì •ë³´ ìš”ì•½ -->
    <div class="card mb-4">
      <div class="card-header">ì£¼ë¬¸ ì •ë³´</div>
      <div class="card-body fs-4">
        <div class="row mb-2">
          <div class="col-md-4"><strong>ì£¼ë¬¸ë²ˆí˜¸</strong></div>
          <div class="col-md-8 text-end" th:text="${order.code}">ORDER_CODE</div>
        </div>
        <div class="row mb-2">
          <div class="col-md-4"><strong>ì£¼ë¬¸ì</strong></div>
          <div class="col-md-8 text-end" th:text="${order.userNo}">ì£¼ë¬¸ìë²ˆí˜¸</div>
        </div>
        <div class="row mb-2">
          <div class="col-md-4"><strong>ë°°ì†¡ë¹„</strong></div>
          <div id="shipping-price" class="col-md-8 text-end" th:text="${'Â£' + #numbers.formatInteger(order.shipPrice, 0, 'COMMA')}">Â£0</div>
        </div>
        <div class="row mb-2">
          <div class="col-md-4"><strong>ìƒíƒœ</strong></div>
          <div class="col-md-8 text-end" th:text="${order.status}">ê²°ì œëŒ€ê¸°</div>
        </div>
        <div class="row mb-2 text-danger">
          <div class="col-md-4"><strong>ì´ ê²°ì œê¸ˆì•¡</strong></div>
          <div id="total-price" th:data="${order.totalPrice}" class="col-md-8 text-end" th:text="${'Â£' + #numbers.formatInteger(order.totalPrice + order.shipPrice, 0, 'COMMA')}">Â£0</div>
        </div>
      </div>
    </div>
    <!-- ê²°ì œ ì˜ì—­ -->
    <div class="card mb-4">
      <div class="card-header">ê²°ì œìˆ˜ë‹¨ ì„ íƒ</div>
      <div class="card-body">
        <!-- ê²°ì œ ë°©ì‹ ì„ íƒ íƒ­ -->
        <ul class="nav nav-tabs mb-3" id="paymentTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="cash-tab" data-bs-toggle="tab" data-bs-target="#cash-payment" type="button" role="tab" aria-controls="cash-payment" aria-selected="true">Cash Payment</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="coin-tab" data-bs-toggle="tab" data-bs-target="#coin-payment" type="button" role="tab" aria-controls="coin-payment" aria-selected="false">Coin Payment</button>
          </li>
        </ul>

        <!-- ê²°ì œ ë°©ì‹ë³„ ì»¨í…ì¸  -->
        <div class="tab-content" id="paymentTabContent">
          <!-- í˜„ê¸ˆ ê²°ì œ -->
          <div class="tab-pane fade show active" id="cash-payment" role="tabpanel" aria-labelledby="cash-tab">
            <div class="alert alert-info d-flex align-items-center">
              <i class="material-icons">email</i>
              <span>
                í˜„ê¸ˆ ê²°ì œëŠ” ì£¼ë¬¸ ì™„ë£Œ í›„ ì´ë©”ì¼ë¡œ ê²°ì œ ì •ë³´ë¥¼ ì•ˆë‚´ë°›ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.
              </span>
            </div>
            <div class="form-group">
              <label class="form-label">í˜„ê¸ˆ ê²°ì œ ì•ˆë‚´</label>
              <div class="form-text">ì£¼ë¬¸ ì™„ë£Œ í›„ ì…ë ¥í•˜ì‹  ì´ë©”ì¼ë¡œ ê²°ì œ ì •ë³´ì™€ ì•ˆë‚´ì‚¬í•­ì„ ë°œì†¡í•´ë“œë¦½ë‹ˆë‹¤.</div>
            </div>
          </div>
          
          <!-- ì½”ì¸ ê²°ì œ -->
          <div class="tab-pane fade" id="coin-payment" role="tabpanel" aria-labelledby="coin-tab">
            <div class="alert alert-warning d-flex align-items-center">
              <i class="material-icons">account_balance_wallet</i>
              <span>
                ì½”ì¸ ê²°ì œëŠ” ë³´ìœ  ì½”ì¸ìœ¼ë¡œ ê²°ì œí•˜ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.
              </span>
            </div>
            <div class="form-group">
              <label class="form-label">ë³´ìœ  ì½”ì¸</label>
              <div class="input-group">
                <span class="input-group-text">ğŸ’°</span>
                <input type="text" class="form-control" value="1,000 ì½”ì¸" readonly>
              </div>
              <div class="form-text">ì½”ì¸ì´ ë¶€ì¡±í•œ ê²½ìš° ì¶©ì „ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="d-grid gap-2">
      <button type="button" class="btn btn-primary btn-lg" id="payBtn">ê²°ì œí•˜ê¸°</button>
    </div>
  </div>

  <script>
    
    // ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ ì£¼ë¬¸ ì •ë³´
    const orderId = "[[${order.id}]]";
    const orderTitle = "[[${order.title}]]";
    
    // ì´ ê²°ì œê¸ˆì•¡ ê³„ì‚° ë° ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateTotalPrice() {
      // ìƒí’ˆ ê°€ê²© í•©ê³„
      let itemTotal = 0;
      document.querySelectorAll('.item-price').forEach(function(el){
        itemTotal += parseInt(el.innerText.replace(/[^\d]/g, ''));
      });
      
      // ì˜µì…˜ ê°€ê²© í•©ê³„
      let optionTotal = 0;
      document.querySelectorAll('.opt-total-view').forEach(function(el){
        optionTotal += parseInt(el.innerText.replace(/[^\d]/g, ''));
      });
      
      // ë°°ì†¡ë¹„
      const shipPrice = parseInt(document.getElementById('shipping-price').innerText.replace(/[^\d]/g, '')) || 0;
      
      // ì´ ê²°ì œê¸ˆì•¡
      const total = itemTotal + optionTotal + shipPrice;
      
      // í™”ë©´ì— í‘œì‹œ
      const totalPriceText = document.getElementById('total-price');
      if(totalPriceText) {
        totalPriceText.innerText = 'Â£' + total.toLocaleString();
        totalPriceText.setAttribute('data', total);
      }
      
      return total;
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ ê²°ì œê¸ˆì•¡ ê³„ì‚° ë° ê²°ì œìœ„ì ¯ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
      const total = updateTotalPrice();
      
      // ì„œë²„ì— ì´ ê²°ì œê¸ˆì•¡ ë™ê¸°í™”
      const orderId = "[[${order.id}]]" || 0;
      $ajax({
        url: '/api/shop/order',
        type: 'PUT',
        data: { id: orderId, totalPrice: total }
      });
    });
    
    document.getElementById('payBtn').addEventListener('click', function() {

      // ì£¼ë¬¸ì ì •ë³´ ìœ íš¨ì„± ê²€ì‚¬
      const buyerFirstName = document.getElementById('buyerFirstName').value;
      const buyerLastName = document.getElementById('buyerLastName').value;
      const buyerEmail = document.getElementById('buyerEmail').value;
      let buyerPhone = document.getElementById('buyerPhone').value;
      buyerPhone = buyerPhone.replace(/[^\d]/g, '');
      
      if (!buyerFirstName || !buyerLastName || !buyerEmail || !buyerPhone) {
        $alert('ì…ë ¥ ì˜¤ë¥˜', 'Customer detailsë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        return;
      }

      // ì„ íƒëœ ê²°ì œ ë°©ì‹ í™•ì¸
      const activeTab = document.querySelector('#paymentTabs .nav-link.active');
      const paymentMethod = activeTab.id.replace('-tab', '').toUpperCase();

      // ê²°ì œ ë°©ì‹ë³„ ì²˜ë¦¬
      if (paymentMethod === 'CASH') {
        // í˜„ê¸ˆ ê²°ì œ ì²˜ë¦¬
        processCashPayment();
      } else if (paymentMethod === 'COIN') {
        // ì½”ì¸ ê²°ì œ ì²˜ë¦¬
        processCoinPayment();
      }
    });

    // í˜„ê¸ˆ ê²°ì œ ì²˜ë¦¬ í•¨ìˆ˜
    function processCashPayment() {
      $confirm(
        'í˜„ê¸ˆ ê²°ì œ í™•ì¸', 
        'í˜„ê¸ˆ ê²°ì œë¡œ ì£¼ë¬¸ì„ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì£¼ë¬¸ ì™„ë£Œ í›„ ì´ë©”ì¼ë¡œ ê²°ì œ ì •ë³´ë¥¼ ì•ˆë‚´í•´ë“œë¦½ë‹ˆë‹¤.', 
        'question',
        'ê²°ì œí•˜ê¸°',
        'ì·¨ì†Œ'
      ).then((result) => {
        if (result.isConfirmed) {
          $ajax({
            url: '/api/shop/order/cash-payment',
            type: 'POST',
            data: { 
              orderId: orderId,
              paymentMethod: 'CASH'
            }
          }).then(function(res) {
            if (res === 'SUCCESS') {
              $alert('ì£¼ë¬¸ ì™„ë£Œ', 'ì£¼ë¬¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì…ë ¥í•˜ì‹  ì´ë©”ì¼ë¡œ ê²°ì œ ì •ë³´ë¥¼ ë°œì†¡í–ˆìŠµë‹ˆë‹¤.', 'success');
              window.location.href = '/shop/order/complete?orderId=' + orderId;
            } else {
              $alert('ì£¼ë¬¸ ì‹¤íŒ¨', 'ì£¼ë¬¸ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
          });
        }
      });
    }

    // ì½”ì¸ ê²°ì œ ì²˜ë¦¬ í•¨ìˆ˜
    function processCoinPayment() {
      const totalAmount = updateTotalPrice();
      $confirm(
        'ì½”ì¸ ê²°ì œ í™•ì¸',
        'ì½”ì¸ìœ¼ë¡œ ' + totalAmount.toLocaleString() + 'ì›ì„ ê²°ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
        'question',
        'ê²°ì œí•˜ê¸°',
        'ì·¨ì†Œ'
      ).then((result) => {
        if (result.isConfirmed) {
          $ajax({
            url: '/api/shop/order/coin-payment',
            type: 'POST',
            data: { 
              orderId: orderId,
              paymentMethod: 'COIN',
              coinAmount: totalAmount
            }
          }).then(function(res) {
            if (res === 'SUCCESS') {
              $alert('ê²°ì œ ì™„ë£Œ', 'ì½”ì¸ ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
              window.location.href = '/shop/order/complete?orderId=' + orderId;
            } else if (res === 'INSUFFICIENT_COIN') {
              $alert('ì½”ì¸ ë¶€ì¡±', 'ë³´ìœ  ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ì½”ì¸ì„ ì¶©ì „í•´ì£¼ì„¸ìš”.', 'warning');
            } else {
              $alert('ê²°ì œ ì‹¤íŒ¨', 'ì½”ì¸ ê²°ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
          });
        }
      });
    }
    
    // ì˜µì…˜ ìˆ˜ëŸ‰ ê°’ ì§ì ‘ ë³€ê²½ - opt-qty-input
    document.querySelectorAll('.opt-qty-input').forEach(function(input) {
      input.addEventListener('keyup', function() {
        const id = this.getAttribute('data-id');
        let qty = parseInt(this.value, 10);
        if (isNaN(qty) || qty < 1) {
          $alert('ìˆ˜ëŸ‰ ì˜¤ë¥˜', 'ìˆ˜ëŸ‰ì€ 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.', 'warning');
          this.value = 1;
          return;
        }
        $ajax({
          url: '/api/shop/order-item-option',
          type: 'PUT',
          data: { id: id, quantity: qty }
        }).then(function(res) {
          if (res !== 'FAIL') {
            // ìˆ˜ëŸ‰*ê°€ê²© í•©ê³„ ê°±ì‹ 
            const price = parseInt(input.closest('.border').querySelector('.me-2:nth-child(2) span').innerText.replace(/[^\d]/g, ''));
            input.closest('.border').querySelector('.opt-qty-view').innerText = qty;
            input.closest('.border').querySelector('.opt-total-view').innerText = 'Â£' + (price * qty).toLocaleString();
            
            // ì´ ê²°ì œê¸ˆì•¡ ì—…ë°ì´íŠ¸
            const total = updateTotalPrice();
            
            // ì„œë²„ì—ë„ totalPrice ë™ê¸°í™”
            const orderId = "[[${order.id}]]" || 0;
            $ajax({
              url: '/api/shop/order',
              type: 'PUT',
              data: { id: orderId, totalPrice: total }
            });
          } else {
            $alert('ìˆ˜ëŸ‰ ë³€ê²½ ì‹¤íŒ¨', 'ìˆ˜ëŸ‰ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
          }
        });
      });
    });


    // ì˜µì…˜ ìˆ˜ëŸ‰ ë³€ê²½ ë¹„ë™ê¸° ì²˜ë¦¬
    document.querySelectorAll('.opt-qty-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        const id = this.getAttribute('data-id');
        const action = this.getAttribute('data-action');
        const input = document.querySelector('.opt-qty-input[data-id="' + id + '"]');
        let qty = parseInt(input.value, 10);
        if (action === 'decrease' && qty > 1) qty--;
        if (action === 'increase') qty++;
        $ajax({
          url: '/api/shop/order-item-option',
          type: 'PUT',
          data: { id: id, quantity: qty }
        }).then(function(res) {
          if (res !== 'FAIL') {
            input.value = qty;
            // ìˆ˜ëŸ‰*ê°€ê²© í•©ê³„ ê°±ì‹ 
            const price = parseInt(input.closest('.border').querySelector('.me-2:nth-child(2) span').innerText.replace(/[^\d]/g, ''));
            input.closest('.border').querySelector('.opt-qty-view').innerText = qty;
            input.closest('.border').querySelector('.opt-total-view').innerText = 'Â£' + (price * qty).toLocaleString();
            
            // ì´ ê²°ì œê¸ˆì•¡ ì—…ë°ì´íŠ¸
            const total = updateTotalPrice();

            // ì„œë²„ì—ë„ totalPrice ë™ê¸°í™”
            const orderId = "[[${order.id}]]" || 0;
            $ajax({
              url: '/api/shop/order',
              type: 'PUT',
              data: { id: orderId, totalPrice: total }
            });
          } else {
            $alert('ìˆ˜ëŸ‰ ë³€ê²½ ì‹¤íŒ¨', 'ìˆ˜ëŸ‰ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
          }
        });
      });
    });
  </script>
</body>
</html>
