<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{UI/layouts/admin/admin_layout}"
      >
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>취소/반품 관리</title>
</head>
<body layout:fragment="content">

  <div class="container-fluid">
    <!-- 페이지 헤더 -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
      <h1 class="h3 mb-0 text-gray-800">취소/반품 관리</h1>
      <a href="/admin/cancel/create" class="d-none d-sm-inline-block btn btn-primary shadow-sm">
        <i class="material-icons-two-tone">add</i>
        등록
      </a>
    </div>

    <!-- 취소/반품 목록 카드 -->
    <div class="card shadow mb-4">
      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">취소/반품 목록</h6>
        <div class="d-flex justify-content-end align-items-center">
          <span class="text-muted">total <strong th:text="${#numbers.formatInteger(pagination.total, 0, 'COMMA')}">0</strong></span>
        </div>
      </div>
      <div class="card-body">
        <!-- 검색 영역 -->
        <div class="row mb-3">
          <div class="col-md-3">
            <div class="input-group">
              <input type="text" class="form-control" id="searchInput" placeholder="검색어를 입력해주세요." th:value="${param.search}">
              <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                <i class="material-icons-two-tone">search</i> 검색
              </button>
            </div>
          </div>
          <div class="col-md-2">
            <div class="input-group">
              <label for="pageSizeSelect" class="input-group-text">
                <i class="material-icons-two-tone">view_list</i>
              </label>
              <select class="form-select" id="pageSizeSelect" onchange="changePageSize()" th:field="*{queryParams.size}">
                <option value="10" >10개씩 보기</option>
                <option value="20" >20개씩 보기</option>
                <option value="50" >50개씩 보기</option>
                <option value="100">100개씩 보기</option>
              </select>
            </div>
          </div>
          <div class="col-md-2">
            <div class="input-group">
                <label for="typeSelect" class="input-group-text">
                    <i class="material-icons-two-tone">filter_list</i>
                </label>
                <select class="form-select" id="typeSelect" onchange="changeType()">
                    <option value="">전체 유형</option>
                    <option value="주문취소" th:selected="${#strings.equals(param.type, '주문취소')}">주문취소</option>
                    <option value="반품" th:selected="${#strings.equals(param.type, '반품')}">반품</option>
                </select>
            </div>
            <script>
                function changeType() {
                    var type = document.getElementById("typeSelect").value;
                    var url = new URL(window.location.href);
                    if( !type ) {
                        url.searchParams.delete("type");
                        window.location.href = url.toString();    
                        return
                    }
                    url.searchParams.set("type", type);
                    window.location.href = url.toString();
                }
            </script>
          </div>
          <div class="col-md-2">
            <div class="input-group">
                <label for="statusSelect" class="input-group-text">
                    <i class="material-icons-two-tone">filter_list</i>
                </label>
                <select class="form-select" id="statusSelect" onchange="changeStatus()">
                    <option value="">전체 상태</option>
                    <option value="취소요청" th:selected="${#strings.equals(param.status, '취소요청')}">취소요청</option>
                    <option value="취소완료" th:selected="${#strings.equals(param.status, '취소완료')}">취소완료</option>
                </select>
            </div>
            <script>
                function changeStatus() {
                    var status = document.getElementById("statusSelect").value;
                    var url = new URL(window.location.href);
                    if( !status ) {
                        url.searchParams.delete("status");
                        window.location.href = url.toString();    
                        return
                    }
                    url.searchParams.set("status", status);
                    window.location.href = url.toString();
                }
            </script>
          </div>
          <div class="col-md-3 text-end">
            <div class="btn-group" role="group">
              <button type="button" class="btn btn-danger" id="deleteSelectedBtn" disabled>
                <i class="material-icons-two-tone">delete</i> 선택 삭제
              </button>
              <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary btn-sm dropdown-toggle" 
                        data-bs-toggle="dropdown" id="statusChangeBtn" disabled>
                    <i class="material-icons-two-tone">edit</i> 상태 변경
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="updateSelectedStatus('취소요청')">취소요청</a></li>
                    <li><a class="dropdown-item" href="#" onclick="updateSelectedStatus('취소완료')">취소완료</a></li>
                    <li><a class="dropdown-item" href="#" onclick="updateSelectedStatus('환불완료')">환불완료</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 테이블 -->
        <div class="">
          <table class="table table-bordered" id="cancellationTable">
            <thead class="table-light">
              <tr>
                <th width="2%">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="selectAll">
                  </div>
                </th>
                <th width="3%">번호</th>
                <th width="5%">주문코드</th>
                <th width="5%">취소유형</th>
                <th width="5%">처리상태</th>
                <th width="5%">취소사유</th>
                <th width="8%">신청일</th>
                <th width="5%">관리</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="cancellation, iterStat : ${pageInfo.list}">
                <td>
                  <div class="form-check">
                    <input class="form-check-input cancellation-checkbox" type="checkbox" 
                           th:value="${cancellation.id}" th:id="'check-' + ${cancellation.id}">
                  </div>
                </td>
                <td th:text="${iterStat.count}">1</td>
                <td th:text="${cancellation.order != null ? cancellation.order.code : 'N/A'}">20250101_001_001_001</td>
                <td>
                    <span class="badge p-2 fs-6 bg-warning" th:if="${cancellation.type == '주문취소'}">주문취소</span>
                    <span class="badge p-2 fs-6 bg-info" th:if="${cancellation.type == '반품'}">반품</span>
                </td>
                <td>
                    <span class="badge p-2 fs-6 bg-warning" th:if="${cancellation.status == '취소요청'}">취소요청</span>
                    <span class="badge p-2 fs-6 bg-success" th:if="${cancellation.status == '취소완료'}">취소완료</span>
                    <span class="badge p-2 fs-6 bg-primary" th:if="${cancellation.status == '환불완료'}">환불완료</span>
                    <!-- <span class="badge p-2 fs-6 bg-warning" th:if="${cancellation.isConfirmed == false}">접수</span>
                    <span class="badge p-2 fs-6 bg-info" th:if="${cancellation.isConfirmed == true and cancellation.isRefund == false}">처리중</span>
                    <span class="badge p-2 fs-6 bg-success" th:if="${cancellation.isRefund == true}">완료</span>
                    <span class="badge p-2 fs-6 bg-danger" th:if="${cancellation.isConfirmed == null}">거절</span> -->
                </td>
                <td th:text="${cancellation.reason}">고객 변심</td>
                <td th:text="${#dates.format(cancellation.createdAt, 'yyyy-MM-dd HH:mm')}">2024-01-01 10:00</td>
                <td>
                  <div class="dropdown">
                    <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton-[[${cancellation.no}]]" data-bs-toggle="dropdown" aria-expanded="false">
                      <i class="material-icons-two-tone">more_vert</i>
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton-[[${cancellation.id}]]">
                      <li>
                        <a class="dropdown-item" th:href="@{/admin/cancel/{id}(id=${cancellation.id})}">
                          수정
                        </a>
                      </li>
                      <li th:if="${cancellation.status != '환불완료'}">
                        <a href="javascript:;" class="dropdown-item text-info"
                           th:onclick="processRefund([[${cancellation.id}]], '[[${cancellation.reason}]]')">
                          환불처리
                        </a>
                      </li>
                      <li>
                        <a href="javascript:;" class="dropdown-item text-danger"
                           th:onclick="deleteCancellation([[${cancellation.no}]])">
                          삭제
                        </a>
                      </li>
                    </ul>
                  </div>
                </td>
              </tr>
              <!-- 데이터가 없을 때 -->
              <tr th:if="${#lists.isEmpty(pageInfo.list)}">
                <td colspan="9" class="text-center text-muted">등록된 취소/반품이 없습니다.</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- 페이지 -->
        <th:block th:replace="~{UI/fragments/common/page::page}"></th:block>

      </div>
    </div>
  </div>

  <script>
    // 전체 선택/해제
    document.getElementById('selectAll').addEventListener('change', function() {
      const checkboxes = document.querySelectorAll('.cancellation-checkbox');
      const isChecked = this.checked;
      
      checkboxes.forEach(function(checkbox) {
        checkbox.checked = isChecked;
      });
      
      updateDeleteButton();
    });

    // 개별 체크박스 변경 시
    document.addEventListener('change', function(e) {
      if (e.target.classList.contains('cancellation-checkbox')) {
        updateSelectAllState();
        updateDeleteButton();
      }
    });

    // 전체 선택 체크박스 상태 업데이트
    function updateSelectAllState() {
      const checkboxes = document.querySelectorAll('.cancellation-checkbox');
      const checkedBoxes = document.querySelectorAll('.cancellation-checkbox:checked');
      const selectAllCheckbox = document.getElementById('selectAll');
      
      if (checkedBoxes.length === 0) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = false;
      } else if (checkedBoxes.length === checkboxes.length) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = true;
      } else {
        selectAllCheckbox.indeterminate = true;
        selectAllCheckbox.checked = false;
      }
    }

    // 삭제 버튼 상태 업데이트
    function updateDeleteButton() {
      const checkedBoxes = document.querySelectorAll('.cancellation-checkbox:checked');
      const deleteBtn = document.getElementById('deleteSelectedBtn');
      const statusBtn = document.getElementById('statusChangeBtn');
      
      if (checkedBoxes.length > 0) {
        deleteBtn.disabled = false;
        deleteBtn.textContent = `선택 삭제 (${checkedBoxes.length})`;
        statusBtn.disabled = false;
        statusBtn.innerHTML = `<i class="material-icons-two-tone">edit</i> 상태 변경 (${checkedBoxes.length})`;
      } else {
        deleteBtn.disabled = true;
        deleteBtn.innerHTML = '<i class="material-icons-two-tone">delete</i> 선택 삭제';
        statusBtn.disabled = true;
        statusBtn.innerHTML = '<i class="material-icons-two-tone">edit</i> 상태 변경';
      }
    }

    // 선택 삭제 기능
    document.getElementById('deleteSelectedBtn').addEventListener('click', function() {
      const checkedBoxes = document.querySelectorAll('.cancellation-checkbox:checked');
      
      if (checkedBoxes.length === 0) {
        $alert('선택 오류', '삭제할 취소/반품을 선택해주세요.', 'warning');
        return;
      }

      const selectedIds = Array.from(checkedBoxes).map(checkbox => checkbox.value);
      
      $confirmHTML('선택 삭제', 
               `선택한 ${selectedIds.length}개의 취소/반품을 삭제하시겠습니까?<br><br><strong>주의:</strong> 삭제된 데이터는 복구할 수 없습니다.`, 
               'warning', '삭제', '취소')
      .then(function(result) {
        if (result.isConfirmed) {
          deleteSelectedCancellations(selectedIds);
        }
      });
    });

    // 선택된 취소/반품들 삭제
    function deleteSelectedCancellations(cancellationIds) {
      let successCount = 0;
      let failCount = 0;
      let totalCount = cancellationIds.length;

      // 로딩 상태 표시
      const deleteBtn = document.getElementById('deleteSelectedBtn');
      deleteBtn.disabled = true;
      deleteBtn.innerHTML = '<i class="spinner-border spinner-border-sm" role="status"></i> 삭제 중...';

      // 순차적으로 삭제 요청
      const deletePromises = cancellationIds.map(cancellationId => {
        return $ajax({
          url: '/api/shop/cancellation/' + cancellationId,
          type: 'DELETE'
        }).then(() => {
          successCount++;
        }).catch(() => {
          failCount++;
        });
      });

      // 모든 삭제 요청 완료 후 결과 표시
      Promise.all(deletePromises).then(() => {
        if (failCount === 0) {
          $alert('삭제 완료', `${successCount}개의 취소/반품이 삭제되었습니다.`, 'success').then(() => {
            window.location.reload();
          });
        } else if (successCount === 0) {
          $alert('삭제 실패', '취소/반품 삭제에 실패했습니다.', 'error');
        } else {
          $alert('부분 삭제', 
                 `${successCount}개 삭제 성공, ${failCount}개 삭제 실패했습니다.`, 
                 'warning').then(() => {
            window.location.reload();
          });
        }
        
        // 버튼 상태 복원
        updateDeleteButton();
      });
    }

    // 선택된 취소/반품들 상태 변경
    function updateSelectedStatus(status) {
      const checkedBoxes = document.querySelectorAll('.cancellation-checkbox:checked');
      
      if (checkedBoxes.length === 0) {
        $alert('선택 오류', '상태를 변경할 취소/반품을 선택해주세요.', 'warning');
        return;
      }

      const selectedIds = Array.from(checkedBoxes).map(checkbox => checkbox.value);
      
      $confirmHTML('상태 변경', 
               `선택한 ${selectedIds.length}개의 취소/반품 상태를 '${status}'로 변경하시겠습니까?`, 
               'question', '변경', '취소')
      .then(function(result) {
        if (result.isConfirmed) {
          updateSelectedCancellations(selectedIds, status);
        }
      });
    }

    // 선택된 취소/반품들 상태 업데이트 실행
    function updateSelectedCancellations(cancellationIds, status) {
      let successCount = 0;
      let failCount = 0;
      // 로딩 상태 표시
      const statusBtn = document.getElementById('statusChangeBtn');
      statusBtn.disabled = true;
      statusBtn.innerHTML = '<i class="spinner-border spinner-border-sm" role="status"></i> 변경 중...';

      // 순차적으로 상태 변경 요청
      const updatePromises = cancellationIds.map(cancellationId => {
        return $ajax({
          url: '/api/shop/cancellation',
          type: 'PUT',
          data: { id: cancellationId, status: status }
        }).then(() => {
          successCount++;
        }).catch(() => {
          failCount++;
        });
      });

      // 모든 상태 변경 요청 완료 후 결과 표시
      Promise.all(updatePromises).then(() => {
        if (failCount === 0) {
          $alert('상태 변경 완료', `${successCount}개의 취소/반품 상태가 '${status}'로 변경되었습니다.`, 'success').then(() => {
            window.location.reload();
          });
        } else if (successCount === 0) {
          $alert('상태 변경 실패', '취소/반품 상태 변경에 실패했습니다.', 'error');
        } else {
          $alert('부분 변경', 
                 `${successCount}개 변경 성공, ${failCount}개 변경 실패했습니다.`, 
                 'warning').then(() => {
            window.location.reload();
          });
        }
        
        // 버튼 상태 복원
        updateDeleteButton();
      });
    }

    // 페이지 크기 변경 기능
    function changePageSize() {
      const pageSize = document.getElementById('pageSizeSelect').value;
      const url = new URL(window.location.href);
      url.searchParams.set('size', pageSize);
      url.searchParams.delete('page'); // 페이지 크기 변경 시 첫 페이지로 이동
      window.location.href = url.toString();
    }

    // 검색 기능
    document.getElementById('searchBtn').addEventListener('click', function() {
      const searchValue = document.getElementById('searchInput').value;
      if (searchValue.trim()) {
        const url = new URL(window.location.href);
        url.searchParams.set('search', searchValue);
        window.location.href = url.toString();
      }
    });

    // Enter 키 검색
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        document.getElementById('searchBtn').click();
      }
    });

    // 삭제 기능
    function deleteCancellation(cancellationId) {
      $confirmHTML('취소/반품 삭제', 
                   '정말로 이 취소/반품을 삭제하시겠습니까?<br><br><strong>주의:</strong> 삭제된 데이터는 복구할 수 없습니다.', 
                   'warning', '삭제', '취소')
      .then(function(result) {
        if (result.isConfirmed) {
          $ajax({
            url: '/api/shop/cancellation/' + cancellationId,
            type: 'DELETE'
          })
          .then(function() {
            $toast_({ title: '취소/반품이 삭제되었습니다.', icon: 'success', timer: 1500 }).then(() => {
              window.location.reload();
            });
          })
          .catch(function() {
            $alert('오류', '삭제 중 오류가 발생했습니다.', 'error');
          });
        }
      });
    }

    // 환불 처리 기능
    function processRefund(cancellationId, defaultReason) {
      Swal.fire({
        title: '환불 처리',
        html: `
          <div class="text-start">
            <div class="mb-3">
              <label for="cancelReason" class="form-label">환불 사유</label>
              <textarea class="form-control" id="cancelReason" rows="3" placeholder="환불 사유를 입력해주세요.">${defaultReason || ''}</textarea>
            </div>
            <div class="mb-3">
              <label for="cancelAmount" class="form-label">환불 금액 (선택사항)</label>
              <input type="number" class="form-control" id="cancelAmount" placeholder="전체 환불은 비워두세요">
              <div class="form-text">부분 환불을 원하시면 금액을 입력하세요. 비워두면 전체 환불됩니다.</div>
            </div>
          </div>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: '환불처리',
        cancelButtonText: '취소',
        confirmButtonColor: '#007bff',
        preConfirm: () => {
          const reason = document.getElementById('cancelReason').value.trim();
          if (!reason) {
            Swal.showValidationMessage('환불 사유를 입력해주세요.');
            return false;
          }
          return {
            cancelReason: reason,
            cancelAmount: document.getElementById('cancelAmount').value || null
          };
        }
      }).then((result) => {
        if (result.isConfirmed) {
          const refundData = {
            cancellationId: cancellationId,
            cancelReason: result.value.cancelReason,
            cancelAmount: result.value.cancelAmount
          };

          // 로딩 표시
          Swal.fire({
            title: '환불 처리 중...',
            text: '토스페이먼츠 환불 API를 호출하고 있습니다.',
            allowOutsideClick: false,
            showConfirmButton: false,
            willOpen: () => {
              Swal.showLoading();
            }
          });

          $ajax({
            url: '/api/shop/cancellation/refund',
            type: 'POST',
            data: refundData
          })
          .then(function(response) {
            if (response.success) {
              Swal.fire({
                title: '환불 완료',
                text: '환불이 성공적으로 처리되었습니다.',
                icon: 'success',
                timer: 2000
              }).then(() => {
                window.location.reload();
              });
            } else {
              Swal.fire({
                title: '환불 실패',
                text: response.message || '환불 처리에 실패했습니다.',
                icon: 'error'
              });
            }
          })
          .catch(function(xhr) {
            let errorMessage = '환불 처리 중 오류가 발생했습니다.';
            
            if (xhr.responseJSON) {
              errorMessage = xhr.responseJSON.message || errorMessage;
            } else if (xhr.responseText) {
              try {
                const errorResponse = JSON.parse(xhr.responseText);
                errorMessage = errorResponse.message || errorMessage;
              } catch (e) {
                errorMessage = xhr.responseText;
              }
            }

            Swal.fire({
              title: '환불 처리 실패',
              text: errorMessage,
              icon: 'error'
            });
          });
        }
      });
    }

    // 전역 함수 등록 (onclick에서 사용하기 위해)
    window.deleteCancellation = deleteCancellation;
    window.processRefund = processRefund;
    window.updateSelectedStatus = updateSelectedStatus;
  </script>

</body>
</html>
