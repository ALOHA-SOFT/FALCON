<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{UI/layouts/admin/admin_layout}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>이메일 템플릿 관리</title>
</head>
<body layout:fragment="content">

  <div class="container-fluid">
    <!-- 페이지 헤더 -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
      <h1 class="h3 mb-0 text-gray-800">이메일 템플릿 관리</h1>
      <a href="/admin/email-template/create" class="d-none d-sm-inline-block btn btn-primary shadow-sm">
        <i class="material-icons-two-tone">add</i>
        템플릿 등록
      </a>
    </div>

    <!-- 템플릿 목록 카드 -->
    <div class="card shadow mb-4">
      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">이메일 템플릿 목록</h6>
        <div class="d-flex justify-content-end align-items-center">
          <span class="text-muted">total <strong th:text="${#numbers.formatInteger(pagination.total, 0, 'COMMA')}">0</strong></span>
        </div>
      </div>
      <div class="card-body">
        <!-- 검색 영역 -->
        <div class="row mb-3">
          <div class="col-md-4">
            <div class="input-group">
              <input type="text" class="form-control" id="searchInput" placeholder="템플릿명 또는 타입 검색" th:value="${param.search}">
              <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                <i class="material-icons-two-tone">search</i> 검색
              </button>
            </div>
          </div>
          <div class="col-md-3">
            <select class="form-select" id="statusFilter">
              <option value="">전체 상태</option>
              <option value="true">활성화</option>
              <option value="false">비활성화</option>
            </select>
          </div>
          <div class="col-md-3">
            <select class="form-select" id="typeFilter">
              <option value="">전체 타입</option>
              <option value="ORDER_CONFIRMATION">주문 확인</option>
              <option value="PAYMENT_GUIDE">결제 안내</option>
              <option value="TEMP_PASSWORD">임시 비밀번호</option>
            </select>
          </div>
          <div class="col-md-2">
            <select class="form-select" id="pageSizeSelect" onchange="changePageSize()">
              <option value="10">10개씩</option>
              <option value="20">20개씩</option>
              <option value="50">50개씩</option>
            </select>
          </div>
        </div>

        <!-- 테이블 -->
        <div class="">
          <table class="table table-bordered" id="templateTable">
            <thead class="table-light">
              <tr>
                <th width="3%">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="selectAll">
                  </div>
                </th>
                <th width="8%">상태</th>
                <th width="15%">템플릿명</th>
                <th width="12%">타입</th>
                <th width="25%">제목</th>
                <th width="15%">등록일시</th>
                <th width="15%">수정일시</th>
                <th width="12%">관리</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="template, iterStat : ${pageInfo.list}">
                <td>
                  <div class="form-check">
                    <input class="form-check-input template-checkbox" type="checkbox" 
                           th:value="${template.id}" th:id="'check-' + ${template.id}">
                  </div>
                </td>
                <td>
                  <span class="badge" 
                        th:classappend="${template.isActive} ? 'bg-success' : 'bg-secondary'"
                        th:text="${template.isActive} ? '활성화' : '비활성화'">
                    활성화
                  </span>
                </td>
                <td th:text="${template.name}">주문 확인 템플릿</td>
                <td>
                  <span class="badge bg-info" th:text="${template.type}">ORDER_CONFIRMATION</span>
                </td>
                <td th:text="${template.subject}">주문이 접수되었습니다</td>
                <td th:text="${#dates.format(template.createdAt, 'yyyy-MM-dd HH:mm')}">2024-01-01 10:00</td>
                <td th:text="${#dates.format(template.updatedAt, 'yyyy-MM-dd HH:mm')}">2024-01-01 10:00</td>
                <td>
                  <div class="dropdown">
                    <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" 
                            th:id="'dropdownMenuButton-' + ${template.id}" data-bs-toggle="dropdown" aria-expanded="false">
                      <i class="material-icons-two-tone">more_vert</i>
                    </button>
                    <ul class="dropdown-menu" th:aria-labelledby="'dropdownMenuButton-' + ${template.id}">
                      <li>
                        <a class="dropdown-item" th:href="@{'/admin/email-template/' + ${template.id}}">
                          수정
                        </a>
                      </li>
                      <li>
                        <a class="dropdown-item" href="#" th:onclick="toggleStatus([[${template.id}]])">
                          <span th:text="${template.isActive} ? '비활성화' : '활성화'">상태변경</span>
                        </a>
                      </li>
                      <li>
                        <a class="dropdown-item" href="#" th:onclick="previewTemplate( [[${template.id}]] )">
                          미리보기
                        </a>
                      </li>
                      <li><hr class="dropdown-divider"></li>
                      <li>
                        <a class="dropdown-item text-danger" href="#" th:onclick="deleteTemplate( [[${template.id}]] )">
                          삭제
                        </a>
                      </li>
                    </ul>
                  </div>
                </td>
              </tr>
              <tr th:if="${#lists.isEmpty(pageInfo.list)}">
                <td colspan="8" class="text-center py-4">
                  <div class="text-muted">
                    <i class="material-icons-two-tone" style="font-size: 48px;">description</i>
                    <p class="mt-2">등록된 이메일 템플릿이 없습니다.</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- 페이지 -->
        <th:block th:replace="~{UI/fragments/common/page::page}"></th:block>

      </div>
    </div>
  </div>

  <!-- 미리보기 모달 -->
  <div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">템플릿 미리보기</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="previewContent">
            <!-- 미리보기 내용 -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
        // 전체 선택/해제
        const selectAllCheckbox = document.getElementById('selectAll');
        const templateCheckboxes = document.querySelectorAll('.template-checkbox');
        
        selectAllCheckbox.addEventListener('change', function() {
            templateCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });

        // 검색 기능
        document.getElementById('searchBtn').addEventListener('click', function() {
            performSearch();
        });

        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        // 필터 기능
        document.getElementById('statusFilter').addEventListener('change', function() {
            performSearch();
        });

        document.getElementById('typeFilter').addEventListener('change', function() {
            performSearch();
        });
    });

    function performSearch() {
        const searchValue = document.getElementById('searchInput').value;
        const statusValue = document.getElementById('statusFilter').value;
        const typeValue = document.getElementById('typeFilter').value;
        
        const params = new URLSearchParams();
        if (searchValue) params.append('search', searchValue);
        if (statusValue) params.append('isActive', statusValue);
        if (typeValue) params.append('type', typeValue);
        
        window.location.href = '/admin/email-template?' + params.toString();
    }

    function changePageSize() {
        const size = document.getElementById('pageSizeSelect').value;
        const params = new URLSearchParams(window.location.search);
        params.set('size', size);
        params.set('page', '1');
        window.location.href = '/admin/email-template?' + params.toString();
    }

    function toggleStatus(templateId) {
        $confirm('확인', '템플릿 상태를 변경하시겠습니까?', 'question', '변경', '취소').then(function(result) {
            if (result.isConfirmed) {
                $ajax({
                    url: `/api/admin/email-template/${templateId}/toggle-active`,
                    type: 'PUT',
                    data: {}
                }).then(function(response) {
                    if (response === 'SUCCESS' || response.status == 200) {
                        $alert('성공', '상태가 변경되었습니다.', 'success').then(() => {
                            location.reload();
                        });
                    } else {
                        $alert('실패', '상태 변경에 실패했습니다.', 'error');
                    }
                }).catch(function() {
                    $alert('오류', '상태 변경에 실패했습니다.', 'error');
                });
            }
        });
    }

    function previewTemplate(templateId) {
        $ajax({
            url: `/api/admin/email-template/${templateId}`,
            type: 'GET',
            data: {}
        }).then(function(template) {
            const previewContent = document.getElementById('previewContent');
            
            let content = `
                <div class="mb-3">
                    <strong>템플릿명:</strong> ${template.name}
                </div>
                <div class="mb-3">
                    <strong>타입:</strong> <span class="badge bg-info">${template.type}</span>
                </div>
                <div class="mb-3">
                    <strong>제목:</strong> ${template.subject}
                </div>
                <div class="mb-3">
                    <strong>내용:</strong>
                    <div class="border p-3 mt-2">
            `;
            
            if (template.isHtml) {
                content += template.content;
            } else {
                content += `<pre style="white-space: pre-wrap;">${template.content}</pre>`;
            }
            
            content += `
                    </div>
                </div>
                <div class="mb-3">
                    <strong>사용 가능한 변수:</strong> 
                    <code>${template.variables || '없음'}</code>
                </div>
            `;
            
            previewContent.innerHTML = content;
            
            const modal = new bootstrap.Modal(document.getElementById('previewModal'));
            modal.show();
        }).catch(function() {
            $alert('오류', '템플릿을 불러오는데 실패했습니다.', 'error');
        });
    }

    function deleteTemplate(templateId) {
        $confirm('확인', '템플릿을 삭제하시겠습니까?', 'warning', '삭제', '취소').then(function(result) {
            if (result.isConfirmed) {
                $ajax({
                    url: `/api/admin/email-template/${templateId}`,
                    type: 'DELETE',
                    data: {}
                }).then(function(response) {
                    if (response === 'SUCCESS' || response.status == 200) {
                        $alert('성공', '삭제되었습니다.', 'success').then(() => {
                            location.reload();
                        });
                    } else {
                        $alert('실패', '삭제에 실패했습니다.', 'error');
                    }
                }).catch(function() {
                    $alert('오류', '삭제에 실패했습니다.', 'error');
                });
            }
        });
    }
  </script>

</body>
</html>
