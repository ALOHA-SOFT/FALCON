<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{UI/layouts/admin/admin_layout}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì´ë©”ì¼ í…œí”Œë¦¿ ê´€ë¦¬</title>
</head>
<body layout:fragment="content">

  <div class="container-fluid">
    <!-- í˜ì´ì§€ í—¤ë” -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
      <h1 class="h3 mb-0 text-gray-800">ì´ë©”ì¼ í…œí”Œë¦¿ ê´€ë¦¬</h1>
      <a href="/admin/email-template/create" class="d-none d-sm-inline-block btn btn-primary shadow-sm">
        <i class="material-icons-two-tone">add</i>
        í…œí”Œë¦¿ ë“±ë¡
      </a>
    </div>

    <!-- í…œí”Œë¦¿ ëª©ë¡ ì¹´ë“œ -->
    <div class="card shadow mb-4">
      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">ì´ë©”ì¼ í…œí”Œë¦¿ ëª©ë¡</h6>
        <div class="d-flex justify-content-end align-items-center">
          <span class="text-muted">total <strong th:text="${#numbers.formatInteger(pagination.total, 0, 'COMMA')}">0</strong></span>
        </div>
      </div>
      <div class="card-body">
        <!-- ê²€ìƒ‰ ì˜ì—­ -->
        <div class="row mb-3">
          <div class="col-md-4">
            <div class="input-group">
              <input type="text" class="form-control" id="searchInput" placeholder="í…œí”Œë¦¿ëª… ë˜ëŠ” íƒ€ì… ê²€ìƒ‰" th:value="${param.search}">
              <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                <i class="material-icons-two-tone">search</i> ê²€ìƒ‰
              </button>
            </div>
          </div>
          <div class="col-md-3">
            <select class="form-select" id="statusFilter">
              <option value="">ì „ì²´ ìƒíƒœ</option>
              <option value="true">í™œì„±í™”</option>
              <option value="false">ë¹„í™œì„±í™”</option>
            </select>
          </div>
          <div class="col-md-3">
            <select class="form-select" id="typeFilter">
              <option value="">ì „ì²´ íƒ€ì…</option>
              <option value="ORDER_CONFIRMATION">ì£¼ë¬¸ í™•ì¸</option>
              <option value="PAYMENT_GUIDE">ê²°ì œ ì•ˆë‚´</option>
              <option value="TEMP_PASSWORD">ì„ì‹œ ë¹„ë°€ë²ˆí˜¸</option>
            </select>
          </div>
          <div class="col-md-2">
            <select class="form-select" id="pageSizeSelect" onchange="changePageSize()">
              <option value="10">10ê°œì”©</option>
              <option value="20">20ê°œì”©</option>
              <option value="50">50ê°œì”©</option>
            </select>
          </div>
        </div>

        <!-- í…Œì´ë¸” -->
        <div class="">
          <table class="table table-bordered" id="templateTable">
            <thead class="table-light">
              <tr>
                <th width="3%">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="selectAll">
                  </div>
                </th>
                <th width="8%">ìƒíƒœ</th>
                <th width="15%">í…œí”Œë¦¿ëª…</th>
                <th width="12%">íƒ€ì…</th>
                <th width="25%">ì œëª©</th>
                <th width="15%">ë“±ë¡ì¼ì‹œ</th>
                <th width="15%">ìˆ˜ì •ì¼ì‹œ</th>
                <th width="12%">ê´€ë¦¬</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="template, iterStat : ${pageInfo.list}">
                <td>
                  <div class="form-check">
                    <input class="form-check-input template-checkbox" type="checkbox" 
                           th:value="${template.id}" th:id="'check-' + ${template.id}">
                  </div>
                </td>
                <td>
                  <span class="badge" 
                        th:classappend="${template.isActive} ? 'bg-success' : 'bg-secondary'"
                        th:text="${template.isActive} ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'">
                    í™œì„±í™”
                  </span>
                </td>
                <td th:text="${template.name}">ì£¼ë¬¸ í™•ì¸ í…œí”Œë¦¿</td>
                <td>
                  <span class="badge bg-info" th:text="${template.type}">ORDER_CONFIRMATION</span>
                </td>
                <td th:text="${template.subject}">ì£¼ë¬¸ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤</td>
                <td th:text="${#dates.format(template.createdAt, 'yyyy-MM-dd HH:mm')}">2024-01-01 10:00</td>
                <td th:text="${#dates.format(template.updatedAt, 'yyyy-MM-dd HH:mm')}">2024-01-01 10:00</td>
                <td>
                  <div class="dropdown">
                    <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" 
                            th:id="'dropdownMenuButton-' + ${template.id}" data-bs-toggle="dropdown" aria-expanded="false">
                      <i class="material-icons-two-tone">more_vert</i>
                    </button>
                    <ul class="dropdown-menu" th:aria-labelledby="'dropdownMenuButton-' + ${template.id}">
                      <li>
                        <a class="dropdown-item" th:href="@{'/admin/email-template/' + ${template.id}}">
                          ìˆ˜ì •
                        </a>
                      </li>
                      <li>
                        <a class="dropdown-item" href="#" th:onclick="toggleStatus([[${template.id}]])">
                          <span th:text="${template.isActive} ? 'ë¹„í™œì„±í™”' : 'í™œì„±í™”'">ìƒíƒœë³€ê²½</span>
                        </a>
                      </li>
                      <li>
                        <a class="dropdown-item" href="#" th:onclick="previewTemplate( [[${template.id}]] )">
                          ë¯¸ë¦¬ë³´ê¸°
                        </a>
                      </li>
                      <li><hr class="dropdown-divider"></li>
                      <li>
                        <a class="dropdown-item text-danger" href="#" th:onclick="deleteTemplate( [[${template.id}]] )">
                          ì‚­ì œ
                        </a>
                      </li>
                    </ul>
                  </div>
                </td>
              </tr>
              <tr th:if="${#lists.isEmpty(pageInfo.list)}">
                <td colspan="8" class="text-center py-4">
                  <div class="text-muted">
                    <i class="material-icons-two-tone" style="font-size: 48px;">description</i>
                    <p class="mt-2">ë“±ë¡ëœ ì´ë©”ì¼ í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- í˜ì´ì§€ -->
        <th:block th:replace="~{UI/fragments/common/page::page}"></th:block>

      </div>
    </div>
  </div>

  <!-- ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
  <div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">í…œí”Œë¦¿ ë¯¸ë¦¬ë³´ê¸°</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="previewContent">
            <!-- ë¯¸ë¦¬ë³´ê¸° ë‚´ìš© -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
        // ì „ì²´ ì„ íƒ/í•´ì œ
        const selectAllCheckbox = document.getElementById('selectAll');
        const templateCheckboxes = document.querySelectorAll('.template-checkbox');
        
        selectAllCheckbox.addEventListener('change', function() {
            templateCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });

        // ê²€ìƒ‰ ê¸°ëŠ¥
        document.getElementById('searchBtn').addEventListener('click', function() {
            performSearch();
        });

        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        // í•„í„° ê¸°ëŠ¥
        document.getElementById('statusFilter').addEventListener('change', function() {
            performSearch();
        });

        document.getElementById('typeFilter').addEventListener('change', function() {
            performSearch();
        });
    });

    function performSearch() {
        const searchValue = document.getElementById('searchInput').value;
        const statusValue = document.getElementById('statusFilter').value;
        const typeValue = document.getElementById('typeFilter').value;
        
        const params = new URLSearchParams();
        if (searchValue) params.append('search', searchValue);
        if (statusValue) params.append('isActive', statusValue);
        if (typeValue) params.append('type', typeValue);
        
        window.location.href = '/admin/email-template?' + params.toString();
    }

    function changePageSize() {
        const size = document.getElementById('pageSizeSelect').value;
        const params = new URLSearchParams(window.location.search);
        params.set('size', size);
        params.set('page', '1');
        window.location.href = '/admin/email-template?' + params.toString();
    }

    function toggleStatus(templateId) {
        $confirm('í™•ì¸', 'í…œí”Œë¦¿ ìƒíƒœë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', 'question', 'ë³€ê²½', 'ì·¨ì†Œ').then(function(result) {
            if (result.isConfirmed) {
                $ajax({
                    url: `/api/admin/email-template/${templateId}/toggle-active`,
                    type: 'PUT',
                    data: {}
                }).then(function(response) {
                    if (response === 'SUCCESS' || response.status == 200) {
                        $alert('ì„±ê³µ', 'ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success').then(() => {
                            location.reload();
                        });
                    } else {
                        $alert('ì‹¤íŒ¨', 'ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    }
                }).catch(function() {
                    $alert('ì˜¤ë¥˜', 'ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                });
            }
        });
    }

    function previewTemplate(templateId) {
        $ajax({
            url: `/api/admin/email-template/${templateId}`,
            type: 'GET',
            data: {}
        }).then(function(template) {
            // íŒì—…ì°½ìœ¼ë¡œ ì´ë©”ì¼ í…œí”Œë¦¿ ë¯¸ë¦¬ë³´ê¸°
            const popupWindow = window.open('', 'emailPreview', 'width=800,height=600,scrollbars=yes,resizable=yes');
            
            let content = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>ì´ë©”ì¼ í…œí”Œë¦¿ ë¯¸ë¦¬ë³´ê¸° - ${template.name}</title>
                    <style>
                        body { 
                            font-family: Arial, sans-serif; 
                            margin: 20px; 
                            background-color: #f8f9fa;
                        }
                        .template-info {
                            background: white;
                            padding: 20px;
                            border-radius: 8px;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                            margin-bottom: 20px;
                        }
                        .template-content {
                            background: white;
                            border-radius: 8px;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        }
                        .badge {
                            background-color: #17a2b8;
                            color: white;
                            padding: 4px 8px;
                            border-radius: 4px;
                            font-size: 12px;
                        }
                        .btn-close {
                            position: fixed;
                            top: 10px;
                            right: 10px;
                            background: #dc3545;
                            color: white;
                            border: none;
                            padding: 8px 12px;
                            border-radius: 4px;
                            cursor: pointer;
                        }
                        .btn-close:hover {
                            background: #c82333;
                        }
                        pre {
                            white-space: pre-wrap;
                            background: #f8f9fa;
                            padding: 15px;
                            border-radius: 4px;
                            border: 1px solid #dee2e6;
                        }
                    </style>
                </head>
                <body>
                    <button class="btn-close" onclick="window.close()">âœ• ë‹«ê¸°</button>
                    
                    <div class="template-info">
                        <h2>ğŸ“§ ${template.name}</h2>
                        <div style="margin: 10px 0;">
                            <strong>íƒ€ì…:</strong> <span class="badge">${template.type}</span>
                        </div>
                        <div style="margin: 10px 0;">
                            <strong>ì œëª©:</strong> ${template.subject}
                        </div>
                        <div style="margin: 10px 0;">
                            <strong>ì‚¬ìš© ê°€ëŠ¥í•œ ë³€ìˆ˜:</strong> 
                            <code>${template.variables || 'ì—†ìŒ'}</code>
                        </div>
                    </div>
                    
                    <div class="template-content">
            `;
            
            if (template.isHtml) {
                content += `${template.content}`;
            } else {
                content += `<pre>${template.content}</pre>`;
            }
            
            content += `
                    </div>
                </body>
                </html>
            `;
            
            popupWindow.document.write(content);
            popupWindow.document.close();
            popupWindow.focus();
            
        }).catch(function() {
            $alert('ì˜¤ë¥˜', 'í…œí”Œë¦¿ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        });
    }

    function deleteTemplate(templateId) {
        $confirm('í™•ì¸', 'í…œí”Œë¦¿ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', 'warning', 'ì‚­ì œ', 'ì·¨ì†Œ').then(function(result) {
            if (result.isConfirmed) {
                $ajax({
                    url: `/api/admin/email-template/${templateId}`,
                    type: 'DELETE',
                    data: {}
                }).then(function(response) {
                    if (response === 'SUCCESS' || response.status == 200) {
                        $alert('ì„±ê³µ', 'ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success').then(() => {
                            location.reload();
                        });
                    } else {
                        $alert('ì‹¤íŒ¨', 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    }
                }).catch(function() {
                    $alert('ì˜¤ë¥˜', 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                });
            }
        });
    }
  </script>

</body>
</html>
