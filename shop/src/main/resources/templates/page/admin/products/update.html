<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{UI/layouts/admin/admin_layout}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>상품 수정</title>
</head>
<body layout:fragment="content">

  <div class="container-fluid">
    <!-- 페이지 헤더 -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
      <h1 class="h3 mb-0 text-gray-800">상품 수정</h1>
      <a href="/admin/products" class="d-none d-sm-inline-block btn btn-sm btn-secondary shadow-sm">
        <i class="fas fa-list fa-sm text-white-50"></i> 목록으로
      </a>
    </div>

    <!-- 수정 폼 카드 -->
    <div class="card shadow mb-4">
      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">상품 정보 수정</h6>
      </div>
      <div class="card-body">
        <form id="productForm" class="needs-validation" novalidate>
          <!-- CSRF TOKEN -->
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
          <input type="hidden" id="id" name="id" th:value="${product.id}">

          <div class="row">
            <div class="col-md-8">
              <!-- 상품명 -->
              <div class="mb-3">
                <label for="name" class="form-label">상품명 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="name" name="name" 
                       th:value="${product.name}" required maxlength="200">
                <div class="invalid-feedback">상품명을 입력해주세요.</div>
              </div>

              <!-- 카테고리 -->
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="categoryNo" class="form-label">카테고리 <span class="text-danger">*</span></label>
                    <select class="form-select" id="categoryNo" name="categoryNo">
                      <option value="">카테고리 선택</option>
                      <option th:each="category : ${categories}" 
                              th:value="${category.no}" 
                              th:text="${category.name}"
                              th:selected="${category.no == product.categoryNo}"></option>
                    </select>
                    <div class="invalid-feedback">카테고리를 선택해주세요.</div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="categoryLargeNo" class="form-label">대분류</label>
                    <select class="form-select" id="categoryLargeNo" name="categoryLargeNo">
                        <option value="">대분류 선택</option>
                        <option th:each="large : ${categoryLargeList}"
                            th:value="${large.no}"
                            th:text="${large.name}"
                            th:selected="${large.no == product.categoryLargeNo}">
                        </option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- 가격 정보 -->
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="price" class="form-label">판매가격 <span class="text-danger">*</span></label>
                    <div class="input-group">
                      <input type="text" class="form-control" id="price" name="price" 
                             min="0" th:value="${product.price}" required>
                      <span class="input-group-text">원</span>
                    </div>
                    <div class="invalid-feedback">판매가격을 입력해주세요.</div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="shipPrice" class="form-label">배송비</label>
                    <div class="input-group">
                      <input type="number" class="form-control" id="shipPrice" name="shipPrice" 
                             min="0" th:value="${product.shipPrice ?: 0}">
                      <span class="input-group-text">원</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 재고 및 배송 -->
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="stock" class="form-label">재고수량 <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="stock" name="stock" 
                           min="0" th:value="${product.stock}" required>
                    <div class="invalid-feedback">재고수량을 입력해주세요.</div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="shipMsg" class="form-label">배송안내</label>
                    <input type="text" class="form-control" id="shipMsg" name="shipMsg" 
                           th:value="${product.shipMsg}" maxlength="200" 
                           placeholder="예: 평일 2-3일, 주말/공휴일 제외">
                  </div>
                </div>
              </div>

              <!-- 가격 설명 -->
              <div class="mb-3">
                <label for="summary" class="form-label">가격 설명</label>
                <input type="text" class="form-control" id="priceInfo" name="priceInfo" th:value="${product.priceInfo}" maxlength="200" placeholder="50,000~2,500,000원">
                <div class="form-text">상품 목록에 노출될 가격 설명을 써주세요.</div>
              </div>

              <!-- 상품 정보 -->
              <div class="mb-3">
                <label for="summary" class="form-label">상품정보 요약</label>
                <textarea class="form-control" id="summary" name="summary" rows="3" 
                          maxlength="500" th:text="${product.summary}" 
                          placeholder="상품의 주요 특징을 간단히 요약해주세요"></textarea>
                <div class="form-text">최대 500자까지 입력 가능합니다.</div>
              </div>

              <div class="mb-3">
                <label for="fm_post" class="form-label">상품상세</label>
                <!-- CHEditor 영역 -->
                <textarea id="fm_post" name="content" th:text="${product.content}"></textarea>
                <div class="form-text">최대 5000자까지 입력 가능합니다.</div>
              </div>

              <!-- 상품 태그 -->
              <div class="row">
                <div class="col-md-4">
                  <div class="mb-3">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="isNew" name="isNew" 
                             value="true" th:checked="${product.isNew}">
                      <label class="form-check-label" for="isNew">
                        NEW 상품
                      </label>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="mb-3">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="isBest" name="isBest" 
                             value="true" th:checked="${product.isBest}">
                      <label class="form-check-label" for="isBest">
                        BEST 상품
                      </label>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="mb-3">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="isSoldOut" name="isSoldOut" 
                             value="true" th:checked="${product.isSoldOut}">
                      <label class="form-check-label" for="isSoldOut">
                        품절 상품
                      </label>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- 버튼 영역 -->
              <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <button type="button" class="btn btn-secondary me-md-2" onclick="history.back()">취소</button>
                <button type="button" class="btn btn-outline-danger me-md-2" onclick="deleteProduct()">삭제</button>
                <button type="submit" class="btn btn-primary">수정</button>
              </div>
            </div>
            
            <!-- 도움말 영역 -->
            <div class="col-md-4">

              <!-- 미디어 관리 카드 -->
              <div class="card mb-3">
                <div class="card-body">
                  <h6 class="card-title">
                    <i class="fas fa-images"></i> 미디어 관리
                  </h6>
                  <p class="card-text">상품 이미지 및 미디어 파일을 관리하세요.</p>
                  <div class="d-grid gap-2">
                    <a th:href="@{/admin/products/{id}/media(id=${product.id})}" 
                       class="btn btn-lg btn-outline-primary">
                      <i class="fas fa-edit"></i> 미디어 관리
                    </a>
                  </div>
                </div>
              </div>

              <!-- 옵션 그룹 선택 -->
              <div class="mb-3">
                <label for="optionGroupNo" class="form-label">옵션 그룹</label>
                <select class="form-select" id="optionGroupNo" name="optionGroupNo" onchange="onOptionGroupChange(this)">
                  <option value="">옵션 그룹 선택</option>
                    <option th:each="group : ${optionGroups}" th:value="${group.no}" th:text="${group.name}" th:selected="${group.no == product.optionGroupNo}"></option>
                </select>
                <!-- 옵션 목록 표시 영역 -->
                <div id="optionGroupOptions" class="mt-2 card py-3"></div>
                <script th:inline="javascript">

                  let optionGroups = [[${optionGroups}]];
                  /* [{"no":1,"id":"c593fe3b-d4a2-497e-9797-f15cacb0eb11","createdAt":"2025-07-04T07:18:23.000+09:00","updatedAt":"2025-07-04T07:18:23.000+09:00","name":"\uC635\uC158 A","options":[{"no":1,"id":"00de8dc2-e9ea-4cd8-b43d-4a678ebd5b3d","createdAt":"2025-07-04T07:18:43.000+09:00","updatedAt":"2025-07-04T07:18:58.000+09:00","groupNo":1,"name":"A-1","price":10000,"stock":100,"optionGroup":null},{"no":2,"id":"86074355-a1d6-4ad5-bd1f-5ddd81eea442","createdAt":"2025-07-04T07:19:07.000+09:00","updatedAt":"2025-07-04T07:19:07.000+09:00","groupNo":1,"name":"A-2","price":20000,"stock":123,"optionGroup":null},{"no":3,"id":"65e94a8b-8fbd-4c3e-8de2-03f00899c6b7","createdAt":"2025-07-04T07:19:15.000+09:00","updatedAt":"2025-07-04T07:19:15.000+09:00","groupNo":1,"name":"A-3","price":40000,"stock":123,"optionGroup":null},{"no":4,"id":"bccfd6c4-e462-40ce-ad26-c67537e73ec4","createdAt":"2025-07-04T07:19:25.000+09:00","updatedAt":"2025-07-04T07:19:25.000+09:00","groupNo":1,"name":"A-4","price":50000,"stock":200,"optionGroup":null}]}] */

                  function onOptionGroupChange(selectElement) {
                    const selectedValue = selectElement.value;
                    const optionsContainer = document.getElementById('optionGroupOptions');
                    optionsContainer.innerHTML = ''; // 기존 옵션 목록 초기화

                    if (selectedValue) {
                      const group = optionGroups.find(g => g.no == selectedValue);
                      if (group && group.options && group.options.length > 0) {
                        group.options.forEach(option => {
                          const optionDiv = document.createElement('div');
                          optionDiv.className = 'form-check';
                          optionDiv.innerHTML = `
                            <label class="form-check-label" for="option-${option.no}">
                              ${option.name} (+${option.price.toLocaleString()}원, 재고: ${option.stock})
                            </label>
                          `;
                          optionsContainer.appendChild(optionDiv);
                        });
                      }
                    }
                  }

                </script>
                <div class="form-text">상품에 적용할 옵션 그룹을 선택하세요.</div>
              </div>

              <div class="card bg-light">
                <div class="card-body">
                  <h6 class="card-title">수정 안내</h6>
                  <ul class="card-text small">
                    <li>상품명, 가격, 재고는 필수 입력입니다.</li>
                    <li>카테고리는 상품 분류에 활용됩니다.</li>
                    <li>태그는 상품 노출 위치를 결정합니다.</li>
                    <li>배송비가 0원이면 무료배송으로 표시됩니다.</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- CHEditor -->
  <script type="text/javascript" src="/CHEditor/cheditor.js" ></script>
  <script type="text/javascript">
    // CHEditor 초기화
    var myeditor = new cheditor();
    myeditor.config.editorHeight = '300px';
    myeditor.config.editorWidth = '100%';
    myeditor.inputForm = 'fm_post';
    myeditor.run();

    // 폼 제출 시 에디터 내용 동기화 및 유효성 검사
    document.getElementById('productForm').addEventListener('submit', function(event) {
      var content = myeditor.outputBodyHTML();
      document.getElementById('fm_post').value = content;
      if (content.replace(/<[^>]*>/g, '').trim().length > 5000) {
        alert('상품상세는 최대 5000자까지 입력 가능합니다.');
        event.preventDefault();
        return false;
      }
      // 폼 유효성 검사 및 제출 로직 유지
      event.preventDefault();
      event.stopPropagation();

      if (!this.checkValidity()) {
        this.classList.add('was-validated');
        return;
      }

      const formData = {};
      const formElements = new FormData(this);

      for (let [key, value] of formElements.entries()) {
        // 체크박스 처리
        if (key === 'isNew' || key === 'isBest' || key === 'isSoldOut') {
            formData[key] = true;
        } else {
            formData[key] = value;
        }
      }

      // 체크박스 미체크시 false로 보냄
      ['isNew', 'isBest', 'isSoldOut'].forEach(key => {
        if (!(key in formData)) {
            formData[key] = false;
        }
      });

      // 수정 요청
      $ajax({
        url: '/api/products/product',
        type: 'PUT',
        data: formData
      }).then(response => {
        $alert('성공', '상품이 성공적으로 수정되었습니다.', 'success').then(() => {
          window.location.href = '/admin/products';
        });
      }).catch(error => {
        $alert('오류', '수정 중 오류가 발생했습니다. 다시 시도해주세요.', 'error');
      });
    });

    // 상품 삭제
    function deleteProduct() {
        const id = document.getElementById('id').value;
        
        $confirm('상품 삭제', '이 상품을 삭제하시겠습니까?\n삭제된 상품은 복구할 수 없습니다.', 'warning', '삭제', '취소')
        .then(function(result) {
            if (result.isConfirmed) {
                $ajax({
                    url: '/api/products/product/' + id,
                    type: 'DELETE'
                })
                .then(function(response) {
                  $alert('삭제 완료', '상품이 삭제되었습니다.', 'success').then(() => {
                      window.location.href = '/admin/products';
                  });
                })
                .catch(function(error) {
                  console.error('Error:', error);
                  $alert('삭제 오류', '상품 삭제 중 오류가 발생했습니다.', 'error');
                });
            }
        });
    }

    // 페이지 로드 시 초기화
    document.addEventListener('DOMContentLoaded', function() {
        
        // 카테고리 변경 이벤트
        document.getElementById('categoryNo').addEventListener('change', function() {
            const selectedCategoryNo = this.value;
            loadCategoryLarge(selectedCategoryNo, null);
        });
    });

    // 대분류 목록 로드
    function loadCategoryLarge(categoryNo, selectedLargeNo) {
        const categoryLargeSelect = document.getElementById('categoryLargeNo');
        categoryLargeSelect.innerHTML = '<option value="">대분류 선택</option>';
        
        if (!categoryNo) {
            return;
        }

        $ajax({
            url: '/api/category/' + categoryNo + '/category-large',
            type: 'GET'
        })
        .then(function(data) {
            data.forEach(categoryLarge => {
                const option = document.createElement('option');
                option.value = categoryLarge.no;
                option.textContent = categoryLarge.name;
                if (selectedLargeNo && categoryLarge.no == selectedLargeNo) {
                    option.selected = true;
                }
                categoryLargeSelect.appendChild(option);
            });
        })
        .catch(function(error) {
            console.error('대분류 목록 조회 중 오류:', error);
        });
    }

    // Bootstrap validation
    (function() {
        'use strict';
        window.addEventListener('load', function() {
            const forms = document.getElementsByClassName('needs-validation');
            Array.prototype.filter.call(forms, function(form) {
                form.addEventListener('submit', function(event) {
                    if (form.checkValidity() === false) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });
        }, false);
    })();

    // HTML 편집 모드 토글
    document.getElementById('toggleMode').addEventListener('click', function() {
      const editor = document.getElementById('contentEditor');
      const htmlEditor = document.getElementById('htmlEditor');
      const isQuillEditorVisible = editor.style.display !== 'none';

      
      if (!isQuillEditorVisible) {
        // Quill 에디터에서 HTML 에디터로 전환
        htmlEditor.value = editor.children[0].innerHTML;
        editor.style.display = 'none';
        htmlEditor.style.display = 'block';
        this.innerText = '에디터 모드';
      } else {
        // HTML 에디터에서 Quill 에디터로 전환
        editor.children[0].innerHTML = htmlEditor.value;
        editor.style.display = 'block';
        htmlEditor.style.display = 'none';
        this.innerText = 'HTML 편집 모드';
      }
    });
  </script>
</body>
</html>
