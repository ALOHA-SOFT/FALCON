<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{UI/layouts/admin/admin_layout}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>코드 관리</title>
</head>
<body layout:fragment="content">

  <div class="container-fluid">
    <!-- 페이지 헤더 -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
      <h1 class="h3 mb-0 text-gray-800">코드 관리</h1>
      <a href="/admin/codes/create" class="d-none d-sm-inline-block btn btn-primary shadow-sm">
        <i class="material-icons-two-tone">add</i>
        등록
      </a>
    </div>

    <!-- 코드 목록 카드 -->
    <div class="card shadow mb-4">
      <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">코드 목록</h6>
        <div class="d-flex justify-content-end align-items-center">
          <span class="text-muted">total <strong th:text="${#numbers.formatInteger(pagination.total, 0, 'COMMA')}">0</strong></span>
        </div>
      </div>
      <div class="card-body">
        <!-- 검색 영역 -->
        <div class="row mb-3">
          <div class="col-md-4">
            <div class="input-group">
              <input type="text" class="form-control" id="searchInput" placeholder="코드명으로 검색해주세요." th:value="${param.search}">
              <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                <i class="material-icons-two-tone">search</i> 검색
              </button>
            </div>
          </div>
          <div class="col-md-4">
            <div class="input-group">
              <label for="pageSizeSelect" class="input-group-text">
                <i class="material-icons-two-tone">view_list</i>
              </label>
              <select class="form-select" id="pageSizeSelect" onchange="changePageSize()">
                <option value="10" th:selected="${param.size == '10' or param.size == null}">10개씩 보기</option>
                <option value="20" th:selected="${param.size == '20'}">20개씩 보기</option>
                <option value="50" th:selected="${param.size == '50'}">50개씩 보기</option>
                <option value="100" th:selected="${param.size == '100'}">100개씩 보기</option>
              </select>
            </div>
          </div>
          <div class="col-md-4 text-end">
            <button type="button" class="btn btn-danger" id="deleteSelectedBtn" disabled>
              <i class="material-icons-two-tone">delete</i> 선택 삭제
            </button>
          </div>
        </div>

        <!-- 테이블 -->
        <table class="table table-bordered" id="codesTable">
          <thead class="table-light">
            <tr>
              <th width="3%">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="selectAll">
                </div>
              </th>
              <th width="5%">번호</th>
              <th width="10%">ID</th>
              <th>코드명</th>
              <th width="15%">코드값</th>
              <th width="15%">업무코드</th>
              <th width="5%">순서</th>
              <th>설명</th>
              <th width="10%">등록일</th>
              <th width="5%">관리</th>
            </tr>
          </thead>
          <tbody>
            <tr th:if="${pageInfo.list.isEmpty()}">
              <td colspan="10" class="text-center py-4 text-muted">
                등록된 코드가 없습니다.
              </td>
            </tr>
            <tr th:each="code, iterStat : ${pageInfo.list}">
              <td>
                <div class="form-check">
                  <input class="form-check-input codes-checkbox" type="checkbox" 
                         th:value="${code.id}" th:id="'check-' + ${code.id}">
                </div>
              </td>
              <td th:text="${code.no}"></td>
              <td th:text="${code.id}"></td>
              <td>
                <span class="fw-bold" th:text="${code.name}"></span>
              </td>
              <td th:text="${code.value}"></td>
              <td th:text="${code.code ?: '-'}"></td>
              <td th:text="${code.seq}"></td>
              <td th:text="${code.description}"></td>
              <td th:text="${#dates.format(code.createdAt, 'yyyy-MM-dd')}"></td>
              <td>
                <div class="dropdown">
                  <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                          th:id="'dropdownMenuButton-' + ${code.id}" 
                          data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="material-icons-two-tone">more_vert</i>
                  </button>
                  <ul class="dropdown-menu" th:aria-labelledby="'dropdownMenuButton-' + ${code.id}">
                    <li>
                      <a class="dropdown-item" th:href="@{/admin/codes/{id}(id=${code.id})}">
                        <i class="material-icons-two-tone me-2">edit</i>
                        수정
                      </a>
                    </li>
                    <li>
                      <a href="javascript:;" class="dropdown-item text-danger"
                         th:onclick="deleteCode([[${code.id}]])">
                        <i class="material-icons-two-tone me-2">delete</i>
                        삭제
                      </a>
                    </li>
                  </ul>
                </div>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- 페이지 -->
        <th:block th:replace="~{UI/fragments/common/page::page}"></th:block>

      </div>
    </div>
  </div>

  <script>
    // 전체 선택/해제
    document.getElementById('selectAll').addEventListener('change', function() {
      const checkboxes = document.querySelectorAll('.codes-checkbox');
      const isChecked = this.checked;
      
      checkboxes.forEach(function(checkbox) {
        checkbox.checked = isChecked;
      });
      
      updateDeleteButton();
    });

    // 개별 체크박스 변경 시
    document.addEventListener('change', function(e) {
      if (e.target.classList.contains('codes-checkbox')) {
        updateSelectAllState();
        updateDeleteButton();
      }
    });

    // 전체 선택 체크박스 상태 업데이트
    function updateSelectAllState() {
      const checkboxes = document.querySelectorAll('.codes-checkbox');
      const checkedBoxes = document.querySelectorAll('.codes-checkbox:checked');
      const selectAllCheckbox = document.getElementById('selectAll');
      
      if (checkedBoxes.length === 0) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = false;
      } else if (checkedBoxes.length === checkboxes.length) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = true;
      } else {
        selectAllCheckbox.indeterminate = true;
        selectAllCheckbox.checked = false;
      }
    }

    // 삭제 버튼 상태 업데이트
    function updateDeleteButton() {
      const checkedBoxes = document.querySelectorAll('.codes-checkbox:checked');
      const deleteBtn = document.getElementById('deleteSelectedBtn');
      
      if (checkedBoxes.length > 0) {
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = `<i class="material-icons-two-tone">delete</i> 선택 삭제 (${checkedBoxes.length})`;
      } else {
        deleteBtn.disabled = true;
        deleteBtn.innerHTML = '<i class="material-icons-two-tone">delete</i> 선택 삭제';
      }
    }

    // 선택 삭제 기능
    document.getElementById('deleteSelectedBtn').addEventListener('click', function() {
      const checkedBoxes = document.querySelectorAll('.codes-checkbox:checked');
      
      if (checkedBoxes.length === 0) {
        $alert('선택 오류', '삭제할 코드를 선택해주세요.', 'warning');
        return;
      }

      const selectedIds = Array.from(checkedBoxes).map(checkbox => checkbox.value);
      
      $confirmHTML('선택 삭제', 
               `선택한 ${selectedIds.length}개의 코드를 삭제하시겠습니까?<br><br><strong>주의:</strong> 삭제된 데이터는 복구할 수 없습니다.`, 
               'warning', '삭제', '취소')
      .then(function(result) {
        if (result.isConfirmed) {
          deleteSelectedCodes(selectedIds);
        }
      });
    });

    // 선택된 코드들 삭제
    function deleteSelectedCodes(codeIds) {
      let successCount = 0;
      let failCount = 0;
      let totalCount = codeIds.length;

      // 로딩 상태 표시
      const deleteBtn = document.getElementById('deleteSelectedBtn');
      deleteBtn.disabled = true;
      deleteBtn.innerHTML = '<i class="spinner-border spinner-border-sm" role="status"></i> 삭제 중...';

      // 순차적으로 삭제 요청
      const deletePromises = codeIds.map(codeId => {
        return $ajax({
          url: '/api/admin/codes/' + codeId,
          type: 'DELETE'
        }).then(() => {
          successCount++;
        }).catch(() => {
          failCount++;
        });
      });

      // 모든 삭제 요청 완료 후 결과 표시
      Promise.all(deletePromises).then(() => {
        if (failCount === 0) {
          $alert('삭제 완료', `${successCount}개의 코드가 삭제되었습니다.`, 'success').then(() => {
            window.location.reload();
          });
        } else if (successCount === 0) {
          $alert('삭제 실패', '코드 삭제에 실패했습니다.', 'error');
        } else {
          $alert('부분 삭제', 
                 `${successCount}개 삭제 성공, ${failCount}개 삭제 실패했습니다.`, 
                 'warning').then(() => {
            window.location.reload();
          });
        }
        
        // 버튼 상태 복원
        updateDeleteButton();
      });
    }

    // 검색 기능
    document.getElementById('searchBtn').addEventListener('click', function() {
      const searchValue = document.getElementById('searchInput').value;
      const currentUrl = new URL(window.location);
      
      if (searchValue.trim()) {
        currentUrl.searchParams.set('search', searchValue);
      } else {
        currentUrl.searchParams.delete('search');
      }
      
      currentUrl.searchParams.set('page', '1');
      window.location.href = currentUrl.toString();
    });

    // 엔터키 검색
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        document.getElementById('searchBtn').click();
      }
    });

    // 페이지 크기 변경
    function changePageSize() {
      const selectElement = document.getElementById('pageSizeSelect');
      const size = selectElement.value;
      const currentUrl = new URL(window.location);
      
      currentUrl.searchParams.set('size', size);
      currentUrl.searchParams.set('page', '1');
      
      window.location.href = currentUrl.toString();
    }

    // 개별 삭제
    function deleteCode(codeId) {
      $confirmHTML('코드 삭제', 
                   '정말로 이 코드를 삭제하시겠습니까?<br><br><strong>주의:</strong> 삭제된 데이터는 복구할 수 없습니다.', 
                   'warning', '삭제', '취소')
      .then(function(result) {
        if (result.isConfirmed) {
          $ajax({
            url: '/api/admin/codes/' + codeId,
            type: 'DELETE'
          }).then(response => {
            $toast_({ title: '코드가 삭제되었습니다.', icon: 'success' }).then(() => {
              window.location.reload();
            });
          }).catch(error => {
            $alert('오류', '삭제 중 오류가 발생했습니다.', 'error');
          });
        }
      });
    }
  </script>

</body>
</html>
