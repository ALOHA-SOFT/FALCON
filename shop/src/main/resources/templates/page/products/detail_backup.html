<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{UI/layouts/user/main_layout}"
      >
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Falcon Cartons</title>
</head>
<body layout:fragment="content">

  <!-- 스페이스 : s-lg -->
  <div class="s-lg"></div>

  <section id="product-detail" class="container my-5">
        <h3 class="mb-5 text-center">
          <th:block th:text="${product.name}"></th:block>
        </h3>

        <!-- 상품이 없을 때-->
        <div th:unless="${product != null}">
          <p>상품 정보를 불러올 수 없습니다.</p>
        </div>
        <!-- 상품 정보 -->
        <div th:if="${product != null}" class="my-5">
          <div class="row">
            <!-- 상품 이미지 -->
            <div class="col-12 col-xl-6 px-4 px-lg-5">
              <div class="p-img-box">
                <img th:if="${product.mainImg != null}" th:src="${product.mainImg.content}" class="card-img-top p-img cursor-pointer" alt="상품 이미지" data-bs-toggle="modal" data-bs-target="#imageModal">

                <!-- Image Modal -->
                <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
                  <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="imageModalLabel">상품 이미지</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body text-center">
                        <img id="modalImage" src="" class="img-fluid" alt="상품 이미지">
                      </div>
                    </div>
                  </div>
                </div>

                <script>
                // 메인 이미지 클릭 시 모달에 이미지 설정
                document.querySelector('.p-img').addEventListener('click', function() {
                  document.getElementById('modalImage').src = this.src;
                });
                </script>
                <img th:if="${product.mainImg == null}" src="https://placehold.co/600x400?text=No+Image" class="card-img-top p-img" alt="이미지 없음">
              </div>
              <!-- 
                swiper 썸네일 이미지 80x80 으로 슬라이드
                썸네일 슬라이드 클릭시 p-img-box 이미지 변경
                -->
              <div class="swiper-container mt-3 w-100 overflow-hidden">
                <div class="swiper-wrapper">
                  <div class="swiper-slide">
                    <img th:if="${product.mainImg != null}" th:src="${product.mainImg.content}" class="cursor-pointer p-img-thumbnail">
                    <img th:if="${product.mainImg == null}" src="https://placehold.co/80x80?text=No+Image" class="cursor-pointer p-img-thumbnail">
                  </div>
                    <th:block th:if="${product.imgList != null}" th:each="media : ${product.imgList}">
                    <div class="swiper-slide">
                      <img th:src="${media.content}" class="cursor-pointer p-img-thumbnail">
                    </div>
                    </th:block>
                </div>
                <div class="swiper-pagination"></div>
                <div class="swiper-button-next"></div>
                <div class="swiper-button-prev"></div>
              </div>
              <script>
                // Swiper 초기화
                var swiper = new Swiper('.swiper-container', {
                  slidesPerView: 6,
                  spaceBetween: 10,
                  navigation: {
                    nextEl: '.swiper-button-next',
                    prevEl: '.swiper-button-prev',
                  },
                  pagination: {
                    el: '.swiper-pagination',
                    clickable: true,
                  },
                });

                // 썸네일 클릭 시 메인 이미지 변경
                document.querySelectorAll('.swiper-slide img').forEach(function(thumbnail) {
                  thumbnail.addEventListener('click', function() {
                    document.querySelector('.p-img-box img').src = this.src;
                  });
                });
              </script>


            </div>
            <!-- 상품 상세 정보 -->
            <div class="col-12 col-xl-6 px-4 px-lg-5">
              <div class="product-details" style="padding: 10px; display: flex; flex-direction: column; gap: 20px;">
                
                <!-- 상품명 -->
                <h2 style="font-family: 'Helvetica Neue'; font-size: 24px; line-height: 1.5; color: #000; margin: 0;">
                  <th:block th:text="${product.name}"></th:block>
                </h2>
                
                <!-- SKU -->
                <div style="font-family: 'Helvetica Neue'; font-size: 16px; line-height: 1.5; color: #666;">
                  SKU: <span th:text="${product.no}"></span>
                </div>
                
                <!-- 가격 -->
                <div style="font-family: 'Helvetica Neue'; font-size: 20px; font-weight: 700; line-height: 1.5; color: #21257E;">
                  <th:block th:text="${product.price == null ? '' : '£ ' + #numbers.formatDecimal(product.price, 1, 'COMMA', 2, 'POINT')}"></th:block>
                </div>
                
                <!-- Quantity 섹션 -->
                <div style="width: 140px;">
                  <div style="font-family: 'Helvetica Neue'; font-size: 14px; line-height: 1.5; color: #666; margin-bottom: 10px;">
                    Quantity *
                  </div>
                  <div id="quantityControl" style="display: flex; justify-content: space-between; align-items: center; gap: 10px; padding: 10px; border: 1px solid #666; width: 93px;">
                    <button type="button" id="decreaseQty" style="border: none; background: none; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                      <svg width="12" height="1" viewBox="0 0 12 1" fill="none">
                        <path d="M2 7.5H12" stroke="#212529" stroke-width="1"/>
                      </svg>
                    </button>
                    <input type="text" id="quantity" value="1" style="border: none; background: none; text-align: center; font-family: 'Helvetica Neue'; font-size: 14px; color: #000; width: 21px;" readonly>
                    <button type="button" id="increaseQty" style="border: none; background: none; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; cursor: pointer;">
                      <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                        <path d="M6 2V10M2 6H10" stroke="#212529" stroke-width="2" stroke-linecap="round"/>
                      </svg>
                    </button>
                  </div>
                </div>
                
                <!-- Add to Cart 버튼 -->
                <button type="button" id="addToCartBtn" style="width: 400px; height: 43px; background: #212529; border: 1px solid #212529; border-radius: 6px; color: white; font-family: 'Helvetica Neue'; font-size: 16px; font-weight: 400; cursor: pointer; margin-top: 20px;">
                  Add to Cart
                </button>
                
                <!-- 옵션 선택 (기존 기능 유지) -->
                <div class="py-3 mb-3" th:if="${optionGroup != null}" style="display: none;">
                  <h6>옵션</h6>
                  <select class="form-select" id="variantSelect">
                    <option value="">옵션을 선택하세요</option>
                    <option th:each="option : ${optionGroup.options}" th:value="${option.no}" th:data-price="${option.price}" th:text="${option.name}"></option>
                  </select>
                  <div id="selectedOptions" class="mt-3"></div>
                </div>
                
              </div>
            </div>
                
                <script th:inline="javascript">
                    var userName = /*[[${ session.SPRING_SECURITY_CONTEXT != null ? #authentication.principal.user.name : '' }]]*/ '';
                    var isLogin = userName || false;
                    var productNo = /*[[${product.no}]]*/ 0;
                    var basePrice = /*[[${product.price}]]*/ 0;
                </script>
                
                <script>
                  // Quantity 컨트롤
                  let currentQuantity = 1;
                  const quantityInput = document.getElementById('quantity');
                  const decreaseBtn = document.getElementById('decreaseQty');
                  const increaseBtn = document.getElementById('increaseQty');
                  
                  decreaseBtn.addEventListener('click', function() {
                    if (currentQuantity > 1) {
                      currentQuantity--;
                      quantityInput.value = currentQuantity;
                    }
                  });
                  
                  increaseBtn.addEventListener('click', function() {
                    currentQuantity++;
                    quantityInput.value = currentQuantity;
                  });
                  
                  // 장바구니 버튼 이벤트
                  document.getElementById('addToCartBtn').addEventListener('click', function() {
                    
                    if (!isLogin) {
                      $alert_({
                        title: '로그인이 필요합니다',
                        text: '장바구니 이용을 위해 로그인이 필요합니다.',
                        icon: 'warning',
                        confirmButtonText: '로그인하기',
                        cancelButtonText: '취소',
                        showCancelButton: true
                      }).then((result) => {
                        if (result.isConfirmed) {
                          window.location.href = '/login?redirect=/products/' + productNo;
                        }
                      });
                      return;
                    }

                    // 간단한 장바구니 데이터 (옵션 없이)
                    const cartData = {
                      productNo: productNo,
                      quantity: currentQuantity,
                      totalPrice: basePrice * currentQuantity,
                      options: '[]' // 빈 옵션 배열
                    };
                    
                    $ajax({
                      url: '/api/users/cart',
                      type: 'POST',
                      data: cartData
                    }).then(function(result) {
                      if (result === 'FAIL') {
                        $alert({
                          title: '장바구니 등록 실패',
                          text: '장바구니 등록 중 오류가 발생했습니다. 다시 시도해주세요.',
                          icon: 'error',
                          confirmButtonText: '확인'
                        });
                        return;
                      }
                      
                      // 장바구니 오프캔버스 열기
                      showCartOffcanvas();
                      
                    }).catch(function(error) {
                      console.error('장바구니 등록 오류:', error);
                      $alert({
                        title: '장바구니 등록 실패',
                        text: '장바구니 등록 중 오류가 발생했습니다.',
                        icon: 'error',
                        confirmButtonText: '확인'
                      });
                    });
                  });
                </script>
                  
                  // 구매하기 버튼 이벤트
                  document.getElementById('buyNowBtn').addEventListener('click', function() {

                    if (!isLogin) {
                      $alert_({
                        title: '로그인이 필요합니다',
                        text: '구매를 위해 로그인이 필요합니다.',
                        icon: 'warning',
                        confirmButtonText: '로그인하기',
                        cancelButtonText: '취소',
                        showCancelButton: true
                      }).then((result) => {
                        if (result.isConfirmed) {
                          window.location.href = '/login?redirect=/products/' + /*[[${product.id}]]*/ '';
                        }
                      });
                      return;
                    }

                    if (selectedOptions.length === 0) {
                        $alert({
                          title: '옵션을 선택해주세요',
                          text: '구매를 위해 최소 하나의 옵션을 선택해야 합니다.',
                          icon: 'warning',
                          confirmButtonText: '확인'
                        });
                      return;
                    }

                    // 주문 데이터 생성
                    const orderData = {
                      title: [[${product.name}]],
                      totalPrice: calculateTotalPrice(),
                      totalQuantity: calculateTotalQuantity(),
                      totalItemCount: 1,
                      status: '결제대기',
                      orderItems: [{
                        productNo: "[[${product.no}]]",
                        quantity: 1,
                        price: "[[${product.price}]]",
                        orderItemOptions: selectedOptions.map(opt => ({
                          optionNo: opt.no,
                          quantity: opt.quantity,
                          price: opt.price
                        }))
                      }],
                    };

                    console.dir(orderData);
                    
                    // 주문 생성 API 호출
                    $ajax({
                      url: '/orders/create',
                      type: 'POST',
                      data: orderData
                    }).then(function(data) {
                      console.log('주문 성공 여부:', data);
                      if( data == 'FAIL' ) {
                        $alert({
                          title: '주문 생성 실패',
                          text: '주문 생성 중 오류가 발생했습니다. 다시 시도해주세요.',
                          icon: 'error',
                          confirmButtonText: '확인'
                        });
                        return;
                      }
                      $toast_({
                        title: '주문 생성 성공',
                        icon: 'success',
                        timer: 1000,
                      }).then(() => {
                        // 주문 생성 후 결제 페이지로 이동
                        window.location.href = `/pay/order/${data.id}`;
                      });
                    }).catch(function(error) {
                      console.error('주문 생성 오류:', error);
                      alert('주문 생성 중 오류가 발생했습니다.');
                    });
                  });
                  
                  function calculateTotalPrice() {
                    let total = basePrice;
                    selectedOptions.forEach(opt => {
                      total += opt.price * opt.quantity;
                    });
                    return total;
                  }
                  
                  function calculateTotalQuantity() {
                    let total = 1; // 기본 상품 수량
                    // selectedOptions.forEach(opt => {
                    //   total += opt.quantity;
                    // });
                    return total;
                  }
                </script>

              </div>
            </div>
        </div>

  </section>


  <!-- 상품 소개 영상 섹션 -->
  <section id="intro-video" class="py-5">
    <div class="container text-center">
      <h1 class="main-title main-color">상품 상세</h1>
      <hr class="line">
      <div class="ratio ratio-16x9 my-5" id="video-container">
        <div id="player"></div>
      </div>
      <script th:inline="javascript">
        var mainVideo = `[[${product.mainVideo != null ? product.mainVideo.content : ''}]]` || '';
        var videoId = '';
        if (mainVideo) {
          // mainVideo가 유튜브 URL일 때 videoId 추출
          var match = String(mainVideo).match(/(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))([A-Za-z0-9_-]{11})/);
          if (match && match[1]) {
            videoId = match[1];
          }
        }
      </script>
      <script>
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        var player;
        function onYouTubeIframeAPIReady() {
          if( videoId === '' ) {
            // document.getElementById('player').innerHTML = '<p>상품 소개 영상이 없습니다.</p>';
            document.getElementById('video-container').style.display = 'none';
            return;
          }
          player = new YT.Player('player', {
            width: '100%',
            height: '100%',
            videoId: videoId,
            playerVars: {
              'autoplay': 1,
              'controls': 1,
              'rel': 0,
              'mute': 1
            },
            events: {
              'onReady': function(event) {
                event.target.playVideo();
              }
            }
          });
        }
      </script>
    </div>
  </section>

  <!-- 상품 상세 섹션 -->
  <section id="product-content">
    <div class="container my-5">
      
      <th:block th:if="${product.content != null and !#strings.isEmpty(product.content)}" th:utext="${product.content}"></th:block>
      <th:block th:unless="${product.content != null and !#strings.isEmpty(product.content)}">
        <img src="https://placehold.co/1320x2000" alt="1320x400 Placeholder" class="img-fluid">
      </th:block>
    </div>
  </section>

  <!-- 스페이스 : s-lg -->
  <div class="s-lg"></div>


  <!-- NEW - 상품목록 4컬럼 -->
  <section id="related" class="py-5">
    <div class="container">
      <h1 class="text-center main-title main-color py-5">관련상품</h1>
      <hr class="line">
      <!-- Swiper -->
      <div class="swiper related-products-swiper my-5">
        <div class="swiper-wrapper">
          <!-- 상품카드 -->
          <th:block th:each="product : ${relatedProducts}">
        <div class="swiper-slide">
          <div class="card h-100">
            <span th:if="${ product.isBest }" class="badge bg-primary position-absolute top-0 start-0 m-2" style="z-index:1;">BEST</span>
            <!-- 상품 이미지 -->
            <a th:href="@{/products/{id}(id=${product.id})}" class="p-img-box">
          <img th:if="${product.thumbImg != null and product.thumbImg.content != null}" th:src="${product.thumbImg.content}" th:alt="${product.name}" class="card-img-top p-img" style="width:100%;">
          <img th:unless="${product.thumbImg != null and product.thumbImg.content != null}" src="https://placehold.co/300x400?text=No+Image" alt="기본 배너 이미지" style="width:100%;">
            </a>
            <div class="card-body text-center">
          <h5 class="card-title" th:text="${ product.name }">상품명 1</h5>
          <p class="card-text" th:text="${ product.price != null ? '£ ' + #numbers.formatDecimal(product.price, 1, 'COMMA', 2, 'POINT') : '' }">£10,000</p>
            </div>
            <div class="card-footer bg-transparent">
          <div class="d-flex justify-content-end align-items-center">
            <a th:href="@{/products/{id}(id=${product.id})}" class="btn btn-light">
              주문하기
            </a>
          </div>
            </div>
          </div>
        </div>
          </th:block>
        </div>
        <!-- Add Arrows -->
        <div class="swiper-button-next"></div>
        <div class="swiper-button-prev"></div>
      </div>

      <script>
        // Related Products Swiper 초기화
        var relatedSwiper = new Swiper('.related-products-swiper', {
          slidesPerView: 4,
          slidesPerGroup: 4,
          spaceBetween: 20,
          navigation: {
        nextEl: '.related-products-swiper .swiper-button-next',
        prevEl: '.related-products-swiper .swiper-button-prev',
          },
          // pagination: {
          //   el: '.related-products-swiper .swiper-pagination',
          //   clickable: true,
          // },
          breakpoints: {
        320: {
          slidesPerView: 1,
          slidesPerGroup: 1,
        },
        768: {
          slidesPerView: 2,
          slidesPerGroup: 2,
        },
        1024: {
          slidesPerView: 4,
          slidesPerGroup: 4,
        }
          }
        });
      </script>
    </div>
  </section>

  <!-- 장바구니 오프캔버스 -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="cartOffcanvas" aria-labelledby="cartOffcanvasLabel">
    <div class="offcanvas-header" style="padding: 20px; border-bottom: 1px solid #dee2e6;">
      <h5 class="offcanvas-title" id="cartOffcanvasLabel" style="font-family: 'Helvetica Neue'; font-size: 20px; font-weight: 600; color: #000;">
        Shopping Cart
      </h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body" style="padding: 20px;">
      <div id="cartItems">
        <!-- 장바구니 아이템들이 여기에 로드됩니다 -->
        <div class="text-center text-muted">
          장바구니가 비어있습니다.
        </div>
      </div>
      
      <!-- 장바구니 합계 -->
      <div id="cartSummary" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #dee2e6; display: none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <span style="font-family: 'Helvetica Neue'; font-size: 16px; color: #666;">Total:</span>
          <span id="cartTotal" style="font-family: 'Helvetica Neue'; font-size: 20px; font-weight: 700; color: #21257E;">£0</span>
        </div>
        <button type="button" class="btn w-100" style="background: #212529; color: white; border: 1px solid #212529; border-radius: 6px; padding: 12px; font-family: 'Helvetica Neue'; font-size: 16px;">
          Checkout
        </button>
      </div>
    </div>
  </div>

  <script>
    // 장바구니 오프캔버스 관련 함수들
    function showCartOffcanvas() {
      loadCartItems();
      const offcanvas = new bootstrap.Offcanvas(document.getElementById('cartOffcanvas'));
      offcanvas.show();
    }
    
    function loadCartItems() {
      $ajax({
        url: '/api/users/cart',
        type: 'GET'
      }).then(function(cartList) {
        renderCartItems(cartList);
      }).catch(function(error) {
        console.error('장바구니 로드 오류:', error);
      });
    }
    
    function renderCartItems(cartList) {
      const cartItemsDiv = document.getElementById('cartItems');
      const cartSummary = document.getElementById('cartSummary');
      const cartTotal = document.getElementById('cartTotal');
      
      if (!cartList || cartList.length === 0) {
        cartItemsDiv.innerHTML = '<div class="text-center text-muted">장바구니가 비어있습니다.</div>';
        cartSummary.style.display = 'none';
        return;
      }
      
      let totalAmount = 0;
      let itemsHtml = '';
      
      cartList.forEach(cart => {
        const itemTotal = cart.quantity * cart.product.price;
        totalAmount += itemTotal;
        
        itemsHtml += `
          <div class="cart-item d-flex align-items-center mb-3 p-3" style="border: 1px solid #dee2e6; border-radius: 8px;">
            <div class="cart-item-image me-3">
              <img src="${cart.product.mainImg ? cart.product.mainImg.content : 'https://placehold.co/60x60?text=No+Image'}" 
                   alt="${cart.product.name}" 
                   style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px;">
            </div>
            <div class="cart-item-details flex-grow-1">
              <h6 style="font-family: 'Helvetica Neue'; font-size: 14px; font-weight: 600; color: #000; margin-bottom: 4px;">
                ${cart.product.name}
              </h6>
              <div style="font-family: 'Helvetica Neue'; font-size: 12px; color: #666; margin-bottom: 4px;">
                SKU: ${cart.product.no}
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <div class="quantity-controls d-flex align-items-center">
                  <button type="button" class="btn btn-sm" onclick="updateCartQuantity(${cart.no}, ${cart.quantity - 1})" 
                          style="border: 1px solid #dee2e6; width: 30px; height: 30px; padding: 0; display: flex; align-items: center; justify-content: center;">
                    <span style="font-size: 12px;">-</span>
                  </button>
                  <span style="margin: 0 10px; font-family: 'Helvetica Neue'; font-size: 14px; min-width: 20px; text-align: center;">
                    ${cart.quantity}
                  </span>
                  <button type="button" class="btn btn-sm" onclick="updateCartQuantity(${cart.no}, ${cart.quantity + 1})" 
                          style="border: 1px solid #dee2e6; width: 30px; height: 30px; padding: 0; display: flex; align-items: center; justify-content: center;">
                    <span style="font-size: 12px;">+</span>
                  </button>
                </div>
                <div style="font-family: 'Helvetica Neue'; font-size: 14px; font-weight: 600; color: #21257E;">
                  £${itemTotal.toLocaleString()}
                </div>
              </div>
            </div>
            <button type="button" class="btn btn-sm ms-2" onclick="removeCartItem(${cart.no})" 
                    style="color: #dc3545; border: none; background: none; padding: 5px;">
              <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
              </svg>
            </button>
          </div>
        `;
      });
      
      cartItemsDiv.innerHTML = itemsHtml;
      cartTotal.textContent = '£ ' + totalAmount.toLocaleString();
      cartSummary.style.display = 'block';
    }
    
    function updateCartQuantity(cartNo, newQuantity) {
      if (newQuantity < 1) {
        removeCartItem(cartNo);
        return;
      }
      
      $ajax({
        url: '/api/users/cart/' + cartNo,
        type: 'PUT',
        data: { quantity: newQuantity }
      }).then(function(result) {
        if (result === 'SUCCESS') {
          loadCartItems(); // 장바구니 새로고침
        }
      }).catch(function(error) {
        console.error('장바구니 수량 업데이트 오류:', error);
      });
    }
    
    function removeCartItem(cartNo) {
      $ajax({
        url: '/api/users/cart/' + cartNo,
        type: 'DELETE'
      }).then(function(result) {
        if (result === 'SUCCESS') {
          loadCartItems(); // 장바구니 새로고침
        }
      }).catch(function(error) {
        console.error('장바구니 삭제 오류:', error);
      });
    }
  </script>
    

</body>
</html>