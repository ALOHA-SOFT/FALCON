<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{UI/layouts/user/main_layout}"
      >
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>분수마켓</title>
</head>
<body layout:fragment="content">

  <!-- 스페이스 : s-lg -->
  <div class="s-lg"></div>

  <section id="product-detail" class="container my-5">
        <h3 class="mb-5 text-center">
          <th:block th:text="${product.name}"></th:block>
        </h3>

        <!-- 상품이 없을 때-->
        <div th:unless="${product != null}">
          <p>상품 정보를 불러올 수 없습니다.</p>
        </div>
        <!-- 상품 정보 -->
        <div th:if="${product != null}" class="my-5">
          <div class="row">
            <!-- 상품 이미지 -->
            <div class="col-12 col-xl-6 px-4 px-lg-5">
              <div class="p-img-box">
                <img th:if="${product.mainImg != null}" th:src="${product.mainImg.content}" class="card-img-top p-img cursor-pointer" alt="상품 이미지" data-bs-toggle="modal" data-bs-target="#imageModal">

                <!-- Image Modal -->
                <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
                  <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="imageModalLabel">상품 이미지</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body text-center">
                        <img id="modalImage" src="" class="img-fluid" alt="상품 이미지">
                      </div>
                    </div>
                  </div>
                </div>

                <script>
                // 메인 이미지 클릭 시 모달에 이미지 설정
                document.querySelector('.p-img').addEventListener('click', function() {
                  document.getElementById('modalImage').src = this.src;
                });
                </script>
                <img th:if="${product.mainImg == null}" src="https://placehold.co/600x400?text=No+Image" class="card-img-top p-img" alt="이미지 없음">
              </div>
              <!-- 
                swiper 썸네일 이미지 80x80 으로 슬라이드
                썸네일 슬라이드 클릭시 p-img-box 이미지 변경
                -->
              <div class="swiper-container mt-3 w-100 overflow-hidden">
                <div class="swiper-wrapper">
                  <div class="swiper-slide">
                    <img th:if="${product.mainImg != null}" th:src="${product.mainImg.content}" class="cursor-pointer p-img-thumbnail">
                    <img th:if="${product.mainImg == null}" src="https://placehold.co/80x80?text=No+Image" class="cursor-pointer p-img-thumbnail">
                  </div>
                    <th:block th:if="${product.imgList != null}" th:each="media : ${product.imgList}">
                    <div class="swiper-slide">
                      <img th:src="${media.content}" class="cursor-pointer p-img-thumbnail">
                    </div>
                    </th:block>
                </div>
                <div class="swiper-pagination"></div>
                <div class="swiper-button-next"></div>
                <div class="swiper-button-prev"></div>
              </div>
              <script>
                // Swiper 초기화
                var swiper = new Swiper('.swiper-container', {
                  slidesPerView: 6,
                  spaceBetween: 10,
                  navigation: {
                    nextEl: '.swiper-button-next',
                    prevEl: '.swiper-button-prev',
                  },
                  pagination: {
                    el: '.swiper-pagination',
                    clickable: true,
                  },
                });

                // 썸네일 클릭 시 메인 이미지 변경
                document.querySelectorAll('.swiper-slide img').forEach(function(thumbnail) {
                  thumbnail.addEventListener('click', function() {
                    document.querySelector('.p-img-box img').src = this.src;
                  });
                });
              </script>


            </div>
            <!-- 상품 상세 정보 -->
            <div class="col-12 col-xl-6 px-4 px-lg-5">
              <div class="product-details">
                <!-- 가격 -->
                <h5 class="text-start py-4">
                  <th:block th:text="${product.price == null ? '' : '£' + #numbers.formatInteger(product.price, 0, 'COMMA')}"></th:block>
                </h5>
                
                <!-- 배송안내 -->
                <div class="py-3 d-flex justify-content-start align-items-center gap-5" th:if="${product.shipMsg != null and !#strings.isEmpty(product.shipMsg)}">
                  <span style="width: 80px;" class="text-start">배송</span>
                  <span class="text-muted" th:text="${product.shipMsg}"></span>
                </div>

                <!-- 배송비 -->
                <div class="py-3 d-flex justify-content-start align-items-center gap-5" th:if="${product.shipPrice != null}">
                  <span style="width: 80px;" class="text-start">배송비</span>
                  <span class="text-muted" th:text="${'£' + #numbers.formatInteger(product.shipPrice, 0, 'COMMA')}"></span>
                </div>
                
                <!-- 상품정보 -->
                <div class="py-3 d-flex justify-content-start align-items-center gap-5" th:if="${product.summary != null and !#strings.isEmpty(product.summary)}">
                  <span style="width: 80px;" class="text-start">상품정보</span>
                  <span class="text-muted" th:text="${product.summary}"></span>
                </div>
                
                <!-- 옵션 선택 -->
                <div class="py-3 mb-3" th:if="${optionGroup != null}">
                  <h6>옵션</h6>
                  <select class="form-select" id="variantSelect">
                    <option value="">옵션을 선택하세요</option>
                    <option th:each="option : ${optionGroup.options}" th:value="${option.no}" th:data-price="${option.price}" th:text="${option.name}"></option>
                  </select>
                  <div id="selectedOptions" class="mt-3"></div>
                </div>
                
                <div class="d-flex justify-content-between align-items-center my-5">
                  <!-- 총 상품금액 -->
                  <div class="">
                    <h5 class="fw-bold">
                      <span>총 상품금액 </span>
                      <span id="totalPrice" class="fw-bold fs-3" th:text="${'£' + #numbers.formatInteger(product.price, 0, 'COMMA')}"></span></h5>
                  </div>
                </div>
                
                <!-- 버튼 -->
                <div class="row row-cols-1 row-cols-md-2 g-3">
                  <div class="col">
                    <button type="button" class="w-100 btn btn-outline-primary btn-lg" id="addToCartBtn">장바구니</button>
                  </div>
                  <div class="col">
                    <button type="button" class="w-100 btn btn-primary btn-lg" id="buyNowBtn">구매하기</button>
                  </div>
                </div>
                
                <script th:inline="javascript">
                    var userName = /*[[${ session.SPRING_SECURITY_CONTEXT != null ? #authentication.principal.user.name : '' }]]*/ '';
                    var isLogin = userName || false;
                </script>
                <script th:inline="javascript">
                  // 옵션별 수량 및 금액 관리
                  const variantSelect = document.getElementById('variantSelect');
                  const selectedOptionsDiv = document.getElementById('selectedOptions');
                  const totalPriceSpan = document.getElementById('totalPrice');
                  let basePrice = /*[[${product.price}]]*/ 0;
                  let selectedOptions = [];

                  function renderSelectedOptions() {
                    selectedOptionsDiv.innerHTML = '';
                    selectedOptions.forEach(opt => {
                      const card = document.createElement('div');
                      card.className = 'card mb-2';
                      card.innerHTML = `
                        <div class="card-body d-flex align-items-center justify-content-between gap-3">
                          <div class="flex-grow-1">
                            <strong>${opt.name}</strong>
                            <span class="text-muted ms-2">(+£${opt.price.toLocaleString()})</span>
                          </div>
                          <div class="input-group" style="width: 150px;">
                            <button class="btn btn-outline-secondary btn-sm" type="button" data-action="decrease" data-id="${opt.id}">-</button>
                            <input type="text" class="form-control text-center option-quantity-input" value="${opt.quantity}" min="1" data-id="${opt.id}" style="width:50px;">
                            <button class="btn btn-outline-secondary btn-sm" type="button" data-action="increase" data-id="${opt.id}">+</button>
                          </div>
                          <span class="ms-3">£${(opt.price * opt.quantity).toLocaleString()}</span>
                          <button class="btn btn-outline-danger btn-sm d-flex justify-content-center align-items-center ms-2" type="button" data-action="remove" data-id="${opt.id}"><i class="material-icons">close</i></button>
                        </div>
                      `;
                      selectedOptionsDiv.appendChild(card);
                    });
                    updateTotalPrice();

                    // 수량 인풋 직접 입력 이벤트 바인딩
                    selectedOptionsDiv.querySelectorAll('.option-quantity-input').forEach(input => {
                      input.addEventListener('input', function(e) {
                        let val = parseInt(this.value.replace(/[^0-9]/g, ''));
                        if (isNaN(val) || val < 1) val = 1;
                        this.value = val;
                        const id = this.dataset.id;
                        const opt = selectedOptions.find(o => o.id === id);
                        if (opt) {
                          opt.quantity = val;
                          updateTotalPrice();
                        }
                      });
                    });
                  }

                  function updateTotalPrice() {
                    let total = basePrice;
                    selectedOptions.forEach(opt => {
                      total += opt.price * opt.quantity;
                    });
                    totalPriceSpan.textContent = '£' + total.toLocaleString();
                  }

                  variantSelect.addEventListener('change', function() {
                    const selectedId = this.value;
                    if (!selectedId) return;
                    // 옵션 정보 추출
                    const selectedOption = this.options[this.selectedIndex];
                    const name = selectedOption.text;
                    const price = parseInt(selectedOption.dataset.price || '0');
                    // 중복 체크
                    if (selectedOptions.some(opt => opt.id === selectedId)) {
                      alert('이미 선택된 옵션입니다.');
                      return;
                    }
                    selectedOptions.push({ no: selectedId, id: selectedId, name, price, quantity: 1 });
                    renderSelectedOptions();
                  });

                  selectedOptionsDiv.addEventListener('click', function(e) {
                    const btn = e.target.closest('button');
                    if (!btn) return;
                    const action = btn.dataset.action;
                    const id = btn.dataset.id;
                    const opt = selectedOptions.find(o => o.id === id);
                    if (!opt) return;
                    if (action === 'increase') {
                      opt.quantity++;
                    } else if (action === 'decrease') {
                      if (opt.quantity > 1) opt.quantity--;
                    } else if (action === 'remove') {
                      selectedOptions = selectedOptions.filter(o => o.id !== id);
                    }
                    renderSelectedOptions();
                  });

                  // 옵션 변경 시 총금액도 자동 갱신
                  renderSelectedOptions();
                  
                  // 장바구니 버튼 이벤트
                  document.getElementById('addToCartBtn').addEventListener('click', function() {
                    
                    if (!isLogin) {
                      $alert_({
                        title: '로그인이 필요합니다',
                        text: '장바구니 이용을 위해 로그인이 필요합니다.',
                        icon: 'warning',
                        confirmButtonText: '로그인하기',
                        cancelButtonText: '취소',
                        showCancelButton: true
                      }).then((result) => {
                        if (result.isConfirmed) {
                          window.location.href = '/login?redirect=/products/' + /*[[${product.id}]]*/ '';
                        }
                      });
                      return;
                    }

                    if (selectedOptions.length === 0) {
                      $alert({
                        title: '옵션을 선택해주세요',
                        text: '장바구니 담기를 위해 최소 하나의 옵션을 선택해야 합니다.',
                        icon: 'warning',
                        confirmButtonText: '확인'
                      });
                      return;
                    }

                    // 각 선택된 옵션을 JSON 배열로 묶어서 cartData.options에 할당
                    const cartData = {
                      productNo: "[[${product.no}]]",
                      quantity: 1,
                      totalPrice: calculateTotalPrice(),
                      options: JSON.stringify(selectedOptions.map(opt => ({
                        option_no: opt.no,
                        quantity: opt.quantity,
                        price: opt.price
                      })))
                    };
                    $ajax({
                      url: '/api/users/cart',
                      type: 'POST',
                      data: cartData
                    }).then(function(result) {
                      if (result === 'FAIL') {
                        $alert({
                          title: '장바구니 등록 실패',
                          text: '장바구니 등록 중 오류가 발생했습니다. 다시 시도해주세요.',
                          icon: 'error',
                          confirmButtonText: '확인'
                        });
                        return;
                      }
                      $toast_({
                        title: '장바구니에 담았습니다',
                        icon: 'success',
                        timer: 2000,
                      }).then(() => {
                        // selectedOptions = [];
                        // variantSelect.value = '';
                        // renderSelectedOptions();

                      });
                    }).catch(function(error) {
                      console.error('장바구니 등록 오류:', error);
                      $alert({
                        title: '장바구니 등록 실패',
                        text: '장바구니 등록 중 오류가 발생했습니다.',
                        icon: 'error',
                        confirmButtonText: '확인'
                      });
                    });
                  });
                  
                  // 구매하기 버튼 이벤트
                  document.getElementById('buyNowBtn').addEventListener('click', function() {

                    if (!isLogin) {
                      $alert_({
                        title: '로그인이 필요합니다',
                        text: '구매를 위해 로그인이 필요합니다.',
                        icon: 'warning',
                        confirmButtonText: '로그인하기',
                        cancelButtonText: '취소',
                        showCancelButton: true
                      }).then((result) => {
                        if (result.isConfirmed) {
                          window.location.href = '/login?redirect=/products/' + /*[[${product.id}]]*/ '';
                        }
                      });
                      return;
                    }

                    if (selectedOptions.length === 0) {
                        $alert({
                          title: '옵션을 선택해주세요',
                          text: '구매를 위해 최소 하나의 옵션을 선택해야 합니다.',
                          icon: 'warning',
                          confirmButtonText: '확인'
                        });
                      return;
                    }

                    // 주문 데이터 생성
                    const orderData = {
                      title: [[${product.name}]],
                      totalPrice: calculateTotalPrice(),
                      totalQuantity: calculateTotalQuantity(),
                      totalItemCount: 1,
                      status: '결제대기',
                      orderItems: [{
                        productNo: "[[${product.no}]]",
                        quantity: 1,
                        price: "[[${product.price}]]",
                        orderItemOptions: selectedOptions.map(opt => ({
                          optionNo: opt.no,
                          quantity: opt.quantity,
                          price: opt.price
                        }))
                      }],
                    };

                    console.dir(orderData);
                    
                    // 주문 생성 API 호출
                    $ajax({
                      url: '/orders/create',
                      type: 'POST',
                      data: orderData
                    }).then(function(data) {
                      console.log('주문 성공 여부:', data);
                      if( data == 'FAIL' ) {
                        $alert({
                          title: '주문 생성 실패',
                          text: '주문 생성 중 오류가 발생했습니다. 다시 시도해주세요.',
                          icon: 'error',
                          confirmButtonText: '확인'
                        });
                        return;
                      }
                      $toast_({
                        title: '주문 생성 성공',
                        icon: 'success',
                        timer: 1000,
                      }).then(() => {
                        // 주문 생성 후 결제 페이지로 이동
                        window.location.href = `/pay/order/${data.id}`;
                      });
                    }).catch(function(error) {
                      console.error('주문 생성 오류:', error);
                      alert('주문 생성 중 오류가 발생했습니다.');
                    });
                  });
                  
                  function calculateTotalPrice() {
                    let total = basePrice;
                    selectedOptions.forEach(opt => {
                      total += opt.price * opt.quantity;
                    });
                    return total;
                  }
                  
                  function calculateTotalQuantity() {
                    let total = 1; // 기본 상품 수량
                    // selectedOptions.forEach(opt => {
                    //   total += opt.quantity;
                    // });
                    return total;
                  }
                </script>

              </div>
            </div>
        </div>

  </section>


  <!-- 상품 소개 영상 섹션 -->
  <section id="intro-video" class="py-5">
    <div class="container text-center">
      <h1 class="main-title main-color">상품 상세</h1>
      <hr class="line">
      <div class="ratio ratio-16x9 my-5" id="video-container">
        <div id="player"></div>
      </div>
      <script th:inline="javascript">
        var mainVideo = `[[${product.mainVideo != null ? product.mainVideo.content : ''}]]` || '';
        var videoId = '';
        if (mainVideo) {
          // mainVideo가 유튜브 URL일 때 videoId 추출
          var match = String(mainVideo).match(/(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))([A-Za-z0-9_-]{11})/);
          if (match && match[1]) {
            videoId = match[1];
          }
        }
      </script>
      <script>
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        var player;
        function onYouTubeIframeAPIReady() {
          if( videoId === '' ) {
            // document.getElementById('player').innerHTML = '<p>상품 소개 영상이 없습니다.</p>';
            document.getElementById('video-container').style.display = 'none';
            return;
          }
          player = new YT.Player('player', {
            width: '100%',
            height: '100%',
            videoId: videoId,
            playerVars: {
              'autoplay': 1,
              'controls': 1,
              'rel': 0,
              'mute': 1
            },
            events: {
              'onReady': function(event) {
                event.target.playVideo();
              }
            }
          });
        }
      </script>
    </div>
  </section>

  <!-- 상품 상세 섹션 -->
  <section id="product-content">
    <div class="container my-5">
      
      <th:block th:if="${product.content != null and !#strings.isEmpty(product.content)}" th:utext="${product.content}"></th:block>
      <th:block th:unless="${product.content != null and !#strings.isEmpty(product.content)}">
        <img src="https://placehold.co/1320x2000" alt="1320x400 Placeholder" class="img-fluid">
      </th:block>
    </div>
  </section>

  <!-- 스페이스 : s-lg -->
  <div class="s-lg"></div>


  <!-- NEW - 상품목록 4컬럼 -->
  <section id="related" class="py-5">
    <div class="container">
      <h1 class="text-center main-title main-color py-5">관련상품</h1>
      <hr class="line">
      <!-- Swiper -->
      <div class="swiper related-products-swiper my-5">
        <div class="swiper-wrapper">
          <!-- 상품카드 -->
          <th:block th:each="product : ${relatedProducts}">
        <div class="swiper-slide">
          <div class="card h-100">
            <span th:if="${ product.isBest }" class="badge bg-primary position-absolute top-0 start-0 m-2" style="z-index:1;">BEST</span>
            <!-- 상품 이미지 -->
            <a th:href="@{/products/{id}(id=${product.id})}" class="p-img-box">
          <img th:if="${product.thumbImg != null and product.thumbImg.content != null}" th:src="${product.thumbImg.content}" th:alt="${product.name}" class="card-img-top p-img" style="width:100%;">
          <img th:unless="${product.thumbImg != null and product.thumbImg.content != null}" src="https://placehold.co/300x400?text=No+Image" alt="기본 배너 이미지" style="width:100%;">
            </a>
            <div class="card-body text-center">
          <h5 class="card-title" th:text="${ product.name }">상품명 1</h5>
          <p class="card-text" th:text="${ #numbers.formatInteger(product.price, 0, 'COMMA') + ' 원' }">₩10,000</p>
            </div>
            <div class="card-footer bg-transparent">
          <div class="d-flex justify-content-end align-items-center">
            <a th:href="@{/products/{id}(id=${product.id})}" class="btn btn-light">
              주문하기
            </a>
          </div>
            </div>
          </div>
        </div>
          </th:block>
        </div>
        <!-- Add Arrows -->
        <div class="swiper-button-next"></div>
        <div class="swiper-button-prev"></div>
      </div>

      <script>
        // Related Products Swiper 초기화
        var relatedSwiper = new Swiper('.related-products-swiper', {
          slidesPerView: 4,
          slidesPerGroup: 4,
          spaceBetween: 20,
          navigation: {
        nextEl: '.related-products-swiper .swiper-button-next',
        prevEl: '.related-products-swiper .swiper-button-prev',
          },
          // pagination: {
          //   el: '.related-products-swiper .swiper-pagination',
          //   clickable: true,
          // },
          breakpoints: {
        320: {
          slidesPerView: 1,
          slidesPerGroup: 1,
        },
        768: {
          slidesPerView: 2,
          slidesPerGroup: 2,
        },
        1024: {
          slidesPerView: 4,
          slidesPerGroup: 4,
        }
          }
        });
      </script>
    </div>
  </section>
    

</body>
</html>