<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{UI/layouts/user/my_layout}">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Account Deletion - FALCON</title>
</head>

<body layout:fragment="content">

  <div class="card">
    <div class="card-header">
      <h5>Account Deletion</h5>
    </div>
    <div class="card-body">
      <!-- 주의사항 -->
      <div class="alert alert-warning">
        <h6 class="d-flex align-items-center"><i class="material-icons">warning</i> Account Deletion Notice</h6>
        <ul class="mb-0">
          <li>All personal information will be deleted upon account deletion.</li>
          <li>Order history and reward points cannot be recovered.</li>
          <li>Re-registration with the same ID may not be possible.</li>
        </ul>
      </div>

      <!-- 탈퇴 사유 -->
      <!-- <div class="mb-4">
        <label class="form-label">탈퇴 사유 <span class="text-danger">*</span></label>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="deleteReason" id="reason1" value="서비스 불만족">
          <label class="form-check-label" for="reason1">서비스 불만족</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="deleteReason" id="reason2" value="이용빈도 낮음">
          <label class="form-check-label" for="reason2">이용빈도 낮음</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="deleteReason" id="reason3" value="개인정보 보호">
          <label class="form-check-label" for="reason3">개인정보 보호</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="deleteReason" id="reason4" value="기타">
          <label class="form-check-label" for="reason4">기타</label>
        </div>
        <textarea class="form-control mt-2" id="reasonDetail" placeholder="상세 사유를 입력해주세요 (선택사항)" rows="3"></textarea>
      </div> -->

      <!-- 비밀번호 확인 -->
      <div class="mb-4">
        <label for="password" class="form-label">Password Confirmation <span class="text-danger">*</span></label>
        <input type="hidden" class="form-control" th:value="${user.id}" id="id">
        <input type="password" class="form-control" id="password" placeholder="Please enter your current password" required>
      </div>

      <!-- 동의 체크박스 -->
      <div class="mb-4">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="agreeDelete" required>
          <label class="form-check-label" for="agreeDelete">
            I have read and understood all the above information and agree to account deletion. <span class="text-danger">*</span>
          </label>
        </div>
      </div>

      <!-- 버튼 -->
      <div class="d-flex gap-2 justify-content-end">
        <button type="button" class="btn btn-danger" id="deleteBtn" disabled>Delete Account</button>
      </div>
    </div>
  </div>

  <script>
    // 동의 체크박스 상태에 따른 버튼 활성화
    document.getElementById('agreeDelete').addEventListener('change', function () {
      document.getElementById('deleteBtn').disabled = !this.checked;
    });

    // 회원탈퇴 버튼 클릭
    document.getElementById('deleteBtn').addEventListener('click', async function () {
      const id = document.getElementById('id') ? document.getElementById('id').value : null;
      const password = document.getElementById('password').value;
      // const reason = document.querySelector('input[name="deleteReason"]:checked'); // 사유 미사용
      if (!password) {
        $alert('Input Error', 'Please enter your password.', 'warning');
        return;
      }
      // 1. 비밀번호 확인
      const checkResult = await $ajax({
        url: '/api/users/user/check-password',
        type: 'POST',
        data: { 
          password: password, id: id 
        },
      });
      if (!checkResult || checkResult === 'FAIL' || (checkResult.status && checkResult.status !== 200)) {
        $alert('Error', 'An error occurred while verifying password.', 'error');
        return;
      }
      if (checkResult === '비밀번호가 일치하지 않습니다.' || (checkResult.status && checkResult.status === 401)) {
        $alert('Password Error', 'Password does not match.', 'error');
        return;
      }
      // 2. 정말 탈퇴할지 확인
      $confirm('Account Deletion', 'Are you sure you want to delete your account? This action cannot be undone.', 'warning', 'Delete Account', 'Cancel').then(async (result) => {
        if (result.isConfirmed) {
          // 3. 실제 회원탈퇴 (DELETE)
          // 사용자 id는 서버에서 세션/인증정보로 처리하는 것이 안전하나, 예시로 username을 input hidden 등에서 받아올 수도 있음
          // 아래는 username을 id로 사용한다고 가정
          const id = document.getElementById('id') ? document.getElementById('id').value : null;
          if (!id) {
            $alert('Error', 'User information not found.', 'error');
            return;
          }
          const delResult = await $ajax({
            url: '/api/users/user/' + id,
            type: 'DELETE',
            data: {}
          });
          if (delResult && delResult !== 'FAIL') {
            $alert('Deletion Complete', 'Account deletion has been completed. Thank you for using our service.', 'success').then(() => {
              window.location.href = '/logout';
            });
          } else {
            $alert('Deletion Failed', 'An error occurred while processing account deletion.', 'error');
          }
        }
      });
    });
  </script>

</body>

</html>