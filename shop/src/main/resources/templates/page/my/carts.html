<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{UI/layouts/user/my_layout}">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>장바구니 - 분수마켓</title>
</head>

<body layout:fragment="content">

  <div class="card">
    <div class="card-header">
      <h5>장바구니</h5>
    </div>
    <div class="card-body">
      <!-- 장바구니 목록 -->
      <div class="cart-list">
        <!-- 전체 선택 및 선택 삭제 -->
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="selectAll">
            <label class="form-check-label" for="selectAll">
              전체 선택
            </label>
          </div>
          <button class="btn btn-outline-danger btn-sm" id="deleteSelected">선택 삭제</button>
        </div>
        
        <th:block th:each="cart : ${pageInfo.list}">
          <!-- 장바구니 항목 -->
          <div class="border p-3 mb-3 rounded cart-item">
            <div class="form-check mb-2">
              <input class="form-check-input item-check" type="checkbox">
            </div>
            <div class="row align-items-center">
              <div class="col-md-2">
                <img src="/img/products/p1.png" class="img-fluid" alt="상품 이미지">
              </div>
              <div class="col-md-8">
                <h6 th:text="${cart.product.name}">상품명</h6>
                <p class="text-muted mb-1">옵션:</p>
                <p class="text-muted mb-1"> 
                    <th:block th:each="item, optionStat : ${cart.cartItemOptions}">
                      <span th:text="${item.option.name} + ': ' + ${#numbers.formatInteger(item.option.price * item.quantity, 0, 'COMMA')}"></span>
                      <span th:text="|(${#numbers.formatInteger(item.option.price, 0, 'COMMA')}x${#numbers.formatInteger(item.quantity, 0, 'COMMA')})|">옵션명 (2개)</span>
                      <span th:if="!${optionStat.last}">, </span>
                    </th:block>
                </p>
              </div>
              <div class="col-md-2">
                <p class="fw-bold item-total-price" th:text="${#numbers.formatInteger(cart.totalPrice, 0, 'COMMA')}">₩0</p>
                <a th:href="@{/carts/create/{id}(id=${cart.id})}" class="btn btn-outline-primary btn-sm btn-order">주문하기</a>
                <button class="btn btn-outline-danger btn-sm delete-item btn-delete" th:data-id="${cart.id}">삭제</button>
              </div>
            </div>
          </div>
        </th:block>
        
        <!-- 장바구니가 비어있을 때 -->
        <th:block th:if="${pageInfo.list.size() == 0}">
          <div class="text-center py-5" id="empty-cart" style="display: none;">
            <i class="material-icons" style="font-size: 48px; color: #ccc;">shopping_cart</i>
            <p class="text-muted mt-3">장바구니가 비어있습니다.</p>
            <a href="/" class="btn btn-primary">쇼핑하러 가기</a>
          </div>
        </th:block>
      </div>
      
      <!-- 주문 요약 -->
      <div class="card mt-4">
        <div class="card-body">
          <div class="row">
            <div class="col-md-8">
              <h6>주문 요약</h6>
              <div class="d-flex justify-content-between">
                <span>선택 상품 (<span id="selected-count">2</span>개)</span>
                <span id="selected-total">₩35,000</span>
              </div>
              <div class="d-flex justify-content-between">
                <span>배송비</span>
                <span id="shipping-fee">₩3,000</span>
              </div>
              <hr>
              <div class="d-flex justify-content-between fw-bold">
                <span>총 결제금액</span>
                <span id="final-total" class="text-primary fs-5">₩38,000</span>
              </div>
            </div>
            <div class="col-md-4">
                <div class="d-flex flex-column align-items-between justify-content-between h-100">
                <button class="btn btn-primary btn-lg w-100" id="order-selected">선택상품 주문</button>
                <a href="/carts/create/all" class="btn btn-outline-primary btn-lg w-100" id="order-all">전체상품 주문</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 스페이스 : s-lg -->
  <div class="s-lg"></div>

  <script src="/js/common/ajax.js"></script>
  <script src="/js/common/alert.js"></script>
  <script>
    // 전체 선택/해제
    document.getElementById('selectAll').addEventListener('change', function() {
      const itemChecks = document.querySelectorAll('.item-check');
      itemChecks.forEach(check => {
        check.checked = this.checked;
      });
      updateOrderSummary();
    });
    
    // 개별 체크박스 상태 변경
    document.querySelectorAll('.item-check').forEach(check => {
      check.addEventListener('change', updateOrderSummary);
    });
    
    // 수량 증가/감소
    document.querySelectorAll('.increase-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const quantityInput = this.parentElement.querySelector('.quantity-input');
        const currentValue = parseInt(quantityInput.value);
        quantityInput.value = currentValue + 1;
        updateItemTotal(this.closest('.cart-item'));
        updateOrderSummary();
      });
    });
    
    document.querySelectorAll('.decrease-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const quantityInput = this.parentElement.querySelector('.quantity-input');
        const currentValue = parseInt(quantityInput.value);
        if (currentValue > 1) {
          quantityInput.value = currentValue - 1;
          updateItemTotal(this.closest('.cart-item'));
          updateOrderSummary();
        }
      });
    });
    
    // 개별 상품 삭제 (ajax)
    document.querySelectorAll('.delete-item').forEach(btn => {
      btn.addEventListener('click', function() {
        const cartId = this.dataset.id;
        $confirm('삭제 확인', '상품을 삭제하시겠습니까?', 'warning', '삭제', '취소').then(async (result) => {
          if (result.isConfirmed) {
            const delResult = await $ajax({
              url: '/api/users/cart/' + encodeURIComponent(cartId),
              type: 'DELETE',
              data: {}
            });
            if (delResult && delResult !== 'FAIL') {
              $toast_({ title: '삭제되었습니다', icon: 'success', timer: 1500 });
              this.closest('.cart-item').remove();
              updateOrderSummary();
              checkEmptyCart();
            } else {
              $alert('삭제 실패', '장바구니 삭제 중 오류가 발생했습니다.', 'error');
            }
          }
        });
      });
    });
    // 선택 삭제 (ajax)
    document.getElementById('deleteSelected').addEventListener('click', function() {
      const selectedItems = document.querySelectorAll('.item-check:checked');
      if (selectedItems.length === 0) {
        $alert('선택 없음', '삭제할 상품을 선택해주세요.', 'warning');
        return;
      }
      $confirm('선택 삭제', '선택한 상품을 모두 삭제하시겠습니까?', 'warning', '삭제', '취소').then(async (result) => {
        if (result.isConfirmed) {
          // 여러 개 삭제를 병렬 처리
          const deletePromises = Array.from(selectedItems).map(item => {
            const cartItem = item.closest('.cart-item');
            const btn = cartItem.querySelector('.delete-item');
            const cartId = btn.dataset.id;
            return $ajax({
              url: '/api/users/cart/' + encodeURIComponent(cartId),
              type: 'DELETE',
              data: {}
            }).then(res => ({ res, cartItem }));
          });
          const results = await Promise.all(deletePromises);
          let hasFail = false;
          results.forEach(({ res, cartItem }) => {
            if (res && res !== 'FAIL') {
              cartItem.remove();
            } else {
              hasFail = true;
            }
          });
          updateOrderSummary();
          checkEmptyCart();
          if (hasFail) {
            $alert('일부 실패', '일부 상품 삭제에 실패했습니다.', 'error');
          } else {
            $toast_({ title: '삭제되었습니다', icon: 'success', timer: 1500 });
          }
        }
      });
    });
    
    // 선택상품 주문
    document.getElementById('order-selected').addEventListener('click', function() {
      const selectedItems = document.querySelectorAll('.item-check:checked');
      if (selectedItems.length === 0) {
        $alert('선택 없음', '주문할 상품을 선택해주세요.', 'warning');
        return;
      }
      // 선택된 cart id 수집
      const ids = Array.from(selectedItems).map(item => {
        const cartItem = item.closest('.cart-item');
        const btn = cartItem.querySelector('.delete-item');
        return btn.dataset.id;
      }).join(',');
      // 주문 생성 페이지로 이동
      window.location.href = '/carts/create/list/' + ids;
    });
    
    // 상품별 총액 업데이트
    function updateItemTotal(cartItem) {
      const priceElements = cartItem.querySelectorAll('.text-muted');
      const priceText = priceElements[1].textContent; // 두 번째 .text-muted 요소 (가격)
      const price = parseInt(priceText.replace(/[^\d]/g, ''));
      const quantity = parseInt(cartItem.querySelector('.quantity-input').value);
      const total = price * quantity;
      cartItem.querySelector('.item-total-price').textContent = '₩' + total.toLocaleString();
    }
    
    // 주문 요약 업데이트
    function updateOrderSummary() {
      const checkedItems = document.querySelectorAll('.item-check:checked');
      let totalPrice = 0;
      
      checkedItems.forEach(item => {
        const cartItem = item.closest('.cart-item');
        const totalText = cartItem.querySelector('.item-total-price').textContent;
        const price = parseInt(totalText.replace(/[^\d]/g, ''));
        totalPrice += price;
      });
      
      const shippingFee = totalPrice > 0 ? 3000 : 0;
      const finalTotal = totalPrice + shippingFee;
      
      document.getElementById('selected-count').textContent = checkedItems.length;
      document.getElementById('selected-total').textContent = '₩' + totalPrice.toLocaleString();
      document.getElementById('shipping-fee').textContent = '₩' + shippingFee.toLocaleString();
      document.getElementById('final-total').textContent = '₩' + finalTotal.toLocaleString();
    }
    
    // 빈 장바구니 체크
    function checkEmptyCart() {
      const cartItems = document.querySelectorAll('.cart-item');
      const emptyCart = document.getElementById('empty-cart');
      
      if (cartItems.length === 0) {
        emptyCart.style.display = 'block';
      } else {
        emptyCart.style.display = 'none';
      }
    }
    
    // 초기 주문 요약 업데이트
    updateOrderSummary();
  </script>

</body>

</html>