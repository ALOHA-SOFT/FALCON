<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{UI/layouts/user/main_layout}"
      >
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FALCON</title>
</head>
<body layout:fragment="content">

  <div class="container my-5">
    <div class="row justify-content-center">
      <div class="col-lg-6 col-md-8 col-sm-10">
        <h2 class="mb-4 text-center">회원가입</h2>
        <form id="form" th:object="${user}" class="needs-validation" novalidate>
          <!-- 💍 CSRF TOKEN -->
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <div class="mb-3">
            <label for="username" class="form-label">아이디</label>
            <div class="input-group">
              <input type="text" class="form-control" id="username" name="username" required maxlength="30" placeholder="아이디를 입력하세요" autofocus>
              <button type="button" class="btn btn-outline-secondary" id="checkUsernameBtn">중복검사</button>
            </div>
            <div id="usernameFeedback" class="form-text"></div>
            </div>
            <script>
            document.addEventListener('DOMContentLoaded', function() {
              const checkBtn = document.getElementById('checkUsernameBtn');
              const usernameInput = document.getElementById('username');
              const feedback = document.getElementById('usernameFeedback');
              let isUsernameChecked = false; // 중복검사 여부 플래그
              let isUsernameAvailable = false; // 사용가능 여부 플래그
              
              // 아이디 입력 시 중복검사 상태 초기화
              usernameInput.addEventListener('input', function() {
                isUsernameChecked = false;
                isUsernameAvailable = false;
                feedback.textContent = '';
                feedback.className = 'form-text';
              });
              
              checkBtn.addEventListener('click', function() {
                const username = usernameInput.value.trim();
                if (!username) {
                  feedback.textContent = '아이디를 입력하세요.';
                  feedback.className = 'form-text text-danger';
                  usernameInput.focus();
                  return;
                }
                $ajax({
                  url: '/api/users/user/check-username',
                  type: 'GET',
                  data: { username }
                }).then(res => {
                  isUsernameChecked = true;
                  if (res.available) {
                    isUsernameAvailable = true;
                    feedback.textContent = '사용 가능한 아이디입니다.';
                    feedback.className = 'form-text text-success';
                  } else {
                    isUsernameAvailable = false;
                    feedback.textContent = '이미 사용 중인 아이디입니다.';
                    feedback.className = 'form-text text-danger';
                  }
                }).catch(() => {
                  isUsernameChecked = false;
                  isUsernameAvailable = false;
                  feedback.textContent = '중복 확인 중 오류가 발생했습니다.';
                  feedback.className = 'form-text text-danger';
                });
              });
              
              // 전역에서 접근할 수 있도록 window 객체에 할당
              window.checkUsernameStatus = function() {
                return { isUsernameChecked, isUsernameAvailable };
              };
            });
            </script>
          <div class="mb-3">
            <label for="password" class="form-label">비밀번호</label>
            <input type="password" class="form-control" id="password" name="password" required maxlength="30" placeholder="비밀번호를 입력하세요">
          </div>
          <div class="mb-3">
            <label for="passwordConfirm" class="form-label">비밀번호 확인</label>
            <input type="password" class="form-control" id="passwordConfirm" name="passwordConfirm" required maxlength="30" placeholder="비밀번호를 다시 입력하세요">
          </div>
          <div class="mb-3">
            <label for="name" class="form-label">이름</label>
            <input type="text" class="form-control" id="name" name="name" required maxlength="30" placeholder="이름을 입력하세요">
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="firstName" class="form-label">First Name</label>
                <input type="text" class="form-control" id="firstName" name="firstName" required maxlength="50" placeholder="First Name">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="lastName" class="form-label">Last Name</label>
                <input type="text" class="form-control" id="lastName" name="lastName" required maxlength="50" placeholder="Last Name">
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label for="email" class="form-label">이메일</label>
            <input type="email" class="form-control" id="email" name="email" required maxlength="50" placeholder="이메일을 입력하세요">
          </div>
          <div class="mb-3">
            <label for="tel" class="form-label">전화번호</label>
            <input type="tel" class="form-control" id="tel" name="tel" required maxlength="20" placeholder="예: 01012345678 (- 없이 입력)">
          </div>
          <div class="my-5">
            <h5 class="mb-3 text-center">약관 동의</h5>
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="agreeAll" onclick="
              const checked = this.checked;
              document.querySelectorAll(
                '#agree1, #agree2, #agree3, #marketing, #mailing, #sms, #age18'
              ).forEach(cb => { cb.checked = checked; });
              ">
              <label class="form-check-label fw-bold cursor-pointer user-select-none" for="agreeAll">
              약관 전체 동의
              </label>
            </div>
            <ul class="list-group mb-2">
              <li class="list-group-item d-flex align-items-center">
                <div class="form-check flex-grow-1">
                  <input class="form-check-input" type="checkbox" id="agree1" name="agree" required>
                  <label class="form-check-label cursor-pointer user-select-none" for="agree1">
                    쇼핑몰 이용약관 <span class="text-danger ms-1">(필수)</span>
                  </label>
                </div>
                <a href="javascript:;" class="me-2 text-decoration-underline" data-bs-toggle="modal" data-bs-target="#agreementDeatilLayer">보기</a>
              </li>
              <li class="list-group-item d-flex align-items-center">
                <div class="form-check flex-grow-1">
                  <input class="form-check-input" type="checkbox" id="agree2" name="agree2" required>
                  <label class="form-check-label cursor-pointer user-select-none" for="agree2">
                    개인정보 수집 및 이용 <span class="text-danger ms-1">(필수)</span>
                  </label>
                </div>
                <a href="javascript:void(0)" class="me-2 text-decoration-underline" data-bs-toggle="modal" data-bs-target="#privacyDeatilLayer">보기</a>
              </li>
              <li class="list-group-item d-flex align-items-center">
                <div class="form-check flex-grow-1">
                  <input class="form-check-input" type="checkbox" id="agree3" name="agree3">
                  <label class="form-check-label cursor-pointer user-select-none" for="agree3">
                    개인정보 수집 및 이용 <span class="text-secondary ms-1">(선택)</span>
                  </label>
                </div>
                <a href="javascript:void(0)" class="me-2 text-decoration-underline" data-bs-toggle="modal" data-bs-target="#joinformDeatilLayer">보기</a>
              </li>
              <li class="list-group-item">
                <div class="d-flex align-items-center mb-2">
                    <div class="form-check flex-grow-1">
                      <input class="form-check-input" type="checkbox" id="marketing" name="marketing" 
                        onclick="checkMarketing()">
                      <label class="form-check-label cursor-pointer user-select-none" for="marketing">
                        마케팅 및 광고 활용 동의 <span class="text-secondary ms-1">(선택)</span>
                      </label>
                    </div>
                    <a href="javascript:void(0)" class="me-2 text-decoration-underline" data-bs-toggle="modal" data-bs-target="#marketingDeatilLayer">보기</a>
                    <script>
                      function checkMarketing() {
                        const marketing = document.getElementById('marketing');
                        const mailing = document.getElementById('mailing');
                        const sms = document.getElementById('sms');
                        if (marketing.checked) {
                          mailing.checked = true;
                          sms.checked = true;
                        } else {
                          mailing.checked = false;
                          sms.checked = false;
                        }
                      }
                    </script>
                </div>
                <div class="ms-4">
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="mailing" name="mailing">
                    <label class="form-check-label cursor-pointer user-select-none" for="mailing">이메일 수신</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="checkbox" id="sms" name="sms">
                    <label class="form-check-label cursor-pointer user-select-none" for="sms">SMS 수신</label>
                  </div>
                </div>
              </li>
              <li>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="age18" name="age18" required>
                  <label class="form-check-label cursor-pointer user-select-none" for="age18">
                    만 18세 이상입니다. <span class="text-danger ms-1">(필수)</span>
                  </label>
                </div>
              </li>
            </ul>
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-primary">회원가입</button>
          </div>
        </form>
        
      </div>
    </div>
  </div>

  <!-- 이용약관 모달 레이어 -->
  <div class="modal fade" id="agreementDeatilLayer" tabindex="-1" aria-labelledby="agreementDeatilLayerLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="agreementDeatilLayerLabel">이용약관</h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <iframe src="/terms/이용약관.html" style="width:100%; height:400px; border:1px solid #ddd; border-radius:4px;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <!-- 개인정보 수집 및 이용 (필수) 모달 레이어 -->
  <div class="modal fade" id="privacyDeatilLayer" tabindex="-1" aria-labelledby="privacyDeatilLayerLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="privacyDeatilLayerLabel">개인정보 수집 및 이용 (필수)</h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <iframe src="/terms/개인정보수집및이용(필수).html" style="width:100%; height:400px; border:1px solid #ddd; border-radius:4px;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <!-- 개인정보 수집 및 이용 (선택) 모달 레이어 -->
  <div class="modal fade" id="joinformDeatilLayer" tabindex="-1" aria-labelledby="joinformDeatilLayerLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="joinformDeatilLayerLabel">개인정보 수집 및 이용 (선택)</h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <iframe src="/terms/개인정보수집및이용(선택).html" style="width:100%; height:400px; border:1px solid #ddd; border-radius:4px;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <!-- 마케팅 및 광고 활용 동의 모달 레이어 -->
  <div class="modal fade" id="marketingDeatilLayer" tabindex="-1" aria-labelledby="marketingDeatilLayerLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="marketingDeatilLayerLabel">마케팅 및 광고 활용 동의</h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <iframe src="/terms/마케팅및광고활용동의.html" style="width:100%; height:400px; border:1px solid #ddd; border-radius:4px;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 폼 유효성 검사
    (function() {
      'use strict';
      window.addEventListener('load', function() {
        const forms = document.getElementsByClassName('needs-validation');
        Array.prototype.filter.call(forms, function(form) {
          form.addEventListener('submit', function(event) {
            // 아이디 중복 검사 확인
            const usernameStatus = window.checkUsernameStatus();
            if (!usernameStatus.isUsernameChecked) {
              event.preventDefault();
              event.stopPropagation();
              $alert({
                  title: '아이디 중복 검사 필요',
                  text: '아이디 중복 검사를 먼저 진행해주세요.',
                  icon: 'warning',
                  confirmButtonText: '확인'
              });
              return false;
            }
            
            if (!usernameStatus.isUsernameAvailable) {
              event.preventDefault();
              event.stopPropagation();
              $alert({
                  title: '아이디 중복',
                  text: '사용 가능한 아이디로 변경해주세요.',
                  icon: 'warning',
                  confirmButtonText: '확인'
              });
              return false;
            }
            
            // 필수 약관 동의 확인
            const agree1 = document.getElementById('agree1');
            const agree2 = document.getElementById('agree2');
            const age18 = document.getElementById('age18');
            
            if (!agree1.checked || !agree2.checked || !age18.checked) {
              event.preventDefault();
              event.stopPropagation();
              $alert({
                  title: '필수 약관 동의 필요',
                  text: '필수 약관에 동의해주세요.',
                  icon: 'warning',
                  confirmButtonText: '확인'
              });
              return false;
            }

            // 비밀번호 확인
            const password = document.getElementById('password');
            const passwordConfirm = document.getElementById('passwordConfirm');
            
            if (password.value !== passwordConfirm.value) {
              event.preventDefault();
              event.stopPropagation();
              $alert({
                  title: '비밀번호 확인',
                  text: '비밀번호가 일치하지 않습니다.',
                  icon: 'warning',
                  confirmButtonText: '확인'
              });
              passwordConfirm.focus();
              return false;
            }

            if (!form.checkValidity()) {
              event.preventDefault();
              event.stopPropagation();
            } else {
              // 비동기 요청으로 처리
              event.preventDefault();
              event.stopPropagation();
              
              // 폼 데이터 수집 (FormData 대신 일반 객체 사용)
              const formData = {};
              const formElements = new FormData(form);
              for (let [key, value] of formElements.entries()) {
                formData[key] = value;
              }
              
              // 비동기 요청
              $ajax({
                url: '/api/users/user',
                type: 'POST',
                data: formData
              }).then(response => {
                console.log('회원가입 성공:', response);
                $alert({
                  title: '회원가입 성공',
                  text: '회원가입이 완료되었습니다.',
                  icon: 'success',
                  confirmButtonText: '확인'
                }).then(() => {
                  window.location.href = '/login'; // 로그인 페이지로 이동
                });
              }).catch(error => {
                console.error('회원가입 실패:', error);
                $alert({
                  title: '회원가입 실패',
                  text: '회원가입 중 오류가 발생했습니다. 다시 시도해주세요.',
                  icon: 'error',
                  confirmButtonText: '확인'
                });
              });
            }
            form.classList.add('was-validated');
          }, false);
        });
      }, false);
    })();
  </script>
</body>
</html>