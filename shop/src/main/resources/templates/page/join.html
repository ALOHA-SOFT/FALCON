<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{UI/layouts/user/main_layout}"
      >
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Falcon Cartons</title>
</head>
<body layout:fragment="content">

  <div class="container my-5">
    <div class="row justify-content-center">
      <div class="col-lg-6 col-md-8 col-sm-10">
  <h2 class="mb-4 text-center">Sign Up</h2>
        <form id="form" th:object="${user}" class="needs-validation" novalidate>
          <!-- üíç CSRF TOKEN -->
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <div class="mb-3">
            <label for="username" class="form-label">Username</label>
            <div class="input-group">
              <input type="text" class="form-control" id="username" name="username" required maxlength="30" placeholder="Enter your username" autofocus>
              <button type="button" class="btn btn-outline-secondary" id="checkUsernameBtn">Check Duplicate</button>
            </div>
            <div id="usernameFeedback" class="form-text"></div>
            </div>
            <script>
            document.addEventListener('DOMContentLoaded', function() {
              const checkBtn = document.getElementById('checkUsernameBtn');
              const usernameInput = document.getElementById('username');
              const feedback = document.getElementById('usernameFeedback');
              let isUsernameChecked = false; // Duplicate check flag
              let isUsernameAvailable = false; // Availability flag
              
              // Reset duplicate check status when username is entered
              usernameInput.addEventListener('input', function() {
                isUsernameChecked = false;
                isUsernameAvailable = false;
                feedback.textContent = '';
                feedback.className = 'form-text';
              });
              
              checkBtn.addEventListener('click', function() {
                const username = usernameInput.value.trim();
                if (!username) {
                  feedback.textContent = 'Please enter your username.';
                  feedback.className = 'form-text text-danger';
                  usernameInput.focus();
                  return;
                }
                $ajax({
                  url: '/api/users/user/check-username',
                  type: 'GET',
                  data: { username }
                }).then(res => {
                  isUsernameChecked = true;
                  if (res.available) {
                    isUsernameAvailable = true;
                    feedback.textContent = 'Username is available.';
                    feedback.className = 'form-text text-success';
                  } else {
                    isUsernameAvailable = false;
                    feedback.textContent = 'Username is already taken.';
                    feedback.className = 'form-text text-danger';
                  }
                }).catch(() => {
                  isUsernameChecked = false;
                  isUsernameAvailable = false;
                  feedback.textContent = 'Error occurred during duplicate check.';
                  feedback.className = 'form-text text-danger';
                });
              });
              
              // Ï†ÑÏó≠ÏóêÏÑú Ï†ëÍ∑ºÌï† Ïàò ÏûàÎèÑÎ°ù window Í∞ùÏ≤¥Ïóê Ìï†Îãπ
              window.checkUsernameStatus = function() {
                return { isUsernameChecked, isUsernameAvailable };
              };
            });
            </script>
          <div class="mb-3">
            <label for="password" class="form-label">Password</label>
            <input type="password" class="form-control" id="password" name="password" required maxlength="30" placeholder="Enter your password">
          </div>
          <div class="mb-3">
            <label for="passwordConfirm" class="form-label">Confirm Password</label>
            <input type="password" class="form-control" id="passwordConfirm" name="passwordConfirm" required maxlength="30" placeholder="Re-enter your password">
          </div>
          <div class="mb-3">
            <label for="name" class="form-label">Name (Nickname)</label>
            <input type="text" class="form-control" id="name" name="name" required maxlength="30" placeholder="Enter your name">
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="firstName" class="form-label">First Name</label>
                <input type="text" class="form-control" id="firstName" name="firstName" required maxlength="50" placeholder="First Name">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="lastName" class="form-label">Last Name</label>
                <input type="text" class="form-control" id="lastName" name="lastName" required maxlength="50" placeholder="Last Name">
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label for="email" class="form-label">Email</label>
            <input type="email" class="form-control" id="email" name="email" required maxlength="50" placeholder="Enter your email">
          </div>
          <div class="my-5">
            <h5 class="mb-3 text-center">Agreement</h5>
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" id="agreeAll" onclick="
              const checked = this.checked;
              document.querySelectorAll(
                '#agree1, #agree2, #agree3, #marketing, #mailing, #sms, #age18'
              ).forEach(cb => { cb.checked = checked; });
              ">
              <label class="form-check-label fw-bold cursor-pointer user-select-none" for="agreeAll">
              Agree to All Terms
              </label>
            </div>
            <ul class="list-group mb-2">
              <li class="list-group-item d-flex align-items-center">
                <div class="form-check flex-grow-1">
                  <input class="form-check-input" type="checkbox" id="agree1" name="agree" required>
                  <label class="form-check-label cursor-pointer user-select-none" for="agree1">
                    Shopping Mall Terms <span class="text-danger ms-1">(Required)</span>
                  </label>
                </div>
                <!-- <a href="javascript:;" class="me-2 text-decoration-underline" data-bs-toggle="modal" data-bs-target="#agreementDeatilLayer">View</a> -->
              </li>
              <li class="list-group-item d-flex align-items-center">
                <div class="form-check flex-grow-1">
                  <input class="form-check-input" type="checkbox" id="agree2" name="agree2" required>
                  <label class="form-check-label cursor-pointer user-select-none" for="agree2">
                    Personal Information Collection & Use <span class="text-danger ms-1">(Required)</span>
                  </label>
                </div>
                <!-- <a href="javascript:void(0)" class="me-2 text-decoration-underline" data-bs-toggle="modal" data-bs-target="#privacyDeatilLayer">View</a> -->
              </li>
              <li>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="age18" name="age18" required>
                  <label class="form-check-label cursor-pointer user-select-none" for="age18">
                    I am over 18 years old. <span class="text-danger ms-1">(Required)</span>
                  </label>
                </div>
              </li>
            </ul>
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-primary">Sign Up</button>
          </div>
        </form>
        
      </div>
    </div>
  </div>

  <!-- Ïù¥Ïö©ÏïΩÍ¥Ä Î™®Îã¨ Î†àÏù¥Ïñ¥ -->
  <div class="modal fade" id="agreementDeatilLayer" tabindex="-1" aria-labelledby="agreementDeatilLayerLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="agreementDeatilLayerLabel">Terms of Use</h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <iframe src="/terms/Ïù¥Ïö©ÏïΩÍ¥Ä.html" style="width:100%; height:400px; border:1px solid #ddd; border-radius:4px;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <!-- Í∞úÏù∏Ï†ïÎ≥¥ ÏàòÏßë Î∞è Ïù¥Ïö© (ÌïÑÏàò) Î™®Îã¨ Î†àÏù¥Ïñ¥ -->
  <div class="modal fade" id="privacyDeatilLayer" tabindex="-1" aria-labelledby="privacyDeatilLayerLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="privacyDeatilLayerLabel">Personal Information Collection & Use (Required)</h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <iframe src="/terms/Í∞úÏù∏Ï†ïÎ≥¥ÏàòÏßëÎ∞èÏù¥Ïö©(ÌïÑÏàò).html" style="width:100%; height:400px; border:1px solid #ddd; border-radius:4px;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <!-- Í∞úÏù∏Ï†ïÎ≥¥ ÏàòÏßë Î∞è Ïù¥Ïö© (ÏÑ†ÌÉù) Î™®Îã¨ Î†àÏù¥Ïñ¥ -->
  <div class="modal fade" id="joinformDeatilLayer" tabindex="-1" aria-labelledby="joinformDeatilLayerLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="joinformDeatilLayerLabel">Personal Information Collection & Use (Optional)</h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <iframe src="/terms/Í∞úÏù∏Ï†ïÎ≥¥ÏàòÏßëÎ∞èÏù¥Ïö©(ÏÑ†ÌÉù).html" style="width:100%; height:400px; border:1px solid #ddd; border-radius:4px;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <!-- ÎßàÏºÄÌåÖ Î∞è Í¥ëÍ≥† ÌôúÏö© ÎèôÏùò Î™®Îã¨ Î†àÏù¥Ïñ¥ -->
  <div class="modal fade" id="marketingDeatilLayer" tabindex="-1" aria-labelledby="marketingDeatilLayerLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="marketingDeatilLayerLabel">Marketing & Advertising Consent</h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <iframe src="/terms/ÎßàÏºÄÌåÖÎ∞èÍ¥ëÍ≥†ÌôúÏö©ÎèôÏùò.html" style="width:100%; height:400px; border:1px solid #ddd; border-radius:4px;"></iframe>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Ìèº Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
    (function() {
      'use strict';
      window.addEventListener('load', function() {
        const forms = document.getElementsByClassName('needs-validation');
        Array.prototype.filter.call(forms, function(form) {
          form.addEventListener('submit', function(event) {
            // ÏïÑÏù¥Îîî Ï§ëÎ≥µ Í≤ÄÏÇ¨ ÌôïÏù∏
            const usernameStatus = window.checkUsernameStatus();
            if (!usernameStatus.isUsernameChecked) {
              event.preventDefault();
              event.stopPropagation();
              $alert({
                  title: 'Duplicate Check Required',
                  text: 'Please check for duplicate username first.',
                  icon: 'warning',
                  confirmButtonText: 'OK'
              });
              return false;
            }
            
            if (!usernameStatus.isUsernameAvailable) {
              event.preventDefault();
              event.stopPropagation();
              $alert({
                  title: 'Duplicate Username',
                  text: 'Please use an available username.',
                  icon: 'warning',
                  confirmButtonText: 'OK'
              });
              return false;
            }
            
            // ÌïÑÏàò ÏïΩÍ¥Ä ÎèôÏùò ÌôïÏù∏
            const agree1 = document.getElementById('agree1');
            const agree2 = document.getElementById('agree2');
            const age18 = document.getElementById('age18');
            
            if (!agree1.checked || !agree2.checked || !age18.checked) {
              event.preventDefault();
              event.stopPropagation();
              $alert({
                  title: 'Required Agreement',
                  text: 'Please agree to the required terms.',
                  icon: 'warning',
                  confirmButtonText: 'OK'
              });
              return false;
            }

            // ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏
            const password = document.getElementById('password');
            const passwordConfirm = document.getElementById('passwordConfirm');
            
            if (password.value !== passwordConfirm.value) {
              event.preventDefault();
              event.stopPropagation();
              $alert({
                  title: 'Password Confirmation',
                  text: 'Passwords do not match.',
                  icon: 'warning',
                  confirmButtonText: 'OK'
              });
              passwordConfirm.focus();
              return false;
            }

            if (!form.checkValidity()) {
              event.preventDefault();
              event.stopPropagation();
            } else {
              // ÎπÑÎèôÍ∏∞ ÏöîÏ≤≠ÏúºÎ°ú Ï≤òÎ¶¨
              event.preventDefault();
              event.stopPropagation();
              
              // Ìèº Îç∞Ïù¥ÌÑ∞ ÏàòÏßë (FormData ÎåÄÏã† ÏùºÎ∞ò Í∞ùÏ≤¥ ÏÇ¨Ïö©)
              const formData = {};
              const formElements = new FormData(form);
              for (let [key, value] of formElements.entries()) {
                formData[key] = value;
              }
              
              // ÎπÑÎèôÍ∏∞ ÏöîÏ≤≠
              $ajax({
                url: '/api/users/user',
                type: 'POST',
                data: formData
              }).then(response => {
                console.log('Sign up success:', response);
                $alert({
                  title: 'Sign Up Success',
                  text: 'Sign up completed.',
                  icon: 'success',
                  confirmButtonText: 'OK'
                }).then(() => {
                  window.location.href = '/login'; // Go to login page
                });
              }).catch(error => {
                console.error('Sign up failed:', error);
                $alert({
                  title: 'Sign Up Failed',
                  text: 'An error occurred during sign up. Please try again.',
                  icon: 'error',
                  confirmButtonText: 'OK'
                });
              });
            }
            form.classList.add('was-validated');
          }, false);
        });
      }, false);
    })();
  </script>
</body>
</html>