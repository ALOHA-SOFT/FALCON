1. EC2 생성 
 - t3.small
2. RDS 생성
 - db.t3.small
3. EIP
 - 13.134.116.196
4. S3
5. CloudFront 배포
 - d3do8c8a4htaja.cloudfront.net
6. Code Pipeline + CodeBuild 설정 (GitHub → EC2 자동 배포)

## 6-0 PEM KEY 보안설정
1. 속성
2. 보안 탭
3. 다른 사용자 다 제거
4. 편집 > 현재 사용자
5. 읽기 및 실행, 읽기 권한 체크


## 6-1. AWS CLI 설정 및 EC2 준비

### IAM 사용자 생성
1. IAM → 사용자 → 해당 사용자 선택
2. 보안 자격 증명 탭
3. 액세스 키 만들기 클릭
4. Access Key ID와 Secret Access Key 저장 (보안상 실제 키는 별도 보관)

### AWS 콘솔에서 권한 추가:
IAM → 사용자 → falcon-dev 선택
권한 탭 → 권한 추가
정책 직접 연결 → 다음 정책들 선택:
관리자 권한:
AdministratorAccess (전체 권한)


### AWS CLI 설정 확인
```bash
# AWS CLI 인증 확인
aws sts get-caller-identity

# 새 프로파일로 AWS 자격 증명 설정
aws configure --profile falcon-shop

# 리전 설정 (서울)
aws configure set default.region ap-northeast-2

# 리전 설정 (유럽(런던))
aws configure set default.region eu-west-2

# 이후 모든 명령어에 --profile falcon-shop 추가
aws sts get-caller-identity --profile falcon-shop
aws ec2 describe-instances --profile falcon-shop
```

### EC2 인스턴스 설정 (SSH 접속 후 실행)
```bash
# EC2에 SSH 접속
ssh -i your-key.pem ec2-user@13.134.116.196
ssh -i E:\DEV\FALCON\NOTE\AWS\falcon-key.pem ec2-user@13.134.116.196

# CodeDeploy Agent 설치
sudo yum update -y
sudo yum install -y ruby wget
cd /home/ec2-user
wget https://aws-codedeploy-ap-northeast-2.s3.ap-northeast-2.amazonaws.com/latest/install
chmod +x ./install
sudo ./install auto

# Java 17 설치
sudo yum install -y java-17-amazon-corretto

# 애플리케이션 디렉토리 생성
sudo mkdir -p /opt/falcon-shop
sudo chown ec2-user:ec2-user /opt/falcon-shop

# EC2 인스턴스에 태그 추가 (CodeDeploy에서 인식용)
exit
```

### EC2 인스턴스 태그 추가 (로컬에서 실행)
```bash
# EC2 인스턴스 ID 확인
aws ec2 describe-instances --query 'Reservations[].Instances[].[InstanceId,PublicIpAddress,Tags[?Key==`Name`].Value|[0]]' --output table

# 인스턴스에 태그 추가 (INSTANCE_ID를 실제 ID로 변경)
INSTANCE_ID="i-07340d027581e607b"
aws ec2 create-tags --resources $INSTANCE_ID --tags Key=Name,Value=falcon-shop-server Key=Environment,Value=production
```

## 6-2. IAM 역할 생성 (AWS CLI)

### CodeBuild용 IAM 역할
```bash
# 신뢰 정책 파일 생성
'{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "codebuild.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}' | Out-File -FilePath "codebuild-trust-policy.json" -Encoding ASCII

# CodeBuild 역할 생성
aws iam create-role --role-name FalconCodeBuildRole --assume-role-policy-document file://codebuild-trust-policy.json

# 필요한 정책 연결
aws iam attach-role-policy --role-name FalconCodeBuildRole --policy-arn arn:aws:iam::aws:policy/CloudWatchLogsFullAccess
aws iam attach-role-policy --role-name FalconCodeBuildRole --policy-arn arn:aws:iam::aws:policy/AmazonS3FullAccess
```

### CodeDeploy용 IAM 역할
```bash
# 신뢰 정책 파일 생성
'{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "codedeploy.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}' | Out-File -FilePath "codedeploy-trust-policy.json" -Encoding ASCII

# CodeDeploy 역할 생성
aws iam create-role --role-name FalconCodeDeployRole --assume-role-policy-document file://codedeploy-trust-policy.json

# 정책 연결
aws iam attach-role-policy --role-name FalconCodeDeployRole --policy-arn arn:aws:iam::aws:policy/service-role/AWSCodeDeployRole
```

### EC2용 IAM 역할 및 인스턴스 프로파일
```bash
# EC2 신뢰 정책 파일 생성
'{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "ec2.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}' | Out-File -FilePath "ec2-trust-policy.json" -Encoding ASCII



# EC2 역할 생성
aws iam create-role --role-name FalconEC2Role --assume-role-policy-document file://ec2-trust-policy.json

# 정책 연결
aws iam attach-role-policy --role-name FalconEC2Role --policy-arn arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess
aws iam attach-role-policy --role-name FalconEC2Role --policy-arn arn:aws:iam::aws:policy/service-role/AWSCodeDeployRole

# 인스턴스 프로파일 생성 및 역할 연결
aws iam create-instance-profile --instance-profile-name FalconEC2InstanceProfile
aws iam add-role-to-instance-profile --instance-profile-name FalconEC2InstanceProfile --role-name FalconEC2Role

# EC2 인스턴스에 인스턴스 프로파일 연결 (INSTANCE_ID를 실제 ID로 변경)
INSTANCE_ID="i-07340d027581e607b"
aws ec2 associate-iam-instance-profile --instance-id $INSTANCE_ID --iam-instance-profile Name=FalconEC2InstanceProfile
```

## 6-3. S3 버킷 생성 (AWS CLI) ✅ 완료
```bash
# 아티팩트 저장용 S3 버킷 생성 (완료됨)
aws s3 mb s3://falcon-shop-artifacts --region eu-west-2

# 버킷 확인
aws s3 ls | grep falcon-shop
```

## 6-4. CodeBuild 프로젝트 생성 (AWS CLI) ✅ 완료
```bash
# CodeBuild 프로젝트 설정 파일 생성 (완료됨)
@'
{
  "name": "falcon-shop-build",
  "description": "Falcon Shop Spring Boot application build project",
  "source": {
    "type": "GITHUB",
    "location": "https://github.com/ALOHA-SOFT/FALCON.git",
    "buildspec": "buildspec.yml"
  },
  "artifacts": {
    "type": "S3",
    "location": "falcon-shop-artifacts",
    "packaging": "ZIP"
  },
  "environment": {
    "type": "LINUX_CONTAINER",
    "image": "aws/codebuild/amazonlinux2-x86_64-standard:5.0",
    "computeType": "BUILD_GENERAL1_SMALL"
  },
  "serviceRole": "arn:aws:iam::516723930299:role/FalconCodeBuildRole"
}
'@ | Out-File -FilePath "codebuild-project.json" -Encoding ASCII

# CodeBuild 프로젝트 생성 (완료됨)
aws codebuild create-project --cli-input-json file://codebuild-project.json

# 프로젝트 ARN: arn:aws:codebuild:eu-west-2:516723930299:project/falcon-shop-build
```

## 6-5. WAR 파일 배포 방식 (Tomcat 사용)
Spring Boot WAR 파일을 Tomcat에 배포하는 방식을 사용합니다.

### EC2에 Tomcat 설치 및 설정
```bash
# EC2에 SSH 접속
ssh -i E:\DEV\FALCON\NOTE\AWS\falcon-key.pem ec2-user@13.134.116.196

# Tomcat 9 설치
sudo yum update -y
sudo yum install -y java-17-amazon-corretto tomcat

# Tomcat 서비스 시작 및 활성화
sudo systemctl start tomcat
sudo systemctl enable tomcat

# Tomcat 포트 확인 (기본 8080)
sudo netstat -tlnp | grep :8080

# 배포 디렉토리 권한 설정
sudo chown -R tomcat:tomcat /var/lib/tomcat/webapps/
sudo chmod 755 /var/lib/tomcat/webapps/

# 배포 스크립트 생성
cat > /home/ec2-user/deploy-war.sh << 'EOF'
#!/bin/bash
# FALCON Shop WAR 배포 스크립트

APP_NAME="falcon-shop"
TOMCAT_WEBAPPS="/var/lib/tomcat/webapps"
BACKUP_DIR="/home/ec2-user/backup"
S3_BUCKET="falcon-shop-artifacts"

# 백업 디렉토리 생성
mkdir -p $BACKUP_DIR

# Tomcat 중지
sudo systemctl stop tomcat

# 기존 애플리케이션 백업 및 제거
if [ -d "$TOMCAT_WEBAPPS/${APP_NAME}" ]; then
    sudo mv $TOMCAT_WEBAPPS/${APP_NAME} $BACKUP_DIR/${APP_NAME}-$(date +%Y%m%d_%H%M%S)
    echo "기존 애플리케이션 백업 완료"
fi

if [ -f "$TOMCAT_WEBAPPS/${APP_NAME}.war" ]; then
    sudo mv $TOMCAT_WEBAPPS/${APP_NAME}.war $BACKUP_DIR/${APP_NAME}-$(date +%Y%m%d_%H%M%S).war
    echo "기존 WAR 파일 백업 완료"
fi

# S3에서 최신 빌드 다운로드
aws s3 cp s3://$S3_BUCKET/falcon-shop-build --recursive /tmp/artifacts/

# WAR 파일 찾기 및 배포
WAR_FILE=$(find /tmp/artifacts -name "*.war" | head -1)
if [ -f "$WAR_FILE" ]; then
    sudo cp $WAR_FILE $TOMCAT_WEBAPPS/${APP_NAME}.war
    sudo chown tomcat:tomcat $TOMCAT_WEBAPPS/${APP_NAME}.war
    echo "새 WAR 파일 배포 완료: $WAR_FILE"
else
    echo "WAR 파일을 찾을 수 없습니다."
    exit 1
fi

# Tomcat 시작
sudo systemctl start tomcat

# 배포 확인 (최대 60초 대기)
echo "애플리케이션 배포 확인 중..."
for i in {1..12}; do
    HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/${APP_NAME}/)
    if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "302" ]; then
        echo "애플리케이션이 성공적으로 배포되었습니다!"
        echo "URL: http://13.134.116.196:8080/${APP_NAME}/"
        exit 0
    fi
    echo "대기 중... (${i}/12)"
    sleep 5
done

echo "애플리케이션 배포 확인 실패"
sudo systemctl status tomcat
exit 1
EOF

chmod +x /home/ec2-user/deploy-war.sh
exit
```

### Tomcat 포트 보안 그룹 설정
```bash
# 보안 그룹에 8080 포트 추가 (로컬에서 실행)
# 현재 인스턴스의 보안 그룹 ID 확인
SECURITY_GROUP_ID=$(aws ec2 describe-instances --instance-ids i-07340d027581e607b --query 'Reservations[0].Instances[0].SecurityGroups[0].GroupId' --output text)

# 8080 포트 인바운드 규칙 추가
aws ec2 authorize-security-group-ingress \
    --group-id $SECURITY_GROUP_ID \
    --protocol tcp \
    --port 8080 \
    --cidr 0.0.0.0/0

echo "보안 그룹에 8080 포트가 추가되었습니다."
```
```bash
# CodeDeploy 애플리케이션 생성
aws deploy create-application \
  --application-name falcon-shop-app \
  --compute-platform Server

# 배포 그룹 생성
aws deploy create-deployment-group \
  --application-name falcon-shop-app \
  --deployment-group-name falcon-production \
  --service-role-arn arn:aws:iam::$(aws sts get-caller-identity --query Account --output text):role/FalconCodeDeployRole \
  --ec2-tag-filters Key=Name,Value=falcon-shop-server,Type=KEY_AND_VALUE \
  --deployment-config-name CodeDeployDefault.AllAtOnce

echo "CodeDeploy application created: falcon-shop-app"
```

## 6-6. 배포 스크립트 생성
```bash
# shop/appspec.yml 생성
cat > shop/appspec.yml << 'EOF'
version: 0.0
os: linux
files:
  - source: /build/libs
    destination: /opt/falcon-shop
hooks:
  BeforeInstall:
    - location: scripts/stop_application.sh
      timeout: 300
      runas: ec2-user
  ApplicationStart:
    - location: scripts/start_application.sh
      timeout: 300
      runas: ec2-user
  ValidateService:
    - location: scripts/validate_service.sh
      timeout: 300
      runas: ec2-user
EOF

# shop/scripts/ 디렉토리 및 스크립트 생성
mkdir -p shop/scripts

# shop/scripts/stop_application.sh
cat > shop/scripts/stop_application.sh << 'EOF'
#!/bin/bash
PID=$(pgrep -f "falcon-shop")
if [ -n "$PID" ]; then
    echo "Stopping application with PID: $PID"
    kill -TERM $PID
    sleep 10
fi
EOF

# shop/scripts/start_application.sh
cat > shop/scripts/start_application.sh << 'EOF'
#!/bin/bash
cd /opt/falcon-shop
nohup java -jar -Dspring.profiles.active=production *.jar > application.log 2>&1 &
echo $! > app.pid
sleep 10
EOF

# shop/scripts/validate_service.sh
cat > shop/scripts/validate_service.sh << 'EOF'
#!/bin/bash
for i in {1..10}; do
    HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/actuator/health)
    if [ "$HTTP_STATUS" = "200" ]; then
        echo "Application is running successfully"
        exit 0
    fi
    echo "Waiting for application... (attempt $i/10)"
    sleep 10
done
echo "Application failed to start"
exit 1
EOF

chmod +x shop/scripts/*.sh
```

## 6-7. 한 번에 실행하는 스크립트
```bash
#!/bin/bash
# 전체 CI/CD 파이프라인 설정 스크립트

set -e
echo "🚀 FALCON Shop CI/CD 파이프라인 설정 시작..."

# 변수 설정
INSTANCE_ID="i-07340d027581e607b"  # 실제 EC2 인스턴스 ID로 변경
BUCKET_NAME="falcon-shop-pipeline-artifacts-$(date +%s)"
ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)

echo "📦 S3 버킷 생성: $BUCKET_NAME"
aws s3 mb s3://$BUCKET_NAME

echo "🏷️ EC2 인스턴스 태그 추가"
aws ec2 create-tags --resources $INSTANCE_ID --tags Key=Name,Value=falcon-shop-server Key=Environment,Value=production

echo "🔧 CodeBuild 프로젝트 생성"
aws codebuild create-project \
  --name falcon-shop-build \
  --description "FALCON Shop Build Project" \
  --source type=GITHUB,location=https://github.com/ALOHA-SOFT/FALCON.git \
  --artifacts type=S3,location=$BUCKET_NAME/build-output \
  --environment type=LINUX_CONTAINER,image=aws/codebuild/amazonlinux2-x86_64-standard:5.0,computeType=BUILD_GENERAL1_SMALL \
  --service-role arn:aws:iam::$ACCOUNT_ID:role/FalconCodeBuildRole

echo "🚀 CodeDeploy 애플리케이션 생성"
aws deploy create-application \
  --application-name falcon-shop-app \
  --compute-platform Server

aws deploy create-deployment-group \
  --application-name falcon-shop-app \
  --deployment-group-name falcon-production \
  --service-role-arn arn:aws:iam::$ACCOUNT_ID:role/FalconCodeDeployRole \
  --ec2-tag-filters Key=Name,Value=falcon-shop-server,Type=KEY_AND_VALUE \
  --deployment-config-name CodeDeployDefault.AllAtOnce

echo "✅ 설정 완료!"
echo "💡 이제 GitHub에 코드를 push하고 수동으로 빌드/배포를 테스트하세요"
echo ""
echo "📋 생성된 리소스:"
echo "   - S3 버킷: $BUCKET_NAME"
echo "   - CodeBuild 프로젝트: falcon-shop-build"
echo "   - CodeDeploy 앱: falcon-shop-app"
echo ""
echo "🧪 테스트 명령어:"
echo "   aws codebuild start-build --project-name falcon-shop-build"
```

## 6-8. 배포 테스트
```bash
# 빌드 테스트
echo "🧪 CodeBuild 테스트 시작..."
BUILD_ID=$(aws codebuild start-build --project-name falcon-shop-build --query 'build.id' --output text)
echo "Build ID: $BUILD_ID"

# 빌드 상태 확인
aws codebuild batch-get-builds --ids $BUILD_ID --query 'builds[0].buildStatus' --output text

# 빌드 로그 확인 (빌드 완료 후)
aws logs get-log-events --log-group-name /aws/codebuild/falcon-shop-build --log-stream-name $BUILD_ID

# 수동 배포 테스트 (빌드 완료 후)
aws deploy create-deployment \
  --application-name falcon-shop-app \
  --deployment-group-name falcon-production \
  --s3-location bucket=$BUCKET_NAME,key=build-output,bundleType=zip
```

## 6-8. 자동 배포 테스트
```bash
# 코드 변경 후 GitHub에 push
git add .
git commit -m "Test automatic deployment"
git push origin main

# 수동 빌드 트리거로 테스트
aws codebuild start-build --project-name falcon-shop-build

# 빌드 완료 후 배포 테스트
aws deploy create-deployment \
  --application-name falcon-shop-app \
  --deployment-group-name falcon-production \
  --s3-location bucket=$BUCKET_NAME,key=build-output,bundleType=zip
```

## 6-9. 배포 확인
```bash
# EC2 인스턴스에 접속하여 확인
ssh -i your-key.pem ec2-user@13.134.116.196

# 애플리케이션 로그 확인
tail -f /opt/falcon-shop/application.log

# 애플리케이션 상태 확인
curl http://localhost:8080/actuator/health

# CodeDeploy 에이전트 상태 확인
sudo service codedeploy-agent status
```

## 🎯 간단 실행 가이드
```bash
# 1. IAM 역할들 생성 (위의 6-2 명령어들 실행)
# 2. 한 번에 실행 스크립트 실행
# 3. GitHub에 appspec.yml과 scripts 폴더 추가
# 4. 빌드/배포 테스트
```

## 자동 배포 플로우
```
GitHub Push (main) 
    ↓
CodePipeline 트리거
    ↓
CodeBuild (shop/gradlew build)
    ↓ 
S3에 JAR 아티팩트 저장
    ↓
CodeDeploy가 EC2에 배포
    ↓
애플리케이션 자동 재시작
```

이제 main 브랜치에 코드를 push하면 자동으로 EC2에 배포됩니다! 🚀 

